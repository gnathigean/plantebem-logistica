<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Plantebem</title>
  
  <link rel="stylesheet" href="/menu.css">
  
  <style>
    /* ‚úÖ ESTILOS PADRONIZADOS PARA TODOS OS BOT√ïES ADMINISTRATIVOS */
    .btn-admin-cadastro, 
    .btn-admin-gerenciar, 
    .btn-manutencao, 
    .btn-deslogar-todos {
      display: block;
      padding: 15px 30px;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      margin-bottom: 15px;
      border: none;
      cursor: pointer;
      font-size: 1em;
      width: 100%;
      box-sizing: border-box;
    }
    
    .btn-admin-cadastro {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-admin-cadastro:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    
    .btn-admin-gerenciar {
      background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }
    
    .btn-admin-gerenciar:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(244, 67, 54, 0.5);
    }

    .btn-manutencao.ativado {
      background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }

    .btn-manutencao.desativado {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .btn-manutencao:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5);
    }

    .btn-deslogar-todos {
      background: linear-gradient(135deg, #ff5722 0%, #d32f2f 100%);
      box-shadow: 0 4px 15px rgba(255, 87, 34, 0.3);
    }

    .btn-deslogar-todos:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 87, 34, 0.5);
      background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
    }
    
    /* ‚úÖ ESTILO PARA BOT√ÉO DE ACESSAR LOJA */
    .btn-acessar-loja {
      display: block;
      padding: 20px 30px;
      margin-top: 20px;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1.2em;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
    }

    .btn-acessar-loja:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 25px rgba(46, 204, 113, 0.5);
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    }

    /* ‚úÖ IDENTIFICADOR DE USU√ÅRIO */
    .user-identifier {
      position: fixed;
      top: 70px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      z-index: 999;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .user-identifier.admin {
      background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      border: 2px solid rgba(255, 255, 255, 0.5);
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-weight: 700;
      font-size: 14px;
      line-height: 1.2;
    }

    .user-type {
      font-size: 11px;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ‚úÖ TELA DE MANUTEN√á√ÉO */
    .maintenance-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      text-align: center;
      padding: 20px;
    }

    .maintenance-screen.active {
      display: flex;
    }

    .maintenance-icon {
      font-size: 120px;
      margin-bottom: 30px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .maintenance-title {
      font-size: 3em;
      font-weight: 700;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .maintenance-message {
      font-size: 1.5em;
      max-width: 600px;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .maintenance-footer {
      font-size: 1em;
      opacity: 0.8;
    }

    /* Responsivo */
    @media (max-width: 768px) {
      .user-identifier {
        top: 60px;
        right: 10px;
        padding: 10px 15px;
        font-size: 12px;
      }

      .user-avatar {
        width: 35px;
        height: 35px;
        font-size: 18px;
      }

      .user-name {
        font-size: 13px;
      }

      .user-type {
        font-size: 10px;
      }

      .maintenance-icon {
        font-size: 80px;
      }

      .maintenance-title {
        font-size: 2em;
      }

      .maintenance-message {
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  
  <!-- ‚úÖ TELA DE MANUTEN√á√ÉO -->
  <div id="maintenance-screen" class="maintenance-screen">
    <div class="maintenance-icon">üîß</div>
    <h1 class="maintenance-title">Sistema em Manuten√ß√£o</h1>
    <p class="maintenance-message">
      Estamos realizando melhorias no sistema para proporcionar uma melhor experi√™ncia.<br>
      Por favor, tente novamente em alguns instantes.
    </p>
    <div class="maintenance-footer">
      Agradecemos pela compreens√£o! üíô
    </div>
  </div>

  <div class="fixed-nav">
    <a href="menu.html" class="botao-menu">Menu</a>
    <button id="logout-button">Sair</button>
  </div>

  <!-- ‚úÖ IDENTIFICADOR DE USU√ÅRIO -->
  <div id="user-identifier" class="user-identifier" style="display: none;">
    <div class="user-avatar" id="user-avatar">
      üë§
    </div>
    <div class="user-info">
      <div class="user-name" id="user-name">Carregando...</div>
      <div class="user-type" id="user-type">Usu√°rio</div>
    </div>
  </div>

  <div class="logo-container">
    <img src="https://contagem.plantebemtec.com.br/Logotipo%20com%20Simbolo%20padrao.png" alt="Logo da Empresa" class="logo-img">
  </div>

  <div class="menu-container">
    <div class="menu-header">Menu Principal</div>
    <ul class="menu-list">
      <li class="menu-list-item"><a href="menu.html">In√≠cio</a></li>
      <li class="menu-list-item"><a href="dashboard.html">DASHBOARD (KPls e Insights)</a></li>
      <li class="menu-list-item"><a href="mapa-estoque.html">MAPA ESTOQUE MATRIZ (EM PRODU√á√ÉO)</a></li>
       <li class="menu-list-item"><a href="dadosgeral.html">DADOS GERAIS DE RECEBIMENTO</a></li>
    </ul>
    
    <!-- ‚úÖ √ÅREA ADMINISTRATIVA - S√ì ADMIN V√ä -->
    <div id="admin-section" style="display: none; margin-top: 30px;">
      <div class="loja-selecao-container">
        <label style="color: #667eea; font-weight: bold; display: block; margin-bottom: 15px;">‚öôÔ∏è √Årea Administrativa:</label>
        
        <a href="cadastro.html" class="btn-admin-cadastro">
          üë• Cadastrar Novo Usu√°rio
        </a>
        
        <a href="gerenciar-usuarios.html" class="btn-admin-gerenciar">
          üóëÔ∏è Gerenciar Usu√°rios
        </a>

        <button id="btn-manutencao" class="btn-manutencao desativado">
          ‚è≥ Verificando modo manuten√ß√£o...
        </button>

        <button id="btn-deslogar-todos" class="btn-deslogar-todos">
          üö™ Deslogar Todos os Usu√°rios
        </button>
      </div>
    </div>

    <div class="loja-selecao-container">
      <label for="seletor-loja" id="loja-label">Recebimento de Mercadorias:</label>
      <select id="seletor-loja">
        <option value="" data-url="null">-- Selecione uma Loja --</option>
        <option value="Matriz" data-loja-key="matriz" data-url="recebimento_petrolina.html">Matriz</option>
        <option value="Juazeiro" data-loja-key="juazeiro" data-url="recebimento_juazeiro.html">Filial Juazeiro</option>
        <option value="Loteamento" data-loja-key="loteamento" data-url="recebimento_loteamento.html">Filial Loteamento</option>
        <option value="Irece" data-loja-key="irece" data-url="recebimento_irece.html">Filial Irec√™</option>
        <option value="Rio Real" data-loja-key="rioreal" data-url="recebimento_rioreal.html">Filial Rio Real</option>
        <option value="Agroexpress" data-loja-key="agroexpress" data-url="recebimento_agroexpress.html">Agroexpress</option>
        <option value="Grande Safra" data-loja-key="grandesafra" data-url="recebimento_grandesafra.html">Grande Safra</option>
      </select>
    </div>

    <div id="botao-loja-container"></div>
  </div>
  
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
  import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
  
  const firebaseConfig = {
    apiKey: "AIzaSyD8GjaS3tuDpSvBl2-bpa-QXIKTqq80Mn4",
    authDomain: "login-com-dados.firebaseapp.com",
    projectId: "login-com-dados",
    storageBucket: "login-com-dados.firebasestorage.app",
    messagingSenderId: "7.5556023458e+10",
    appId: "1:7.5556023458e+10:web:9f1362d0597603c0f37bfb",
    measurementId: "G-W9LRT99579"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  const ADMIN_UID = "O02XwNu2KSNCCk0xCvdBE2YxW9G2";
  
  const logoutButton = document.getElementById('logout-button');
  const userIdentifier = document.getElementById('user-identifier');
  const userAvatar = document.getElementById('user-avatar');
  const userName = document.getElementById('user-name');
  const userType = document.getElementById('user-type');
  const btnDeslogarTodos = document.getElementById('btn-deslogar-todos');
  const btnManutencao = document.getElementById('btn-manutencao');
  const maintenanceScreen = document.getElementById('maintenance-screen');

  // ========================================
  // FUNCIONALIDADE: BOT√ÉO DE ACESSO √Ä LOJA
  // ========================================

  const seletorLoja = document.getElementById('seletor-loja');
  const botaoLojaContainer = document.getElementById('botao-loja-container');

  // ‚úÖ Fun√ß√£o para criar o bot√£o de acesso
  function criarBotaoAcesso() {
    if (!seletorLoja || !botaoLojaContainer) return;
    
    const selectedOption = seletorLoja.options[seletorLoja.selectedIndex];
    const url = selectedOption.getAttribute('data-url');
    const lojaName = selectedOption.value;
    
    // Limpa o container
    botaoLojaContainer.innerHTML = '';
    
    // Se selecionou uma loja v√°lida, cria o bot√£o
    if (url && url !== 'null' && lojaName) {
      const botao = document.createElement('a');
      botao.href = url;
      botao.className = 'btn-acessar-loja';
      botao.textContent = `üì¶ Acessar ${lojaName}`;
      botaoLojaContainer.appendChild(botao);
    }
  }

  // Evento de mudan√ßa no seletor
  if (seletorLoja) {
    seletorLoja.addEventListener('change', criarBotaoAcesso);
  }

  // ========================================
  // FUN√á√ÉO: VERIFICAR MODO MANUTEN√á√ÉO
  // ========================================

  async function verificarModoManutencao(isAdmin) {
    try {
      const configDoc = await getDoc(doc(db, "config", "sistema"));
      
      if (configDoc.exists()) {
        const config = configDoc.data();
        const modoManutencao = config.modoManutencao || false;
        
        if (!isAdmin && modoManutencao) {
          maintenanceScreen.classList.add('active');
          return true;
        }
        
        if (isAdmin && btnManutencao) {
          atualizarBotaoManutencao(modoManutencao);
        }
      } else if (isAdmin) {
        await setDoc(doc(db, "config", "sistema"), {
          modoManutencao: false,
          ultimaAtualizacao: new Date().toISOString()
        });
        atualizarBotaoManutencao(false);
      }
      
      return false;
      
    } catch (error) {
      console.error('Erro ao verificar modo manuten√ß√£o:', error);
      return false;
    }
  }

  // ========================================
  // FUN√á√ÉO: ATUALIZAR BOT√ÉO DE MANUTEN√á√ÉO
  // ========================================

  function atualizarBotaoManutencao(modoAtivo) {
    if (!btnManutencao) return;
    
    if (modoAtivo) {
      btnManutencao.classList.remove('desativado');
      btnManutencao.classList.add('ativado');
      btnManutencao.textContent = 'üîì Desativar Modo Manuten√ß√£o';
    } else {
      btnManutencao.classList.remove('ativado');
      btnManutencao.classList.add('desativado');
      btnManutencao.textContent = 'üîí Ativar Modo Manuten√ß√£o';
    }
  }

  // ========================================
  // FUN√á√ÉO: ALTERNAR MODO MANUTEN√á√ÉO
  // ========================================

  if (btnManutencao) {
    btnManutencao.addEventListener('click', async function() {
      try {
        const configDoc = await getDoc(doc(db, "config", "sistema"));
        const modoAtual = configDoc.exists() ? (configDoc.data().modoManutencao || false) : false;
        const novoModo = !modoAtual;
        
        const mensagem = novoModo 
          ? '‚ö†Ô∏è ATEN√á√ÉO: Ao ativar o modo manuten√ß√£o, todos os usu√°rios comuns ser√£o bloqueados e n√£o conseguir√£o acessar o sistema.\n\nApenas administradores ter√£o acesso.\n\nDeseja continuar?'
          : '‚úÖ Deseja liberar o acesso ao sistema para todos os usu√°rios?';
        
        const confirmacao = confirm(mensagem);
        
        if (!confirmacao) return;
        
        btnManutencao.disabled = true;
        btnManutencao.textContent = '‚è≥ Processando...';
        
        await setDoc(doc(db, "config", "sistema"), {
          modoManutencao: novoModo,
          ultimaAtualizacao: new Date().toISOString(),
          atualizadoPor: auth.currentUser.email
        });
        
        atualizarBotaoManutencao(novoModo);
        
        const statusMsg = novoModo 
          ? 'üîí Modo Manuten√ß√£o ATIVADO!\n\nUsu√°rios comuns n√£o conseguir√£o acessar o sistema.'
          : 'üîì Modo Manuten√ß√£o DESATIVADO!\n\nTodos os usu√°rios podem acessar normalmente.';
        
        alert(statusMsg);
        
        btnManutencao.disabled = false;
        
      } catch (error) {
        console.error('Erro ao alternar modo manuten√ß√£o:', error);
        alert('‚ùå Erro ao alterar modo manuten√ß√£o: ' + error.message);
        btnManutencao.disabled = false;
      }
    });
  }

  // ========================================
  // FUN√á√ÉO: DESLOGAR TODOS OS USU√ÅRIOS
  // ========================================
  
  if (btnDeslogarTodos) {
    btnDeslogarTodos.addEventListener('click', async function() {
      const confirmacao = confirm(
        '‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° deslogar TODOS os usu√°rios do sistema!\n\n' +
        'Isso inclui voc√™ e todos os outros usu√°rios conectados.\n\n' +
        'Todos precisar√£o fazer login novamente.\n\n' +
        'Deseja continuar?'
      );

      if (!confirmacao) return;

      const confirmacaoFinal = prompt(
        'Digite "DESLOGAR TODOS" para confirmar esta a√ß√£o:'
      );

      if (confirmacaoFinal !== 'DESLOGAR TODOS') {
        alert('‚ùå A√ß√£o cancelada.');
        return;
      }

      btnDeslogarTodos.disabled = true;
      btnDeslogarTodos.textContent = '‚è≥ Processando...';

      try {
        const usuariosSnapshot = await getDocs(collection(db, "usuarios"));
        const timestamp = new Date().toISOString();
        
        const promises = [];
        
        usuariosSnapshot.forEach((userDoc) => {
          promises.push(
            updateDoc(doc(db, "usuarios", userDoc.id), {
              forceLogout: true,
              forceLogoutTimestamp: timestamp
            })
          );
        });

        await Promise.all(promises);

        alert('‚úÖ Todos os usu√°rios foram deslogados com sucesso!\n\nVoc√™ tamb√©m ser√° deslogado agora.');
        
        await signOut(auth);
        window.location.href = 'index.html';

      } catch (error) {
        console.error('Erro ao deslogar todos:', error);
        alert('‚ùå Erro ao deslogar usu√°rios: ' + error.message);
        btnDeslogarTodos.disabled = false;
        btnDeslogarTodos.textContent = 'üö™ Deslogar Todos os Usu√°rios';
      }
    });
  }

  // ========================================
  // FUN√á√ÉO: LOGOUT INDIVIDUAL
  // ========================================
  
  if (logoutButton) {
    logoutButton.addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = 'index.html';
      }).catch((error) => {
        console.error("Erro ao deslogar:", error);
        alert("Erro ao sair. Tente novamente.");
      });
    });
  }

  // ========================================
  // FUN√á√ÉO: ATUALIZAR IDENTIFICADOR DE USU√ÅRIO
  // ========================================
  
  function atualizarIdentificadorUsuario(nome, email, isAdmin) {
    const nomeExibicao = nome || email.split('@')[0] || 'Usu√°rio';
    
    userName.textContent = nomeExibicao;
    
    if (isAdmin) {
      userType.textContent = 'üîë Administrador';
      userIdentifier.classList.add('admin');
      userAvatar.textContent = 'üîë';
    } else {
      userType.textContent = 'üë§ Usu√°rio';
      userIdentifier.classList.remove('admin');
      userAvatar.textContent = 'üë§';
    }
    
    userIdentifier.style.display = 'flex';
  }
  
  // ========================================
  // AUTENTICA√á√ÉO E CONTROLE DE ACESSO
  // ========================================
  
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }
    
    if (logoutButton) {
      logoutButton.style.display = 'inline-block';
    }
    
    let isAdmin = (user.uid === ADMIN_UID);
    let userData = null;
    
    try {
      const userDoc = await getDoc(doc(db, "usuarios", user.uid));
      
      if (userDoc.exists()) {
        userData = userDoc.data();
        
        if (userData.forceLogout === true) {
          alert('‚ö†Ô∏è Sua sess√£o foi encerrada pelo administrador.\n\nPor favor, fa√ßa login novamente.');
          
          await updateDoc(doc(db, "usuarios", user.uid), {
            forceLogout: false
          });
          
          await signOut(auth);
          window.location.href = 'index.html';
          return;
        }
        
        if (userData.isAdmin === true || userData.tipo === 'admin') {
          isAdmin = true;
        }

        const emManutencao = await verificarModoManutencao(isAdmin);
        
        if (emManutencao) {
          return;
        }

        atualizarIdentificadorUsuario(userData.nome, user.email, isAdmin);
        
        if (isAdmin) {
          const adminSection = document.getElementById('admin-section');
          if (adminSection) {
            adminSection.style.display = 'block';
          }
          console.log('‚úÖ Admin logado - acesso total');
          return;
        }
        
        const lojasPermitidas = userData.lojasPermitidas || [];
        
        if (lojasPermitidas.length === 0) {
          alert('‚ùå Voc√™ n√£o tem permiss√£o para acessar nenhuma loja.\n\nEntre em contato com o administrador.');
          signOut(auth).then(() => window.location.href = 'index.html');
          return;
        }
        
        const seletorLoja = document.getElementById('seletor-loja');
        
        if (seletorLoja) {
          const options = Array.from(seletorLoja.querySelectorAll('option'));
          let opcoesRemovidas = 0;
          
          options.forEach(option => {
            const lojaKey = option.getAttribute('data-loja-key');
            
            if (lojaKey && !lojasPermitidas.includes(lojaKey)) {
              option.remove();
              opcoesRemovidas++;
            }
          });
          
          console.log(`‚úÖ Filtro aplicado para ${userData.nome || user.email}`);
          console.log(`üìã Lojas permitidas:`, lojasPermitidas.map(l => l.toUpperCase()).join(', '));
          console.log(`üö´ Op√ß√µes removidas: ${opcoesRemovidas}`);
          
          const opcoesRestantes = seletorLoja.querySelectorAll('option[data-loja-key]');
          if (opcoesRestantes.length === 1) {
            seletorLoja.value = opcoesRestantes[0].value;
            console.log(`üéØ Sele√ß√£o autom√°tica: ${opcoesRestantes[0].textContent}`);
            
            // ‚úÖ CRIAR BOT√ÉO AUTOMATICAMENTE AP√ìS SELE√á√ÉO
            criarBotaoAcesso();
          }
        }
        
      } else {
        atualizarIdentificadorUsuario(null, user.email, isAdmin);
        
        console.warn('‚ö†Ô∏è Usu√°rio sem permiss√µes cadastradas no Firestore');
        
        if (isAdmin) {
          await verificarModoManutencao(isAdmin);
          const adminSection = document.getElementById('admin-section');
          if (adminSection) {
            adminSection.style.display = 'block';
          }
        }
      }
      
    } catch (error) {
      console.error('‚ùå Erro ao buscar permiss√µes:', error);
      alert('Erro ao carregar permiss√µes. Entre em contato com o administrador.');
    }
  });
  
</script>
</body>
</html>
