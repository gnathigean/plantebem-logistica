<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Plantebem</title>
  
  <link rel="stylesheet" href="/menu.css"> 
</head>
<body>
  
  <div class="fixed-nav">
    <a href="menu.html" class="botao-menu">Menu</a>
    <button id="logout-button">Sair</button>
  </div>

  <div class="logo-container">
    <img src="https://contagem.plantebemtec.com.br/Logotipo%20com%20Simbolo%20padrao.png" alt="Logo da Empresa" class="logo-img">
  </div>

  <div class="menu-container">
    <div class="menu-header">Menu Principal</div>
    <ul class="menu-list">
      <li class="menu-list-item"><a href="menu.html">In√≠cio</a></li>
      <li class="menu-list-item"><a href="menu.html">Cat√°logo (EM PRODU√á√ÉO)</a></li>
      <li class="menu-list-item"><a href="menu.html">Mapa de Produtos (EM PRODU√á√ÉO)</a></li>
      <li class="menu-list-item"><a href="dashboard.html">DASHBOARD (KPls e Insights)</a></li>
      
      
      <li class="menu-list-item" id="admin-cadastro-link" style="display: none;">
        <a href="/cadastro.html">CADASTRAR USUARIOS</a>
      </li>
    </ul>

    <div class="loja-selecao-container">
            <label for="seletor-loja" id="loja-label">Recebimento de Mercadorias:</label>
      <select id="seletor-loja">
        <option value="" data-url="null">-- Selecione uma Loja --</option>
                <option value="Matriz" data-loja-key="matriz" data-url="recebimento_petrolina.html">Matriz</option>
        <option value="Juazeiro" data-loja-key="juazeiro" data-url="recebimento_juazeiro.html">Filial Juazeiro</option>
        <option value="Loteamento" data-loja-key="loteamento" data-url="recebimento_loteamento.html">Filial Loteamento</option>
        <option value="Irece" data-loja-key="irece" data-url="recebimento_irece.html">Filial Irec√™</option>
        <option value="Rio Real" data-loja-key="rioreal" data-url="recebimento_rioreal.html">Filial Rio Real</option>
        <option value="Agroexpress" data-loja-key="agroexpress" data-url="recebimento_agroexpress.html">Agroexpress</option>
        <option value="Grande Safra" data-loja-key="grandesafra" data-url="recebimento_grandesafra.html">Grande Safra</option>
      </select>
    </div>

    <div id="botao-loja-container"></div>
  </div>
  
  <script type="module">
    // Importa as fun√ß√µes modulares necess√°rias do Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    
    // ‚ö†Ô∏è 1. COLOQUE SUAS CONFIGURA√á√ïES FIREBASE AQUI ‚ö†Ô∏è
    const firebaseConfig = {
      apiKey: "AIzaSyD8GjaS3tuDpSvBl2-bpa-QXIKTqq80Mn4",
      authDomain: "login-com-dados.firebaseapp.com",
      projectId: "login-com-dados",
      storageBucket: "login-com-dados.firebasestorage.app",
      messagingSenderId: "75556023458",
      appId: "1:75556023458:web:9f1362d0597603c0f37bfb",
      measurementId: "G-W9LRT99579"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // üö® 2. COLOQUE SEU UID PESSOAL AQUI üö®
    const ADMIN_UID = "O02XwNu2KSNCCk0xCvdBE2YxW9G2"; 
    
    const logoutButton = document.getElementById("logout-button");
    const adminCadastroLink = document.getElementById("admin-cadastro-link");
    const seletorLoja = document.getElementById('seletor-loja');

    // ====================================================================
    // üîë MAPA DE PERMISS√ïES: CONFIGURA√á√ÉO DE ACESSO POR USU√ÅRIO (UID) üîë
    // ====================================================================
    const PERMISSOES_LOJAS = {
        // Admin (Acesso total)
        [ADMIN_UID]: ['matriz', 'juazeiro', 'loteamento', 'irece', 'rioreal', 'agroexpress', 'grandesafra'],
        
        // ** GARANTIR QUE SEU UID DE TESTE ESTEJA AQUI **
        "6hpiqSundWaDGQqCdz2peiwc0yF2": ['matriz'],
        "fP0uxFF1BhVjU91wLBuqjXZgto53": ['juazeiro'],
        "": ['loteamento'],
        "": ['irece'],
        "": ['rioreal'],
        "": ['agroexpress'],
        "": ['grandesafra'],
    };


    // --- FUN√á√ÉO CORRIGIDA: FILTRA AS OP√á√ïES DO SELECT ---
    function filtrarLojasPorUsuario(user) {
        const permissoesDoUsuario = PERMISSOES_LOJAS[user.uid] || [];
        const todasOpcoes = seletorLoja.querySelectorAll('option');
        
        const opcaoPadrao = seletorLoja.querySelector('option[data-url="null"]');
        let lojasVisiveisCount = 0;
        let primeiraLojaVisivel = null;
        let lojasParaRemover = [];

        // PRIMEIRO LOOP: Identifica as op√ß√µes a serem mantidas e as a serem removidas
        todasOpcoes.forEach(opcao => {
            const chaveLoja = opcao.getAttribute('data-loja-key');
            
            if (!chaveLoja) return; // Mant√©m a op√ß√£o padr√£o fora desta contagem

            // Verifica se o usu√°rio tem permiss√£o
            if (permissoesDoUsuario.includes(chaveLoja) || user.uid === ADMIN_UID) {
                lojasVisiveisCount++;
                if (!primeiraLojaVisivel) {
                    primeiraLojaVisivel = opcao;
                }
            } else {
                lojasParaRemover.push(opcao);
            }
        });
        
        // SEGUNDO LOOP: Remove as op√ß√µes ap√≥s a contagem, para n√£o atrapalhar o NodeList
        lojasParaRemover.forEach(opcao => opcao.remove());


        // L√ìGICA DE INTERFACE
        const lojaLabel = document.getElementById('loja-label');
        const containerBotao = document.getElementById('botao-loja-container');

        if (lojasVisiveisCount === 0) {
            // Se o usu√°rio n√£o tiver permiss√£o para NENHUMA loja
            lojaLabel.textContent = "Acesso Restrito: Nenhuma loja dispon√≠vel.";
            seletorLoja.style.display = 'none';
            containerBotao.innerHTML = '';
        } else if (lojasVisiveisCount === 1 && primeiraLojaVisivel) {
            // Se restar apenas UMA loja: Seleciona automaticamente e esconde o select
            seletorLoja.value = primeiraLojaVisivel.value;
            lojaLabel.textContent = `Local de Recebimento: ${primeiraLojaVisivel.textContent}`;
            
            if (opcaoPadrao) opcaoPadrao.remove();
            
            exibirBotaoDaLoja();
            seletorLoja.style.display = 'none';
        } else {
            // Se houver M√öLTIPLAS lojas: Mostra o seletor normalmente
            lojaLabel.textContent = "Recebimento de Mercadorias:";
            seletorLoja.style.display = 'block';
            
            // Garante que a op√ß√£o padr√£o esteja selecionada inicialmente se n√£o houver sele√ß√£o
            if (opcaoPadrao) seletorLoja.value = "";
            
            containerBotao.innerHTML = ''; // Remove o bot√£o at√© que uma op√ß√£o seja escolhida
        }
    }


    // --- L√ìGICA DE AUTENTICA√á√ÉO E CONTROLE DE VISIBILIDADE ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        logoutButton.style.display = 'inline-block';
        filtrarLojasPorUsuario(user); // CHAMA A FUN√á√ÉO CORRIGIDA
        
        // Verifica o UID do usu√°rio para o link de cadastro
        if (user.uid === ADMIN_UID) {
          adminCadastroLink.style.display = 'block'; 
        } else {
          adminCadastroLink.style.display = 'none';
        }
      } else {
        window.location.href = 'index.html'; 
      }
    });
    
    // FUNCIONALIDADE DO BOT√ÉO DE SAIR (MANTIDA)
    logoutButton.addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = 'index.html';
      }).catch((error) => {
        console.error("Erro ao deslogar:", error);
      });
    });

    // --- L√ìGICA DO SELETOR DE LOJA (MANTIDA) ---
    function exibirBotaoDaLoja() {
      const container = document.getElementById('botao-loja-container');
      
      container.innerHTML = ''; 
      const valorSelecionado = seletorLoja.value;

      if (valorSelecionado) {
        const opcaoSelecionada = seletorLoja.options[seletorLoja.selectedIndex];
        const urlBase = opcaoSelecionada.getAttribute('data-url');
        const nomeDaLoja = opcaoSelecionada.textContent;

        const urlFinal = `${urlBase}?loja=${valorSelecionado}`;

        const botao = document.createElement('a');
        botao.setAttribute('href', urlFinal);
        botao.setAttribute('class', 'btn-loja botao-site');
        botao.style.display = 'inline-block'; 
        botao.textContent = `Acessar Recebimento (${nomeDaLoja})`;
        container.appendChild(botao);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      seletorLoja.addEventListener('change', exibirBotaoDaLoja); 
    });

  </script>
</body>
</html>