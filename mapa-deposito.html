<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gest√£o de Dep√≥sito - Plantebem</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; height: 100vh; overflow: hidden; }
    
    /* LAYOUT PRINCIPAL */
    .layout-container { display: flex; height: 100vh; }
    
    /* SIDEBAR LATERAL */
    .sidebar { width: 260px; background: linear-gradient(180deg, #088804 0%, #6ce874 100%); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1); overflow-y: auto; }
    .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .sidebar-logo { display: flex; align-items: center; gap: 12px; }
    .sidebar-logo-icon { font-size: 2em; }
    .sidebar-logo-text h2 { font-size: 1.2em; font-weight: 700; }
    .sidebar-logo-text p { font-size: 0.8em; opacity: 0.9; margin-top: 2px; }
    
    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-section { margin-bottom: 30px; }
    .menu-section-title { padding: 0 20px 10px 20px; font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; font-weight: 600; }
    .menu-item { padding: 12px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s ease; color: white; text-decoration: none; border-left: 3px solid transparent; }
    .menu-item:hover { background: rgba(255, 255, 255, 0.1); border-left-color: white; }
    .menu-item.active { background: rgba(255, 255, 255, 0.15); border-left-color: white; font-weight: 600; }
    .menu-item-icon { font-size: 1.2em; min-width: 24px; text-align: center; }
    .menu-item-text { flex: 1; font-size: 0.95em; }
    
    /* CONTE√öDO PRINCIPAL */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    
    /* HEADER SUPERIOR */
    .top-header { background: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
    .top-header-left { display: flex; align-items: center; gap: 20px; }
    .page-title { font-size: 1.8em; font-weight: 700; color: #333; }
    .top-header-actions { display: flex; gap: 10px; }
    .btn-header { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
    .btn-export { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; }
    .btn-export:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4); }
    .btn-search {text-decoration: none;  background: #2196f3; color: white; }
    .btn-search:hover { background: #1976d2; }
    .btn-add {text-decoration: none;  background: #2ecc71; color: white; }
    .btn-add:hover { background: #27ae60; }
    .btn-menu {text-decoration: none;  background: #667eea; color: white; }
    .btn-menu:hover { background: #5568d3; }
    .btn-logout { background: #f44336; color: white; }
    .btn-logout:hover { background: #d32f2f; }
    
    /* √ÅREA DE BUSCA */
    .search-bar { background: white; padding: 20px 30px; border-bottom: 1px solid #e0e0e0; }
    .search-wrapper { display: flex; gap: 15px; align-items: center; }
    .search-input { flex: 1; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: all 0.3s ease; }
    .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    .search-btn { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
    .search-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    .clear-search { padding: 12px 24px; background: #f44336; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; display: none; }
    .clear-search:hover { background: #d32f2f; }
    .search-results { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none; max-height: 200px; overflow-y: auto; }
    .search-result-item { padding: 10px 15px; background: white; margin-bottom: 10px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid #667eea; }
    .search-result-item:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    
    /* ESTAT√çSTICAS */
    .stats-bar { background: white; padding: 20px 30px; border-bottom: 1px solid #e0e0e0; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
    .stat-card { background: linear-gradient(180deg, #088804 0%, #6ce874 100%); padding: 15px; border-radius: 10px; color: white; text-align: center; }
    .stat-label { font-size: 0.75em; opacity: 0.9; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 1.8em; font-weight: 700; }
    
    /* √ÅREA DO MAPA */
    .map-container { flex: 1; overflow-y: auto; background: #f5f7fa; padding: 30px; }
    .map-tabs { background: white; border-radius: 12px 12px 0 0; display: flex; border-bottom: 2px solid #e0e0e0; overflow-x: auto; }
    .tab-button { flex: 1; min-width: 140px; padding: 18px 25px; border: none; background: transparent; font-size: 1em; font-weight: 700; color: #666; cursor: pointer; transition: all 0.3s ease; position: relative; white-space: nowrap; }
    .tab-button:hover { background: rgba(102, 126, 234, 0.05); color: #667eea; }
    .tab-button.active { color: #667eea; background: white; }
    .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .tab-badge { display: inline-block; background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; margin-left: 6px; }
    .tab-button.active .tab-badge { background: #764ba2; }
    
    .map-content { background: white; border-radius: 0 0 12px 12px; padding: 30px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .filters-bar { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
    .filter-group { display: flex; align-items: center; gap: 10px; }
    .filter-label { font-weight: 600; color: #555; font-size: 0.9em; }
    .filter-select { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9em; background: white; cursor: pointer; }
    .filter-select:focus { outline: none; border-color: #667eea; }
    
    .warehouse-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 15px; }
    .vao-card { background: #f8f9fa; border-radius: 10px; padding: 15px; border: 2px solid #e0e0e0; transition: all 0.3s ease; }
    .vao-card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .vao-card.highlight { border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); } 50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.9); } }
    .vao-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: 700; font-size: 0.95em; margin-bottom: 12px; }
    .niveis-container { display: flex; flex-direction: column; gap: 8px; }
    
    .nivel-row { display: flex; gap: 6px; align-items: center; }
    .nivel-label { font-size: 0.7em; font-weight: 700; color: #999; min-width: 22px; }
    .pallets-row { display: flex; gap: 6px; flex: 1; }
    .pallet-slot { background: white; border: 2px solid #e0e0e0; border-radius: 6px; padding: 8px; min-height: 55px; cursor: pointer; transition: all 0.3s ease; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .pallet-slot:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); border-color: #667eea; }
    .pallet-slot.occupied { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-color: #4caf50; }
    .pallet-slot.warning { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-color: #ff9800; }
    .pallet-slot.danger { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-color: #f44336; }
    .pallet-slot.empty { background: #f5f5f5; border-style: dashed; opacity: 0.6; }
    .pallet-slot.highlight { border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { border-color: #ffd700; } 50% { border-color: #ffed4e; } }
    .pallet-number { font-size: 0.65em; color: #999; font-weight: 600; margin-bottom: 3px; }
    .pallet-count { font-size: 1.1em; font-weight: 700; color: #667eea; }
    .pallet-icon { font-size: 1.3em; margin-bottom: 3px; }
    
    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 15px; max-width: 900px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); }
    .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px 30px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 1.8em; margin: 0; }
    .modal-close { background: none; border: none; color: white; font-size: 2em; cursor: pointer; transition: transform 0.3s ease; line-height: 1; }
    .modal-close:hover { transform: scale(1.2); }
    .modal-body { padding: 30px; }
    .location-badge { display: inline-block; background: #e8eaf6; color: #667eea; padding: 10px 20px; border-radius: 20px; font-weight: 700; margin-bottom: 20px; font-size: 1.1em; }
    .products-list h3 { font-size: 1.3em; color: #333; margin: 20px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }
    .product-item { background: #f8f9fa; padding: 20px; margin-bottom: 15px; border-radius: 10px; border-left: 4px solid #667eea; }
    .product-item.warning { border-left-color: #ff9800; background: #fff3e0; }
    .product-item.danger { border-left-color: #f44336; background: #ffebee; }
    .product-name { font-weight: 700; color: #333; font-size: 1.1em; margin-bottom: 10px; }
    .product-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
    .product-detail { font-size: 0.9em; }
    .detail-label { color: #666; font-weight: 600; }
    .detail-value { color: #333; }
    .product-actions { display: flex; gap: 10px; margin-top: 15px; }
    .btn-small { padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; }
    .btn-move { background: #2196f3; color: white; }
    .btn-move:hover { background: #1976d2; }
    .btn-remove { background: #f44336; color: white; }
    .btn-remove:hover { background: #d32f2f; }
    .modal-footer { padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; border-radius: 0 0 15px 15px; }
    .btn-add-product { background: #2ecc71; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-add-product:hover { background: #27ae60; }
    
    /* MODAL MOVER */
    .modal-move { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1001; align-items: center; justify-content: center; padding: 20px; }
    .modal-move.active { display: flex; }
    .modal-move-content { background: white; border-radius: 15px; max-width: 600px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); }
    .modal-move-header { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 25px 30px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .modal-move-header h2 { font-size: 1.8em; margin: 0; }
    .modal-move-body { padding: 30px; }
    .move-form-group { margin-bottom: 20px; }
    .move-form-group label { display: block; font-weight: 600; color: #555; margin-bottom: 8px; font-size: 0.95em; }
    .move-form-group select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: all 0.3s ease; background: white; }
    .move-form-group select:focus { outline: none; border-color: #2196f3; box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1); }
    .btn-move-confirm { width: 100%; padding: 15px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; }
    .btn-move-confirm:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4); }
    .current-location { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3; }
    .current-location-title { font-weight: 700; color: #333; margin-bottom: 5px; }
    .current-location-value { color: #666; font-size: 1.1em; }
    
    /* LOADING */
    .loading { text-align: center; padding: 60px 20px; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* DASHBOARD E AN√ÅLISE */
    .produto-rank-item { display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #667eea; }
    .rank-number { font-size: 1.5em; font-weight: 700; color: #667eea; min-width: 40px; }
    .rank-info { flex: 1; }
    .rank-nome { font-weight: 700; color: #333; margin-bottom: 5px; }
    .rank-detalhes { font-size: 0.85em; color: #666; }
    .rank-count { font-size: 1.3em; font-weight: 700; color: #2ecc71; }
    
    /* TIMELINE HIST√ìRICO */
    .timeline { position: relative; padding: 20px 0; }
    .timeline::before { content: ''; position: absolute; left: 30px; top: 0; bottom: 0; width: 3px; background: #e0e0e0; }
    .timeline-item { position: relative; padding: 20px 20px 20px 60px; margin-bottom: 20px; }
    .timeline-icon { position: absolute; left: 18px; top: 20px; width: 28px; height: 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9em; font-weight: 700; z-index: 1; }
    .timeline-content { background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea; }
    .timeline-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
    .timeline-title { font-weight: 700; color: #333; font-size: 1.1em; }
    .timeline-date { font-size: 0.85em; color: #999; }
    .timeline-description { color: #666; line-height: 1.6; }
    
    /* EXPORT MENU */
    .export-menu { position: relative; display: inline-block; }
    .export-dropdown { display: none; position: absolute; top: 100%; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); margin-top: 10px; min-width: 200px; z-index: 1000; }
    .export-dropdown.active { display: block; }
    .export-option { padding: 12px 20px; cursor: pointer; transition: all 0.3s ease; border-bottom: 1px solid #f0f0f0; }
    .export-option:hover { background: #f8f9fa; }
    .export-option:last-child { border-bottom: none; }
    
    /* MODO TABELA */
    .table-view { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; background: white; }
    .data-table th { background: linear-gradient(135deg, #088804 0%, #088804 100%); color: white; padding: 15px; text-align: left; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
    .data-table td { padding: 15px; border-bottom: 1px solid #e0e0e0; font-size: 0.95em; }
    .data-table tbody tr:hover { background: #f8f9fa; }
    .data-table tbody tr:last-child td { border-bottom: none; }
    .status-badge { padding: 5px 12px; border-radius: 15px; font-size: 0.8em; font-weight: 600; display: inline-block; }
    .status-badge.ok { background: #e8f5e9; color: #2e7d32; }
    .status-badge.warning { background: #fff3e0; color: #e65100; }
    .status-badge.danger { background: #ffebee; color: #c62828; }
    
    /* RESPONSIVE */
    @media (max-width: 1024px) { 
      .sidebar { width: 220px; }
      .warehouse-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    }
    
    @media (max-width: 768px) { 
      .layout-container { flex-direction: column; }
      .sidebar { width: 100%; height: auto; max-height: 200px; }
      .top-header { flex-direction: column; gap: 15px; }
      .top-header-actions { width: 100%; justify-content: space-between; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .search-wrapper { flex-direction: column; }
    }
    /* NOVO ESTILO PARA O SELETOR DE P√ÅGINAS */
.warehouse-selector {
    padding: 10px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 0.9em;
    font-weight: 600;
    background: white;
    color: #333;
    cursor: pointer;
    transition: all 0.3s ease;
    height: 44px; /* Garante alinhamento com os bot√µes */
}
.warehouse-selector:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
/* E ajustei a propriedade align-items no .top-header-actions para alinhar: */
.top-header-actions { display: flex; gap: 10px; align-items: center; }
  </style>
</head>
<body>
  <div class="layout-container">
    <!-- SIDEBAR LATERAL -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">üè≠</div>
          <div class="sidebar-logo-text">
            <h2>Plantebem</h2>
            <p>Sistema de Dep√≥sito</p>
          </div>
        </div>
      </div>
      
      <div class="sidebar-menu">
        <div class="menu-section">
          <div class="menu-section-title">üìä Vis√£o Geral</div>
          <div class="menu-item active" onclick="mostrarConteudo('mapa')">
            <div class="menu-item-icon">üó∫Ô∏è</div>
            <div class="menu-item-text">Mapa do Dep√≥sito</div>
          </div>
          <div class="menu-item" onclick="abrirDashboard()">
            <div class="menu-item-icon">üìà</div>
            <div class="menu-item-text">Dashboard</div>
          </div>
          <div class="menu-item" onclick="mostrarConteudo('lista')">
            <div class="menu-item-icon">üìã</div>
            <div class="menu-item-text">Modo Lista</div>
          </div>
          <div class="menu-item" onclick="mostrarConteudo('3d')">
            <div class="menu-item-icon">üé≤</div>
            <div class="menu-item-text">Vis√£o 3D</div>
          </div>
        </div>
        
        <div class="menu-section">
          <div class="menu-section-title">üîî Opera√ß√µes</div>
          <div class="menu-item" onclick="abrirAlertas()">
            <div class="menu-item-icon">‚ö†Ô∏è</div>
            <div class="menu-item-text">Alertas de Validade</div>
          </div>
          <div class="menu-item" onclick="abrirInventario()">
            <div class="menu-item-icon">‚úÖ</div>
            <div class="menu-item-text">Invent√°rio</div>
          </div>
          <div class="menu-item" onclick="abrirHistorico()">
            <div class="menu-item-icon">üìú</div>
            <div class="menu-item-text">Hist√≥rico</div>
          </div>
          <div class="menu-item" onclick="abrirAnaliseGiro()">
            <div class="menu-item-icon">üîÑ</div>
            <div class="menu-item-text">An√°lise de Giro</div>
          </div>
        </div>
      </div>
    </div>

    
    <!-- CONTE√öDO PRINCIPAL -->
    <div class="main-content">
      <!-- HEADER SUPERIOR -->
      <div class="top-header">
        <div class="top-header-left">
          <div class="page-title">üó∫Ô∏è Mapa do Dep√≥sito - FERTILIZANTES</div>
        </div>
        <div class="top-header-actions">
          <div class="top-header-actions">
    
    <select id="warehouse-selector" class="warehouse-selector" onchange="window.location.href=this.value">
       <option value="#" selected disabled>üìç Selecionar Estoque</option>
        <option value="mapa-estoque.html">Mapa Defensivos</option>
        </select>

    <div class="export-menu">
        </div>
    </div>
          <div class="export-menu">
            <button id="btn-export" class="btn-header btn-export">üì• Exportar</button>
            <div class="export-dropdown" id="export-dropdown">
              <div class="export-option" onclick="exportarExcel()">üìä Exportar Excel</div>
              <div class="export-option" onclick="exportarPDF()">üìÑ Exportar PDF</div>
              <div class="export-option" onclick="exportarRelatorioCompleto()">üìã Relat√≥rio Completo</div>
            </div>
          </div>
          <a href="pesquisar-produtos.html" class="btn-header btn-search">üîç Buscar</a>
          <a href="gerenciar-deposito.html" class="btn-header btn-add">‚ûï Adicionar</a>
          <a href="menu.html" class="btn-header btn-menu">üè† Menu</a>
          <button id="logout-button" class="btn-header btn-logout">Sair</button>
        </div>
      </div>
      
      <!-- BARRA DE BUSCA -->
      <div class="search-bar">
        <div class="search-wrapper">
          <input type="text" id="search-input" class="search-input" placeholder="üîç Buscar produto no mapa (nome, lote, rua, v√£o...)">
          <button class="search-btn" onclick="buscarNoMapa()">Buscar</button>
          <button class="clear-search" id="clear-search" onclick="limparBusca()">Limpar</button>
        </div>
        <div class="search-results" id="search-results"></div>
      </div>
      
      <!-- ESTAT√çSTICAS -->
      <div class="stats-bar">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Capacidade Total</div>
            <div class="stat-value" id="stat-total">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ocupados</div>
            <div class="stat-value" id="stat-occupied">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Vazios</div>
            <div class="stat-value" id="stat-empty">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ocupa√ß√£o</div>
            <div class="stat-value" id="stat-percent">0%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Alertas</div>
            <div class="stat-value" id="stat-alerts">0</div>
          </div>
        </div>
      </div>
      
      <!-- √ÅREA DO MAPA -->
      <div class="map-container">
        <!-- MODO MAPA -->
        <div id="view-mapa" class="view-container">
          <div class="map-tabs">
            <button class="tab-button active" data-rua="D1">üÖ≥ RUA D1 <span class="tab-badge" id="badge-D1">0</span></button>
            <button class="tab-button" data-rua="D2">üÖ≥ RUA D2 <span class="tab-badge" id="badge-D2">0</span></button>
            <button class="tab-button" data-rua="E1">üÖ¥ RUA E1 <span class="tab-badge" id="badge-E1">0</span></button>
            <button class="tab-button" data-rua="E2">üÖ¥ RUA E2 <span class="tab-badge" id="badge-E2">0</span></button>
          </div>
          
          <div class="map-content">
            <div class="tab-content active" id="content-D1">
              <div class="filters-bar">
                <div class="filter-group">
                  <span class="filter-label">‚ö†Ô∏è Validade:</span>
                  <select class="filter-select filter-validade" data-rua="D1">
                    <option value="todos">Todos</option>
                    <option value="vencido">Vencidos</option>
                    <option value="proximo">Pr√≥ximo (30 dias)</option>
                    <option value="ok">OK</option>
                  </select>
                </div>
              </div>
              <div class="warehouse-grid" id="grid-D1">
                <div class="loading"><div class="loading-spinner"></div><p>Carregando...</p></div>
              </div>
            </div>

            <div class="tab-content" id="content-D2">
              <div class="filters-bar">
                <div class="filter-group">
                  <span class="filter-label">‚ö†Ô∏è Validade:</span>
                  <select class="filter-select filter-validade" data-rua="D2">
                    <option value="todos">Todos</option>
                    <option value="vencido">Vencidos</option>
                    <option value="proximo">Pr√≥ximo (30 dias)</option>
                    <option value="ok">OK</option>
                  </select>
                </div>
              </div>
              <div class="warehouse-grid" id="grid-D2">
                <div class="loading"><div class="loading-spinner"></div><p>Carregando...</p></div>
              </div>
            </div>

            <div class="tab-content" id="content-E1">
              <div class="filters-bar">
                <div class="filter-group">
                  <span class="filter-label">‚ö†Ô∏è Validade:</span>
                  <select class="filter-select filter-validade" data-rua="E1">
                    <option value="todos">Todos</option>
                    <option value="vencido">Vencidos</option>
                    <option value="proximo">Pr√≥ximo (30 dias)</option>
                    <option value="ok">OK</option>
                  </select>
                </div>
              </div>
              <div class="warehouse-grid" id="grid-E1">
                <div class="loading"><div class="loading-spinner"></div><p>Carregando...</p></div>
              </div>
            </div>

            <div class="tab-content" id="content-E2">
              <div class="filters-bar">
                <div class="filter-group">
                  <span class="filter-label">‚ö†Ô∏è Validade:</span>
                  <select class="filter-select filter-validade" data-rua="E2">
                    <option value="todos">Todos</option>
                    <option value="vencido">Vencidos</option>
                    <option value="proximo">Pr√≥ximo (30 dias)</option>
                    <option value="ok">OK</option>
                  </select>
                </div>
              </div>
              <div class="warehouse-grid" id="grid-E2">
                <div class="loading"><div class="loading-spinner"></div><p>Carregando...</p></div>
              </div>
            </div>
        
        <!-- MODO LISTA -->
        <div id="view-lista" class="view-container" style="display: none;">
          <div class="map-content">
            <h2 style="margin-bottom: 20px; color: #333;">üìã Visualiza√ß√£o em Lista</h2>
            <div class="table-view">
              <table class="data-table" id="table-produtos">
                <thead>
                  <tr>
                    <th>Produto</th>
                    <th>Lote</th>
                    <th>Validade</th>
                    <th>Status</th>
                    <th>Localiza√ß√£o</th>
                    <th>Cadastrado Por</th>
                  </tr>
                </thead>
                <tbody id="table-body">
                  <tr><td colspan="6" style="text-align: center; padding: 40px;">Carregando dados...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- MODO 3D -->
        <div id="view-3d" class="view-container" style="display: none;">
          <div class="map-content">
            <h2 style="margin-bottom: 20px; color: #333;">üé≤ Visualiza√ß√£o 3D do Dep√≥sito</h2>
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 80px; border-radius: 12px; text-align: center; color: white;">
              <div style="font-size: 5em; margin-bottom: 20px;">üèóÔ∏è</div>
              <h3 style="font-size: 2em; margin-bottom: 15px;">Visualiza√ß√£o 3D em Desenvolvimento</h3>
              <p style="font-size: 1.2em; opacity: 0.9;">Esta funcionalidade avan√ßada ser√° implementada em breve!</p>
              <p style="margin-top: 20px; opacity: 0.8;">Voc√™ poder√° visualizar o dep√≥sito em 3D, com rota√ß√£o e zoom interativo.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAIS (mantidos iguais ao c√≥digo anterior) -->
  <!-- MODAL DETALHES -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">üì¶ Detalhes do Pallet</h2>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer">
        <button class="btn-add-product" id="btn-add-product">‚ûï Adicionar Mais Produtos</button>
      </div>
    </div>
  </div>

  <!-- MODAL MOVER -->
  <div class="modal-move" id="modal-move">
    <div class="modal-move-content">
      <div class="modal-move-header">
        <h2>üîÑ Mover Produto</h2>
        <button class="modal-close" id="modal-move-close">&times;</button>
      </div>
      <div class="modal-move-body">
        <div class="current-location">
          <div class="current-location-title">üì¶ Produto</div>
          <div class="current-location-value" id="move-product-name">-</div>
          <div class="current-location-title" style="margin-top: 10px;">üìç Localiza√ß√£o Atual</div>
          <div class="current-location-value" id="move-current-location">-</div>
        </div>
        <h3 style="margin-bottom: 15px; color: #333;">Selecione a Nova Localiza√ß√£o:</h3>
        <div class="move-form-group">
          <label for="move-rua">üõ£Ô∏è Nova Rua</label>
          <select id="move-rua" required>
            <option value="">-- Selecione --</option>
            <option value="D1">Rua D1</option>
            <option value="D2">Rua D2</option>
            <option value="E1">Rua E1</option>
            <option value="E2">Rua E2</option>
          </select>
        </div>
        <div class="move-form-group">
          <label for="move-vao">üè¢ Novo V√£o</label>
          <select id="move-vao" required>
            <option value="">-- Selecione a rua primeiro --</option>
          </select>
        </div>
        <div class="move-form-group">
          <label for="move-nivel">üìä Novo N√≠vel</label>
          <select id="move-nivel" required>
            <option value="">-- Selecione --</option>
            <option value="1">N√≠vel 1</option>
            <option value="2">N√≠vel 2</option>
            <option value="3">N√≠vel 3</option>
            <option value="4">N√≠vel 4</option>
          </select>
        </div>
        <div class="move-form-group">
          <label for="move-pallet">üì¶ Novo Pallet</label>
          <select id="move-pallet" required>
            <option value="">-- Selecione --</option>
            <option value="1">Pallet 1</option>
            <option value="2">Pallet 2</option>
          </select>
        </div>
        <button class="btn-move-confirm" id="btn-move-confirm">üîÑ Confirmar Movimenta√ß√£o</button>
      </div>
    </div>
  </div>

  <!-- MODAL DASHBOARD -->
  <div class="modal" id="modal-dashboard">
    <div class="modal-content" style="max-width: 1200px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);">
        <h2>üìä Dashboard de An√°lise do Dep√≥sito</h2>
        <button class="modal-close" id="modal-dashboard-close">&times;</button>
      </div>
      <div class="modal-body" style="padding: 40px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; color: white; margin-bottom: 30px;">
          <h3 style="font-size: 1.5em; margin-bottom: 20px; text-align: center;">üì¶ Capacidade do Dep√≥sito</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div style="text-align: center;">
              <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">CAPACIDADE M√ÅXIMA</div>
              <div style="font-size: 2.5em; font-weight: 700;" id="dash-capacidade-maxima">0</div>
              <div style="font-size: 0.85em; opacity: 0.8;">pallets dispon√≠veis</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">PALLETS OCUPADOS</div>
              <div style="font-size: 2.5em; font-weight: 700;" id="dash-pallets-ocupados">0</div>
              <div style="font-size: 0.85em; opacity: 0.8;">em uso</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 8px;">PALLETS VAZIOS</div>
              <div style="font-size: 2.5em; font-weight: 700;" id="dash-pallets-vazios">0</div>
              <div style="font-size: 0.85em; opacity: 0.8;">dispon√≠veis</div>
            </div>
          </div>
          <div style="background: rgba(255,255,255,0.2); border-radius: 20px; height: 30px; overflow: hidden; position: relative;">
            <div id="dash-progress-bar" style="background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%); height: 100%; width: 0%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.9em;"></div>
          </div>
          <div style="text-align: center; margin-top: 10px; font-size: 1.1em; font-weight: 600;" id="dash-percentual">0% de ocupa√ß√£o</div>
        </div>

        <div style="background: white; border: 2px solid #e0e0e0; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
          <h3 style="font-size: 1.3em; margin-bottom: 20px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
            üìà Top 5 Produtos com Maior Volume
          </h3>
          <div id="dash-produtos-predominantes">
            <div style="text-align: center; padding: 40px; color: #999;">Carregando dados...</div>
          </div>
        </div>

        <div style="background: white; border: 2px solid #e0e0e0; padding: 25px; border-radius: 12px;">
          <h3 style="font-size: 1.3em; margin-bottom: 20px; color: #333; border-bottom: 2px solid #ff9800; padding-bottom: 10px;">
            ‚ö†Ô∏è Produtos com Validade Menor que 1 Ano
          </h3>
          <div id="dash-produtos-validade">
            <div style="text-align: center; padding: 40px; color: #999;">Carregando dados...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL HIST√ìRICO -->
  <div class="modal" id="modal-historico">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);">
        <h2>üìú Hist√≥rico de Movimenta√ß√µes</h2>
        <button class="modal-close" id="modal-historico-close">&times;</button>
      </div>
      <div class="modal-body" style="padding: 40px;">
        <div class="timeline" id="timeline-historico">
          <div style="text-align: center; padding: 40px; color: #999;">Carregando hist√≥rico...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL AN√ÅLISE DE GIRO -->
  <div class="modal" id="modal-analise">
    <div class="modal-content" style="max-width: 1200px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);">
        <h2>üîÑ An√°lise de Giro de Dep√≥sito</h2>
        <button class="modal-close" id="modal-analise-close">&times;</button>
      </div>
      <div class="modal-body" style="padding: 40px;">
        <div style="background: white; border: 2px solid #e0e0e0; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
          <h3 style="font-size: 1.3em; margin-bottom: 20px; color: #333; border-bottom: 2px solid #e91e63; padding-bottom: 10px;">
            üîÑ Produtos Mais Movimentados
          </h3>
          <div id="analise-mais-movimentados">
            <div style="text-align: center; padding: 40px; color: #999;">Carregando dados...</div>
          </div>
        </div>

        <div style="background: white; border: 2px solid #e0e0e0; padding: 25px; border-radius: 12px;">
          <h3 style="font-size: 1.3em; margin-bottom: 20px; color: #333; border-bottom: 2px solid #ff9800; padding-bottom: 10px;">
            ‚è±Ô∏è Produtos com Maior Tempo de Perman√™ncia
          </h3>
          <div id="analise-tempo-permanencia">
            <div style="text-align: center; padding: 40px; color: #999;">Carregando dados...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL ALERTAS -->
  <div class="modal" id="modal-alertas">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
        <h2>‚ö†Ô∏è Sistema de Alertas de Validade</h2>
        <button class="modal-close" id="modal-alertas-close">&times;</button>
      </div>
      <div class="modal-body" style="padding: 40px;">
        <div id="alertas-content">
          <div style="text-align: center; padding: 40px; color: #999;">Carregando alertas...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL INVENT√ÅRIO -->
  <div class="modal" id="modal-inventario">
    <div class="modal-content" style="max-width: 1000px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);">
        <h2>‚úÖ Sistema de Invent√°rio</h2>
        <button class="modal-close" id="modal-inventario-close">&times;</button>
      </div>
      <div class="modal-body" style="padding: 40px;">
        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 30px; border-radius: 12px; text-align: center; margin-bottom: 30px;">
          <div style="font-size: 4em; margin-bottom: 15px;">üìã</div>
          <h3 style="font-size: 1.8em; color: #2e7d32; margin-bottom: 10px;">Sistema de Contagem em Desenvolvimento</h3>
          <p style="color: #555; font-size: 1.1em;">Esta funcionalidade permitir√° fazer invent√°rios completos do dep√≥sito com checklist por rua e v√£o.</p>
        </div>
        <div style="background: white; border: 2px solid #4caf50; padding: 25px; border-radius: 12px;">
          <h4 style="color: #333; margin-bottom: 15px;">üéØ Funcionalidades Planejadas:</h4>
          <ul style="color: #666; line-height: 2; padding-left: 20px;">
            <li>‚úÖ Checklist de contagem por rua e v√£o</li>
            <li>‚úÖ Registro de diverg√™ncias autom√°ticas</li>
            <li>‚úÖ Status: Contado / Pendente / Divergente</li>
            <li>‚úÖ Relat√≥rio de invent√°rio completo</li>
            <li>‚úÖ Hist√≥rico de invent√°rios anteriores</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, getDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyD8GjaS3tuDpSvBl2-bpa-QXIKTqq80Mn4",
      authDomain: "login-com-dados.firebaseapp.com",
      projectId: "login-com-dados",
      storageBucket: "login-com-dados.firebasestorage.app",
      messagingSenderId: "75556023458",
      appId: "1:75556023458:web:9f1362d0597603c0f37bfb",
      measurementId: "G-W9LRT99579"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const estruturaMaxima = {
      'D1': { vaos: 8, niveis: 4, pallets: 2 },
      'D2': { vaos: 8, niveis: 4, pallets: 2 },
      'E1': { vaos: 3, niveis: 4, pallets: 2 },
      'E2': { vaos: 3, niveis: 4, pallets: 2 },
    };

    let todosOsProdutos = [];
    let produtoParaMover = null;
    let produtosDestacados = [];

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = 'index.html';
      else carregarDeposito();
    });

    document.getElementById('logout-button').addEventListener('click', () => {
      signOut(auth).then(() => window.location.href = 'index.html');
    });

    // NAVEGA√á√ÉO NO MENU LATERAL
    window.mostrarConteudo = function(tipo) {
      // Atualizar menu ativo
      document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
      event.target.closest('.menu-item').classList.add('active');

      // Mostrar conte√∫do apropriado
      document.querySelectorAll('.view-container').forEach(view => view.style.display = 'none');

      if (tipo === 'mapa') {
        document.getElementById('view-mapa').style.display = 'block';
        document.querySelector('.page-title').textContent = 'üó∫Ô∏è Mapa do Dep√≥sito';
      } else if (tipo === 'lista') {
        document.getElementById('view-lista').style.display = 'block';
        document.querySelector('.page-title').textContent = 'üìã Modo Lista';
        renderizarModoLista();
      } else if (tipo === '3d') {
        document.getElementById('view-3d').style.display = 'block';
        document.querySelector('.page-title').textContent = 'üé≤ Vis√£o 3D';
      }
    };

    // BUSCA COM ENTER
    document.getElementById('search-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') buscarNoMapa();
    });

    async function carregarDeposito() {
      try {
        const q = query(collection(db, 'deposito'), orderBy('criadoEm', 'desc'));
        const snapshot = await getDocs(q);
        todosOsProdutos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderizarTudo();
        renderizarModoLista();
      } catch (error) {
        console.error('Erro ao carregar dep√≥sito:', error);
      }
    }

    function calcularStatusValidade(validade) {
      if (!validade) return 'ok';
      const hoje = new Date();
      const dataValidade = new Date(validade);
      const diasRestantes = Math.floor((dataValidade - hoje) / (1000 * 60 * 60 * 24));
      if (diasRestantes < 0) return 'vencido';
      if (diasRestantes <= 30) return 'proximo';
      return 'ok';
    }

    function formatarData(data) {
      if (!data) return 'N/A';
      const [ano, mes, dia] = data.split('-');
      return `${dia}/${mes}/${ano}`;
    }

    function organizarPorEstrutura(produtos) {
      const estrutura = {};
      produtos.forEach(produto => {
        const rua = produto.rua || 'SEM_RUA';
        const vao = produto.vao || 1;
        const nivel = produto.nivel || 1;
        const pallet = produto.pallet || 1;

        if (!estrutura[rua]) estrutura[rua] = {};
        if (!estrutura[rua][vao]) estrutura[rua][vao] = {};
        if (!estrutura[rua][vao][nivel]) estrutura[rua][vao][nivel] = {};
        if (!estrutura[rua][vao][nivel][pallet]) estrutura[rua][vao][nivel][pallet] = [];
        
        estrutura[rua][vao][nivel][pallet].push(produto);
      });
      return estrutura;
    }

    function renderizarTudo() {
      const estrutura = organizarPorEstrutura(todosOsProdutos);
      
      Object.keys(estruturaMaxima).forEach(rua => {
        renderizarRua(rua, estrutura[rua] || {});
      });

      atualizarEstatisticas();
    }

    function renderizarRua(rua, estruturaRua) {
      const grid = document.getElementById(`grid-${rua}`);
      const config = estruturaMaxima[rua];
      grid.innerHTML = '';

      let palletsOcupados = 0;

      for (let vao = 1; vao <= config.vaos; vao++) {
        const vaoCard = document.createElement('div');
        vaoCard.className = 'vao-card';
        vaoCard.setAttribute('data-vao-id', `${rua}-${vao}`);

        const vaoHeader = document.createElement('div');
        vaoHeader.className = 'vao-header';
        vaoHeader.textContent = `V√ÉO ${vao}`;
        vaoCard.appendChild(vaoHeader);

        const niveisContainer = document.createElement('div');
        niveisContainer.className = 'niveis-container';

        for (let nivel = config.niveis; nivel >= 1; nivel--) {
          const nivelRow = document.createElement('div');
          nivelRow.className = 'nivel-row';

          const nivelLabel = document.createElement('div');
          nivelLabel.className = 'nivel-label';
          nivelLabel.textContent = `N${nivel}`;
          nivelRow.appendChild(nivelLabel);

          const palletsRow = document.createElement('div');
          palletsRow.className = 'pallets-row';

          for (let pallet = 1; pallet <= config.pallets; pallet++) {
            const produtos = estruturaRua[vao]?.[nivel]?.[pallet] || [];
            const slot = criarSlotPallet(rua, vao, nivel, pallet, produtos);
            
            if (produtos.length > 0) palletsOcupados++;
            
            palletsRow.appendChild(slot);
          }

          nivelRow.appendChild(palletsRow);
          niveisContainer.appendChild(nivelRow);
        }

        vaoCard.appendChild(niveisContainer);
        grid.appendChild(vaoCard);
      }

      document.getElementById(`badge-${rua}`).textContent = palletsOcupados;
    }

    function criarSlotPallet(rua, vao, nivel, pallet, produtos) {
      const slot = document.createElement('div');
      const isEmpty = produtos.length === 0;
      const slotId = `${rua}-${vao}-${nivel}-${pallet}`;

      if (isEmpty) {
        slot.className = 'pallet-slot empty';
        slot.setAttribute('data-slot-id', slotId);
        slot.innerHTML = `
          <div class="pallet-number">P${pallet}</div>
          <div class="pallet-icon">üì¶</div>
        `;
        slot.addEventListener('click', () => {
          window.location.href = `gerenciar-deposito.html?rua=${rua}&vao=${vao}&nivel=${nivel}&pallet=${pallet}`;
        });
      } else {
        const piorStatus = produtos.reduce((acc, p) => {
          const status = calcularStatusValidade(p.validade);
          if (status === 'vencido') return 'vencido';
          if (status === 'proximo' && acc !== 'vencido') return 'proximo';
          return acc;
        }, 'ok');

        const statusClass = piorStatus === 'vencido' ? 'danger' : piorStatus === 'proximo' ? 'warning' : 'occupied';
        slot.className = `pallet-slot ${statusClass}`;
        slot.setAttribute('data-rua', rua);
        slot.setAttribute('data-vao', vao);
        slot.setAttribute('data-nivel', nivel);
        slot.setAttribute('data-pallet', pallet);
        slot.setAttribute('data-status', piorStatus);
        slot.setAttribute('data-slot-id', slotId);
        
        const icone = piorStatus === 'vencido' ? '‚ùå' : piorStatus === 'proximo' ? '‚ö†Ô∏è' : '‚úÖ';
        
        slot.innerHTML = `
          <div class="pallet-number">P${pallet}</div>
          <div class="pallet-icon">${icone}</div>
          <div class="pallet-count">${produtos.length}</div>
        `;
        
        if (produtosDestacados.some(p => p.rua === rua && p.vao == vao && p.nivel == nivel && p.pallet == pallet)) {
          slot.classList.add('highlight');
        }
        
        slot.addEventListener('click', () => abrirModal(rua, vao, nivel, pallet, produtos));
      }

      return slot;
    }

    function atualizarEstatisticas() {
      const estrutura = organizarPorEstrutura(todosOsProdutos);
      let capacidadeTotal = 0;
      let occupied = 0;
      let alerts = 0;

      Object.entries(estruturaMaxima).forEach(([rua, config]) => {
        const totalRua = config.vaos * config.niveis * config.pallets;
        capacidadeTotal += totalRua;
      });

      Object.values(estrutura).forEach(rua => {
        Object.values(rua).forEach(vao => {
          Object.values(vao).forEach(nivel => {
            Object.values(nivel).forEach(produtos => {
              if (produtos.length > 0) {
                occupied++;
                if (produtos.some(p => calcularStatusValidade(p.validade) !== 'ok')) alerts++;
              }
            });
          });
        });
      });

      const empty = capacidadeTotal - occupied;
      const percent = capacidadeTotal > 0 ? ((occupied / capacidadeTotal) * 100).toFixed(1) : 0;

      document.getElementById('stat-total').textContent = capacidadeTotal;
      document.getElementById('stat-occupied').textContent = occupied;
      document.getElementById('stat-empty').textContent = empty;
      document.getElementById('stat-percent').textContent = `${percent}%`;
      document.getElementById('stat-alerts').textContent = alerts;
    }

     // ========== MODO LISTA ==========
      function renderizarModoLista() {
      const tbody = document.getElementById('table-body');
      
      if (todosOsProdutos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">Nenhum produto cadastrado</td></tr>';
        return;
      }

      const html = todosOsProdutos.map(p => {
        const status = calcularStatusValidade(p.validade);
        const statusClass = status === 'vencido' ? 'danger' : status === 'proximo' ? 'warning' : 'ok';
        const statusText = status === 'vencido' ? '‚ùå Vencido' : status === 'proximo' ? '‚ö†Ô∏è Pr√≥ximo' : '‚úÖ OK';
        
        return `
          <tr>
            <td><strong>${p.nome}</strong></td>
            <td>${p.lote}</td>
            <td>${formatarData(p.validade)}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>RUA ${p.rua} - V√ÉO ${p.vao} - N${p.nivel} - P${p.pallet}</td>
            <td>${p.criadoPor || 'Sistema'}</td>
          </tr>
        `;
      }).join('');

      tbody.innerHTML = html;
    }

    // ========== BUSCA INTELIGENTE ==========
    window.buscarNoMapa = function() {
      const termo = document.getElementById('search-input').value.toLowerCase().trim();
      
      if (!termo) {
        alert('‚ö†Ô∏è Digite algo para buscar!');
        return;
      }

      produtosDestacados = [];
      document.querySelectorAll('.pallet-slot.highlight').forEach(slot => {
        slot.classList.remove('highlight');
      });
      document.querySelectorAll('.vao-card.highlight').forEach(card => {
        card.classList.remove('highlight');
      });

      const resultados = todosOsProdutos.filter(produto => {
        return produto.nome.toLowerCase().includes(termo) ||
               produto.lote.toLowerCase().includes(termo) ||
               produto.rua.toLowerCase().includes(termo) ||
               `${produto.vao}`.includes(termo);
      });

      const searchResults = document.getElementById('search-results');
      const clearBtn = document.getElementById('clear-search');

      if (resultados.length === 0) {
        searchResults.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">‚ùå Nenhum produto encontrado</div>';
        searchResults.style.display = 'block';
        clearBtn.style.display = 'none';
        return;
      }

      produtosDestacados = resultados.map(p => ({
        rua: p.rua,
        vao: p.vao,
        nivel: p.nivel,
        pallet: p.pallet
      }));

      const html = resultados.map(p => `
        <div class="search-result-item" onclick="irParaProduto('${p.rua}', ${p.vao}, ${p.nivel}, ${p.pallet})">
          <strong>${p.nome}</strong> - Lote: ${p.lote}<br>
          <small style="color: #999;">üìç RUA ${p.rua} - V√ÉO ${p.vao} - N√çVEL ${p.nivel} - PALLET ${p.pallet}</small>
        </div>
      `).join('');

      searchResults.innerHTML = `
        <div style="margin-bottom: 10px; font-weight: 600; color: #667eea;">
          ‚úÖ Encontrado${resultados.length > 1 ? 's' : ''} ${resultados.length} produto${resultados.length > 1 ? 's' : ''}
        </div>
        ${html}
      `;
      searchResults.style.display = 'block';
      clearBtn.style.display = 'inline-block';

      renderizarTudo();
    };

    window.irParaProduto = function(rua, vao, nivel, pallet) {
      document.querySelectorAll('.tab-button').forEach(btn => {
        if (btn.getAttribute('data-rua') === rua) {
          btn.click();
        }
      });

      setTimeout(() => {
        const vaoCard = document.querySelector(`[data-vao-id="${rua}-${vao}"]`);
        if (vaoCard) {
          vaoCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          vaoCard.classList.add('highlight');
        }

        const slot = document.querySelector(`[data-slot-id="${rua}-${vao}-${nivel}-${pallet}"]`);
        if (slot) {
          slot.classList.add('highlight');
          setTimeout(() => slot.click(), 500);
        }
      }, 300);
    };

    window.limparBusca = function() {
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').style.display = 'none';
      document.getElementById('clear-search').style.display = 'none';
      
      produtosDestacados = [];
      document.querySelectorAll('.pallet-slot.highlight').forEach(slot => {
        slot.classList.remove('highlight');
      });
      document.querySelectorAll('.vao-card.highlight').forEach(card => {
        card.classList.remove('highlight');
      });
    };

    // ========== EXPORTA√á√ÉO ==========
    document.getElementById('btn-export').addEventListener('click', () => {
      const dropdown = document.getElementById('export-dropdown');
      dropdown.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      const exportMenu = document.querySelector('.export-menu');
      const dropdown = document.getElementById('export-dropdown');
      if (!exportMenu.contains(e.target)) {
        dropdown.classList.remove('active');
      }
    });

    window.exportarExcel = function() {
      const dados = todosOsProdutos.map(p => ({
        'Produto': p.nome,
        'Lote': p.lote,
        'Validade': formatarData(p.validade),
        'Rua': p.rua,
        'V√£o': p.vao,
        'N√≠vel': p.nivel,
        'Pallet': p.pallet,
        'Cadastrado Por': p.criadoPor || 'Sistema',
        'Data Cadastro': p.criadoEm || 'N/A'
      }));

      let csv = Object.keys(dados[0]).join(',') + '\n';
      dados.forEach(row => {
        csv += Object.values(row).join(',') + '\n';
      });

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `deposito_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      document.getElementById('export-dropdown').classList.remove('active');
      alert('‚úÖ Arquivo Excel exportado com sucesso!');
    };

    window.exportarPDF = function() {
      alert('üìÑ Fun√ß√£o de exporta√ß√£o para PDF ser√° implementada em breve!');
      document.getElementById('export-dropdown').classList.remove('active');
    };

    window.exportarRelatorioCompleto = function() {
      const estrutura = organizarPorEstrutura(todosOsProdutos);
      let relatorio = 'RELAT√ìRIO COMPLETO DE DEP√ìSITO\n';
      relatorio += '='.repeat(50) + '\n\n';
      relatorio += `Data: ${new Date().toLocaleString('pt-BR')}\n\n`;

      Object.entries(estruturaMaxima).forEach(([rua, config]) => {
        relatorio += `\nRUA ${rua}\n`;
        relatorio += '-'.repeat(50) + '\n';
        
        for (let vao = 1; vao <= config.vaos; vao++) {
          for (let nivel = 1; nivel <= config.niveis; nivel++) {
            for (let pallet = 1; pallet <= config.pallets; pallet++) {
              const produtos = estrutura[rua]?.[vao]?.[nivel]?.[pallet] || [];
              if (produtos.length > 0) {
                relatorio += `  V√ÉO ${vao} - N√çVEL ${nivel} - PALLET ${pallet}: ${produtos.length} produto(s)\n`;
                produtos.forEach(p => {
                  relatorio += `    - ${p.nome} (Lote: ${p.lote}, Val: ${formatarData(p.validade)})\n`;
                });
              }
            }
          }
        }
      });

      const blob = new Blob([relatorio], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `relatorio_completo_${new Date().toISOString().split('T')[0]}.txt`;
      link.click();
      
      document.getElementById('export-dropdown').classList.remove('active');
      alert('‚úÖ Relat√≥rio completo exportado com sucesso!');
    };

    // ========== HIST√ìRICO ==========
    window.abrirHistorico = function() {
      const timeline = document.getElementById('timeline-historico');
      
      const produtosComMovimentacao = todosOsProdutos.filter(p => p.ultimaMovimentacao);
      
      if (produtosComMovimentacao.length === 0) {
        timeline.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 5em; margin-bottom: 20px; opacity: 0.5;">üìã</div>
            <div style="font-size: 1.3em; color: #666;">Nenhuma movimenta√ß√£o registrada</div>
          </div>
        `;
      } else {
        const html = produtosComMovimentacao.map(p => `
          <div class="timeline-item">
            <div class="timeline-icon">üîÑ</div>
            <div class="timeline-content">
              <div class="timeline-header">
                <div class="timeline-title">${p.nome}</div>
                <div class="timeline-date">${p.movidoEm || 'Data n√£o dispon√≠vel'}</div>
              </div>
              <div class="timeline-description">
                ${p.ultimaMovimentacao}
              </div>
            </div>
          </div>
        `).join('');
        
        timeline.innerHTML = html;
      }
      
      document.getElementById('modal-historico').classList.add('active');
    };

    document.getElementById('modal-historico-close').addEventListener('click', () => {
      document.getElementById('modal-historico').classList.remove('active');
    });

    // ========== AN√ÅLISE DE GIRO ==========
    window.abrirAnaliseGiro = function() {
      const produtosComMovimentacao = todosOsProdutos.filter(p => p.ultimaMovimentacao);
      const contagemMovimentacao = {};
      
      produtosComMovimentacao.forEach(p => {
        if (!contagemMovimentacao[p.nome]) {
          contagemMovimentacao[p.nome] = 0;
        }
        contagemMovimentacao[p.nome]++;
      });

      const maisMovimentados = Object.entries(contagemMovimentacao)
        .map(([nome, count]) => ({ nome, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

      const htmlMaisMovimentados = maisMovimentados.length > 0
        ? maisMovimentados.map((item, index) => `
            <div class="produto-rank-item">
              <div class="rank-number">${index + 1}¬∫</div>
              <div class="rank-info">
                <div class="rank-nome">${item.nome}</div>
                <div class="rank-detalhes">${item.count} movimenta√ß${item.count > 1 ? '√µes' : '√£o'} registrada${item.count > 1 ? 's' : ''}</div>
              </div>
              <div class="rank-count">${item.count}</div>
            </div>
          `).join('')
        : '<div style="text-align: center; padding: 40px; color: #999;">Nenhuma movimenta√ß√£o registrada</div>';

      document.getElementById('analise-mais-movimentados').innerHTML = htmlMaisMovimentados;

      const hoje = new Date();
      const produtosComTempo = todosOsProdutos.map(p => {
        let dataCadastro = new Date();
        if (p.criadoEm) {
          const partes = p.criadoEm.split(/[\/\s:]/);
          if (partes.length >= 3) {
            dataCadastro = new Date(partes[2], partes[1] - 1, partes[0]);
          }
        }
        const diasPermanencia = Math.floor((hoje - dataCadastro) / (1000 * 60 * 60 * 24));
        return { ...p, diasPermanencia };
      }).sort((a, b) => b.diasPermanencia - a.diasPermanencia).slice(0, 5);

      const htmlTempoPermanencia = produtosComTempo.map((item, index) => `
        <div class="produto-rank-item" style="border-left-color: ${item.diasPermanencia > 180 ? '#f44336' : item.diasPermanencia > 90 ? '#ff9800' : '#667eea'};">
          <div class="rank-number">${index + 1}¬∫</div>
          <div class="rank-info">
            <div class="rank-nome">${item.nome}</div>
            <div class="rank-detalhes">
              Lote: ${item.lote} | üìç RUA ${item.rua} - V√ÉO ${item.vao} - N√çVEL ${item.nivel} - PALLET ${item.pallet}
            </div>
          </div>
          <div class="rank-count" style="color: ${item.diasPermanencia > 180 ? '#f44336' : item.diasPermanencia > 90 ? '#ff9800' : '#2ecc71'};">
            ${item.diasPermanencia} dias
          </div>
        </div>
      `).join('');

      document.getElementById('analise-tempo-permanencia').innerHTML = htmlTempoPermanencia;
      
      document.getElementById('modal-analise').classList.add('active');
    };

    document.getElementById('modal-analise-close').addEventListener('click', () => {
      document.getElementById('modal-analise').classList.remove('active');
    });

    // ========== ALERTAS ==========
    window.abrirAlertas = function() {
      const hoje = new Date();
      const alertasContent = document.getElementById('alertas-content');
      
      const produtosVencidos = todosOsProdutos.filter(p => {
        const status = calcularStatusValidade(p.validade);
        return status === 'vencido';
      });

      const produtosProximos = todosOsProdutos.filter(p => {
        const status = calcularStatusValidade(p.validade);
        return status === 'proximo';
      });

      let html = '';

      if (produtosVencidos.length > 0) {
        html += `
          <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #f44336; margin-bottom: 20px;">
            <h3 style="color: #c62828; margin-bottom: 15px; font-size: 1.3em;">‚ùå Produtos Vencidos (${produtosVencidos.length})</h3>
            ${produtosVencidos.map(p => `
              <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                <strong style="color: #333;">${p.nome}</strong> - Lote: ${p.lote}<br>
                <small style="color: #666;">Validade: ${formatarData(p.validade)} | üìç RUA ${p.rua} - V√ÉO ${p.vao} - N${p.nivel} - P${p.pallet}</small>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (produtosProximos.length > 0) {
        html += `
          <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #ff9800; margin-bottom: 20px;">
            <h3 style="color: #e65100; margin-bottom: 15px; font-size: 1.3em;">‚ö†Ô∏è Vencimento Pr√≥ximo - 30 dias (${produtosProximos.length})</h3>
            ${produtosProximos.map(p => {
              const dataValidade = new Date(p.validade);
              const diasRestantes = Math.floor((dataValidade - hoje) / (1000 * 60 * 60 * 24));
              return `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                  <strong style="color: #333;">${p.nome}</strong> - Lote: ${p.lote}<br>
                  <small style="color: #666;">Validade: ${formatarData(p.validade)} (${diasRestantes} dias) | üìç RUA ${p.rua} - V√ÉO ${p.vao} - N${p.nivel} - P${p.pallet}</small>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      if (produtosVencidos.length === 0 && produtosProximos.length === 0) {
        html = `
          <div style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 5em; margin-bottom: 20px;">‚úÖ</div>
            <h3 style="font-size: 1.8em; color: #2e7d32; margin-bottom: 10px;">Tudo OK!</h3>
            <p style="color: #666; font-size: 1.1em;">Nenhum alerta de validade no momento.</p>
          </div>
        `;
      }

      alertasContent.innerHTML = html;
      document.getElementById('modal-alertas').classList.add('active');
    };

    document.getElementById('modal-alertas-close').addEventListener('click', () => {
      document.getElementById('modal-alertas').classList.remove('active');
    });

    // ========== INVENT√ÅRIO ==========
    window.abrirInventario = function() {
      document.getElementById('modal-inventario').classList.add('active');
    };

    document.getElementById('modal-inventario-close').addEventListener('click', () => {
      document.getElementById('modal-inventario').classList.remove('active');
    });

    // ========== SISTEMA DE ABAS ==========
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        const rua = button.getAttribute('data-rua');
        
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        button.classList.add('active');
        document.getElementById(`content-${rua}`).classList.add('active');
      });
    });

    // FILTROS DE VALIDADE
    document.querySelectorAll('.filter-validade').forEach(select => {
      select.addEventListener('change', (e) => {
        const rua = e.target.getAttribute('data-rua');
        const filtro = e.target.value;
        aplicarFiltroValidade(rua, filtro);
      });
    });

    function aplicarFiltroValidade(rua, filtro) {
      const slots = document.querySelectorAll(`#grid-${rua} .pallet-slot[data-rua="${rua}"]`);
      
      slots.forEach(slot => {
        if (filtro === 'todos') {
          slot.style.display = '';
          return;
        }

        const status = slot.getAttribute('data-status');
        
        if (filtro === status) {
          slot.style.display = '';
        } else {
          slot.style.display = 'none';
        }
      });
    }

    function abrirModal(rua, vao, nivel, pallet, produtos) {
      const modal = document.getElementById('modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      const btnAdd = document.getElementById('btn-add-product');
      
      title.textContent = `üì¶ Pallet - ${produtos.length} Produto${produtos.length !== 1 ? 's' : ''}`;
      
      const produtosHtml = produtos.map(produto => {
        const statusValidade = calcularStatusValidade(produto.validade);
        const statusClass = statusValidade === 'vencido' ? 'danger' : statusValidade === 'proximo' ? 'warning' : '';
        const statusText = statusValidade === 'vencido' ? '‚ùå VENCIDO' : statusValidade === 'proximo' ? '‚ö†Ô∏è VENCIMENTO PR√ìXIMO' : '‚úÖ VALIDADE OK';
        
        return `
          <div class="product-item ${statusClass}">
            <div class="product-name">${produto.nome}</div>
            <div class="product-details">
              <div class="product-detail"><span class="detail-label">Lote:</span> <span class="detail-value">${produto.lote}</span></div>
              <div class="product-detail"><span class="detail-label">Validade:</span> <span class="detail-value">${formatarData(produto.validade)}</span></div>
              <div class="product-detail"><span class="detail-label">Status:</span> <span class="detail-value">${statusText}</span></div>
              <div class="product-detail"><span class="detail-label">Cadastrado por:</span> <span class="detail-value">${produto.criadoPor || 'Sistema'}</span></div>
              <div class="product-detail"><span class="detail-label">Data cadastro:</span> <span class="detail-value">${produto.criadoEm || 'N/A'}</span></div>
            </div>
            ${produto.ultimaMovimentacao ? `
              <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid #2196f3;">
                <div style="font-weight: 600; color: #1976d2; margin-bottom: 5px; font-size: 0.9em;">üì¶ √öltima Movimenta√ß√£o:</div>
                <div style="color: #555; font-size: 0.85em; line-height: 1.5;">${produto.ultimaMovimentacao}</div>
              </div>
            ` : ''}
            <div class="product-actions">
              <button class="btn-small btn-move" onclick="abrirModalMover('${produto.id}', '${rua}', ${vao}, ${nivel}, ${pallet}, '${produto.nome.replace(/'/g, "\\'")}')">üîÑ Mover</button>
              <button class="btn-small btn-remove" onclick="removerProduto('${produto.id}')">üóëÔ∏è Remover</button>
            </div>
          </div>
        `;
      }).join('');
      
      body.innerHTML = `
        <div class="location-badge">üìç RUA ${rua} - V√ÉO ${vao} - N√çVEL ${nivel} - PALLET ${pallet}</div>
        <div class="products-list"><h3>üìã Produtos Armazenados</h3>${produtosHtml}</div>
      `;

      btnAdd.onclick = () => window.location.href = `gerenciar-deposito.html?rua=${rua}&vao=${vao}&nivel=${nivel}&pallet=${pallet}`;
      modal.classList.add('active');
    }

    window.removerProduto = async function(produtoId) {
      if (!confirm('‚ö†Ô∏è TEM CERTEZA que deseja REMOVER este produto?')) return;
      try {
        await deleteDoc(doc(db, 'deposito', produtoId));
        alert('‚úÖ Produto removido com sucesso!');
        document.getElementById('modal').classList.remove('active');
        await carregarDeposito();
      } catch (error) {
        alert('‚ùå Erro ao remover: ' + error.message);
      }
    };

    document.getElementById('modal-close').addEventListener('click', () => {
      document.getElementById('modal').classList.remove('active');
    });

    window.abrirModalMover = function(produtoId, rua, vao, nivel, pallet, produtoNome) {
      produtoParaMover = { id: produtoId, ruaOrigem: rua, vaoOrigem: vao, nivelOrigem: nivel, palletOrigem: pallet };
      document.getElementById('move-product-name').textContent = produtoNome;
      document.getElementById('move-current-location').textContent = `RUA ${rua} - V√ÉO ${vao} - N√çVEL ${nivel} - PALLET ${pallet}`;
      document.getElementById('move-rua').value = '';
      document.getElementById('move-vao').value = '';
      document.getElementById('move-nivel').value = '';
      document.getElementById('move-pallet').value = '';
      document.getElementById('modal-move').classList.add('active');
    };

    document.getElementById('move-rua').addEventListener('change', (e) => {
      const rua = e.target.value;
      const selectVao = document.getElementById('move-vao');
      selectVao.innerHTML = '<option value="">-- Selecione --</option>';
      
      if (rua && estruturaMaxima[rua]) {
        for (let i = 1; i <= estruturaMaxima[rua].vaos; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = `V√£o ${i}`;
          selectVao.appendChild(option);
        }
      }
    });

    document.getElementById('modal-move-close').addEventListener('click', () => {
      document.getElementById('modal-move').classList.remove('active');
      produtoParaMover = null;
    });

    document.getElementById('btn-move-confirm').addEventListener('click', async () => {
      if (!produtoParaMover) return;

      const novaRua = document.getElementById('move-rua').value;
      const novoVao = parseInt(document.getElementById('move-vao').value);
      const novoNivel = parseInt(document.getElementById('move-nivel').value);
      const novoPallet = parseInt(document.getElementById('move-pallet').value);

      if (!novaRua || !novoVao || !novoNivel || !novoPallet) {
        alert('‚ö†Ô∏è Preencha todos os campos!');
        return;
      }

      if (novaRua === produtoParaMover.ruaOrigem && novoVao === produtoParaMover.vaoOrigem && novoNivel === produtoParaMover.nivelOrigem && novoPallet === produtoParaMover.palletOrigem) {
        alert('‚ö†Ô∏è A nova localiza√ß√£o √© igual √† atual!');
        return;
      }

      if (!confirm(`üîÑ Confirmar movimenta√ß√£o?\n\nDE: RUA ${produtoParaMover.ruaOrigem} - V√ÉO ${produtoParaMover.vaoOrigem} - N√çVEL ${produtoParaMover.nivelOrigem} - PALLET ${produtoParaMover.palletOrigem}\n\nPARA: RUA ${novaRua} - V√ÉO ${novoVao} - N√çVEL ${novoNivel} - PALLET ${novoPallet}`)) return;

      try {
        let nomeUsuario = 'Usu√°rio';
        try {
          const userDoc = await getDoc(doc(db, 'usuarios', auth.currentUser.uid));
          if (userDoc.exists() && userDoc.data().nome) {
            nomeUsuario = userDoc.data().nome;
          } else {
            const emailParts = auth.currentUser.email.split('@')[0];
            nomeUsuario = emailParts.replace(/[._]/g, ' ').split(' ').map(palavra => 
              palavra.charAt(0).toUpperCase() + palavra.slice(1).toLowerCase()
            ).join(' ');
          }
        } catch (error) {
          const emailParts = auth.currentUser.email.split('@')[0];
          nomeUsuario = emailParts.replace(/[._]/g, ' ').split(' ').map(palavra => 
            palavra.charAt(0).toUpperCase() + palavra.slice(1).toLowerCase()
          ).join(' ');
        }

        const agora = new Date();
        const dataFormatada = agora.toLocaleString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        const historicoMovimentacao = `Movido de RUA ${produtoParaMover.ruaOrigem} - V√ÉO ${produtoParaMover.vaoOrigem} - N√çVEL ${produtoParaMover.nivelOrigem} - PALLET ${produtoParaMover.palletOrigem} para RUA ${novaRua} - V√ÉO ${novoVao} - N√çVEL ${novoNivel} - PALLET ${novoPallet} por ${nomeUsuario} em ${dataFormatada}`;

        await updateDoc(doc(db, 'deposito', produtoParaMover.id), {
          rua: novaRua,
          vao: novoVao,
          nivel: novoNivel,
          pallet: novoPallet,
          ultimaMovimentacao: historicoMovimentacao,
          movidoPor: nomeUsuario,
          movidoEm: dataFormatada
        });

        alert('‚úÖ Produto movido com sucesso!');
        document.getElementById('modal-move').classList.remove('active');
        document.getElementById('modal').classList.remove('active');
        produtoParaMover = null;
        await carregarDeposito();
      } catch (error) {
        alert('‚ùå Erro ao mover: ' + error.message);
      }
    });

    // DASHBOARD
    window.abrirDashboard = function() {
      let capacidadeTotal = 0;
      Object.values(estruturaMaxima).forEach(config => {
        capacidadeTotal += config.vaos * config.niveis * config.pallets;
      });

      const estrutura = organizarPorEstrutura(todosOsProdutos);
      let palletsOcupados = 0;
      
      Object.values(estrutura).forEach(rua => {
        Object.values(rua).forEach(vao => {
          Object.values(vao).forEach(nivel => {
            Object.values(nivel).forEach(produtos => {
              if (produtos.length > 0) palletsOcupados++;
            });
          });
        });
      });

      const palletsVazios = capacidadeTotal - palletsOcupados;
      const percentualOcupacao = ((palletsOcupados / capacidadeTotal) * 100).toFixed(1);

      document.getElementById('dash-capacidade-maxima').textContent = capacidadeTotal;
      document.getElementById('dash-pallets-ocupados').textContent = palletsOcupados;
      document.getElementById('dash-pallets-vazios').textContent = palletsVazios;
      document.getElementById('dash-percentual').textContent = `${percentualOcupacao}% de ocupa√ß√£o`;
      
      const progressBar = document.getElementById('dash-progress-bar');
      progressBar.style.width = `${percentualOcupacao}%`;
      progressBar.textContent = `${percentualOcupacao}%`;

      const contadorProdutos = {};
      todosOsProdutos.forEach(produto => {
        const nome = produto.nome;
        if (!contadorProdutos[nome]) {
          contadorProdutos[nome] = { count: 0, lotes: new Set() };
        }
        contadorProdutos[nome].count++;
        contadorProdutos[nome].lotes.add(produto.lote);
      });

      const produtosOrdenados = Object.entries(contadorProdutos)
        .map(([nome, dados]) => ({ nome, count: dados.count, lotes: dados.lotes.size }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

      const htmlProdutos = produtosOrdenados.length > 0 
        ? produtosOrdenados.map((produto, index) => `
            <div class="produto-rank-item">
              <div class="rank-number">${index + 1}¬∫</div>
              <div class="rank-info">
                <div class="rank-nome">${produto.nome}</div>
                <div class="rank-detalhes">${produto.lotes} lote${produto.lotes > 1 ? 's' : ''} diferente${produto.lotes > 1 ? 's' : ''}</div>
              </div>
              <div class="rank-count">${produto.count}</div>
            </div>
          `).join('')
        : '<div style="text-align: center; padding: 40px; color: #999;">Nenhum produto cadastrado</div>';

      document.getElementById('dash-produtos-predominantes').innerHTML = htmlProdutos;

      const hoje = new Date();
      const umAnoDepois = new Date();
      umAnoDepois.setFullYear(hoje.getFullYear() + 1);

      const produtosValidadeCurta = todosOsProdutos.filter(produto => {
        if (!produto.validade) return false;
        const dataValidade = new Date(produto.validade);
        return dataValidade <= umAnoDepois;
      }).sort((a, b) => new Date(a.validade) - new Date(b.validade));

      const htmlValidade = produtosValidadeCurta.length > 0
        ? produtosValidadeCurta.map(produto => {
            const dataValidade = new Date(produto.validade);
            const diasRestantes = Math.floor((dataValidade - hoje) / (1000 * 60 * 60 * 24));
            const statusValidade = calcularStatusValidade(produto.validade);
            const corStatus = statusValidade === 'vencido' ? '#f44336' : statusValidade === 'proximo' ? '#ff9800' : '#ff6f00';
            const textoStatus = statusValidade === 'vencido' ? 'VENCIDO' : `${diasRestantes} dias`;
            
            return `
              <div class="produto-rank-item"
              <div class="produto-rank-item" style="border-left-color: ${corStatus};">
                <div class="rank-info" style="flex: 2;">
                  <div class="rank-nome">${produto.nome}</div>
                  <div class="rank-detalhes">
                    Lote: ${produto.lote} | Validade: ${formatarData(produto.validade)} | 
                    RUA ${produto.rua} - V√ÉO ${produto.vao} - N√çVEL ${produto.nivel} - PALLET ${produto.pallet}
                  </div>
                </div>
                <div class="rank-count" style="color: ${corStatus}; font-size: 1.1em;">${textoStatus}</div>
              </div>
            `;
          }).join('')
        : '<div style="text-align: center; padding: 40px; color: #999;">‚úÖ Nenhum produto com validade menor que 1 ano</div>';

      document.getElementById('dash-produtos-validade').innerHTML = htmlValidade;
      document.getElementById('modal-dashboard').classList.add('active');
    };

    document.getElementById('modal-dashboard-close').addEventListener('click', () => {
      document.getElementById('modal-dashboard').classList.remove('active');
    });
  </script>
</body>
</html>