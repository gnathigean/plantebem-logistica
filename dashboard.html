<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Recebimento - AGROEXPRESS</title>
  <link rel="stylesheet" href="/tema.css"> 
  
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
        /* Corrigido: CSS reestruturado para evitar quebra de sintaxe */

.dashboard-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
}
.kpi-card {
  background-color: #ffffff;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  text-align: center;
}
.kpi-title {
  font-size: 0.9em;
  color: #555;
  margin-bottom: 5px;
}
.kpi-value {
  font-size: 2em;
  font-weight: bold;
  color: #58c917; 
}
.insights-section {
  background-color: #ffffff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
  margin-bottom: 20px;
}
.chart-container {
  height: 300px;
  margin-top: 20px;
  margin-bottom: 20px;
}
.filter-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

/* Responsividade móvel */
@media (max-width: 600px) {
  .dashboard-container, .filter-controls {
grid-template-columns: 1fr;
  }
  .kpi-value {
font-size: 1.8em;
  }
}
  </style>
</head>
<body>

<div class="fixed-nav">
 <a id="menu-button" class="botao-menu" href="menu.html">← Menu</a> 
 <button id="logout-button">Sair</button>
</div>

<div class="logo-container">
 <img src="https://contagem.plantebemtec.com.br/Logotipo%20com%20Simbolo%20padrao.png" alt="Logo da Empresa" class="logo-img">
</div>

<div class="container"> 
 <h2>DASHBOARD DE RECEBIMENTO - <span style="color: red;">GERAL</span></h2>

  <p id="loading-dashboard">Carregando dados das lojas...</p>
  
  <div class="filter-controls" id="filter-controls" style="display: none;">
<select id="loja-filter">
  <option value="TODAS">TODAS AS LOJAS</option>
</select>
<select id="fornecedor-filter">
  <option value="TODOS">TODOS OS FORNECEDORES</option>
</select>
<select id="produto-filter">
  <option value="TODOS">TODOS OS PRODUTOS</option>
</select>
  </div>

  <div class="dashboard-container" id="kpi-display" style="display: none;">
        <div class="kpi-card">
            <div class="kpi-title">TOTAL DE REGISTROS</div>
            <div class="kpi-value" id="kpi-registros">0</div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-title">TOTAL RECUSADO</div>
            <div class="kpi-value" id="kpi-recusado" style="color: #e74c3c;">0</div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-title">TAXA DE RECUSA</div>
            <div class="kpi-value" id="kpi-taxa">0.0%</div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-title">MÉDIA DE DIAS P/ VENCIMENTO</div>
            <div class="kpi-value" id="kpi-validade">N/A</div>
        </div>
  </div>
  
  <div id="insights-container" style="display: none;">

<div class="insights-section">
  <h3>Visão Geral dos Problemas</h3>
  <div id="pie-chart-problemas" class="chart-container"></div>
</div>

<div class="insights-section">
  <h3>Detalhe dos Problemas e Causas</h3>
  <div id="detalhe-problemas">
<h4>1. Recusas e Avarias (Ocorrências)</h4>
<ul id="problemas-detalhados">
  </ul>
  </div>
</div>
  </div>
  
</div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    
    // 🔑 CREDENCIAIS FIREBASE (MANTIDAS) 🔑
    const firebaseConfig = { 
        apiKey: "AIzaSyD8GjaS3tuDpSvBl2-bpa-QXIKTqq80Mn4", 
        authDomain: "login-com-dados.firebaseapp.com",
        projectId: "login-com-dados",
        storageBucket: "login-com-dados.firebasestorage.app",
        messagingSenderId: "75556023458",
        appId: "1:75556023458:web:9f1362d0597603c0f37bfb",
        measurementId: "G-W9LRT99579"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // --- VARIÁVEIS DO DOM E URLs ---
    // ⚠️ SUBSTITUA ESTA URL PELA SUA URL DE IMPLANTAÇÃO MAIS RECENTE E CORRETA!
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz2Ty2Z_UM74Czl29ZSD_8_HFubBq8qYzBNRHAMpg7R1nJhWa-PeG81jD7BNi9_vCvk/exec'; 
    
    const loadingMessage = document.getElementById('loading-dashboard');
    const kpiDisplay = {
        registros: document.getElementById('kpi-registros'),
        recusado: document.getElementById('kpi-recusado'),
        taxa: document.getElementById('kpi-taxa'),
        validade: document.getElementById('kpi-validade'),
    };
    const insightsContainer = document.getElementById('insights-container');
    const filterControls = document.getElementById('filter-controls');
    
    const lojaFilter = document.getElementById('loja-filter');
    const fornecedorFilter = document.getElementById('fornecedor-filter');
    const produtoFilter = document.getElementById('produto-filter');
    
    let allData = []; // Armazena todos os dados de todas as lojas
    let currentData = []; // Dados sendo exibidos (após a filtragem)

    // 🔑 MAPA DE LOJAS (MANTIDO) 🔑
    const LOJAS_MAP = {
        'matriz': 'Matriz',
        'juazeiro': 'Filial Juazeiro',
        'loteamento': 'Filial Loteamento',
        'irece': 'Filial Irecê',
        'rioreal': 'Filial Rio Real',
        'agroexpress': 'Agroexpress',
        'grandesafra': 'Grande Safra'
    };
    const LOJAS_KEYS = Object.keys(LOJAS_MAP);


    // ====================================================================
    // 📊 FUNÇÕES DE CÁLCULO E RENDERIZAÇÃO 📊
    // ====================================================================

    function formatNumber(num) {
        return num.toLocaleString('pt-BR');
    }

    /**
     * Tenta obter o valor do item usando a chave fornecida, ignorando maiúsculas/minúsculas.
     * @param {Object} item - O objeto de dados da linha.
     * @param {string} keyName - A chave esperada (ex: 'produto').
     */
    function getCaseInsensitiveValue(item, keyName) {
        if (!item || !keyName) return null;
        const lowerKey = keyName.toLowerCase(); 
        for (const key in item) {
            if (key.toLowerCase() === lowerKey) {
                return item[key];
            }
        }
        return null;
    }

    // Função auxiliar para calcular dias entre duas datas
    function getDaysDifference(date1, date2) {
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return Math.floor((utc2 - utc1) / MS_PER_DAY);
    }

    // CORRIGIDO: Agora usa getCaseInsensitiveValue para todas as chaves de dados
    function calcularKpis(data) {
        const totalRegistros = data.length;
        
        if (totalRegistros === 0) {
            return {
                totalRegistros: 0, totalRecusado: 0, percentualRecusado: 0,
                mediaDiasValidade: 'N/A', contagemProblemas: {}, detalhesProblemas: {}
            };
        }

        let totalRecusado = 0;
        let totalDiasValidade = 0;
        let contagemValidade = 0;
        
        // Chaves do CheckList (baseadas no cabeçalho do Apps Script)
        const checklistKeys = ['FALTA', 'AVARIA', 'VENCIMENTO CURTO', 'NF DIVERGENCIA / CARGA', 'PRODUTO RECUSADO'];
        let contagemProblemas = Object.fromEntries(checklistKeys.map(key => [key, 0]));
        let detalhesProblemas = {};

        data.forEach(item => {
            // Obter dados cruciais ignorando maiúsculas/minúsculas
            const dataRecebimentoStr = getCaseInsensitiveValue(item, 'dataderecebimento');
            const dataValidadeStr = getCaseInsensitiveValue(item, 'validade');
            const produtoNome = getCaseInsensitiveValue(item, 'produto') || 'N/A';
            const fornecedorNome = getCaseInsensitiveValue(item, 'fornecedor') || 'N/A';
            const lote = getCaseInsensitiveValue(item, 'lote') || 'N/A';
            
            const dataRecebimento = new Date(dataRecebimentoStr);
            const dataValidade = new Date(dataValidadeStr);
            
            // CÁLCULO DE DIAS RESTANTES DE VALIDADE
            if (dataRecebimentoStr && dataValidadeStr && !isNaN(dataRecebimento.getTime()) && !isNaN(dataValidade.getTime())) {
                const diasRestantes = getDaysDifference(dataRecebimento, dataValidade);
                totalDiasValidade += diasRestantes;
                contagemValidade++;
            }
            
            // PRODUTO RECUSADO (usando a chave exata do checklist)
            const recusaValor = String(item['PRODUTO RECUSADO'] || 'Não');
            const recusaStatus = recusaValor.startsWith('Sim');
            if (recusaStatus) {
                totalRecusado++;
            }

            // Contagem dos problemas individuais
            checklistKeys.forEach(coluna => {
                // Obtém o valor do item, ignorando a capitalização para a busca inicial
                // mas tratando o valor como string para checar 'Sim:'
                const valor = String(getCaseInsensitiveValue(item, coluna) || 'Não'); 

                if (valor.startsWith('Sim')) {
                    contagemProblemas[coluna]++;
                    
                   // Adiciona a descrição ao detalhe
            if (valor.includes(':')) {
                const descricao = valor.split(':')[1].trim();
                if (descricao) {
                    detalhesProblemas[coluna] = detalhesProblemas[coluna] || [];
                    detalhesProblemas[coluna].push({
                        produto: produtoNome,
                        fornecedor: fornecedorNome,
                        lote: lote,
                        descricao: descricao
                    });
                        }
                    }
                }
            });
        });

        // KPls de Porcentagem
        const percentualRecusado = totalRegistros > 0 
            ? ((totalRecusado / totalRegistros) * 100).toFixed(1) 
            : 0;
            
        // CÁLCULO FINAL DA MÉDIA DE VALIDADE
        const mediaDiasValidade = contagemValidade > 0
            ? Math.round(totalDiasValidade / contagemValidade)
            : 'N/A';

        return {
            totalRegistros, totalRecusado, percentualRecusado,
            mediaDiasValidade, contagemProblemas, detalhesProblemas
        };
    }

    // RENDERIZA OS VALORES DENTRO DOS DIVs KPI existentes
    function renderKpis(kpis) {
        kpiDisplay.registros.textContent = formatNumber(kpis.totalRegistros);
        kpiDisplay.recusado.textContent = formatNumber(kpis.totalRecusado);
        kpiDisplay.taxa.textContent = `${kpis.percentualRecusado}%`;
        kpiDisplay.validade.textContent = kpis.mediaDiasValidade;
        
        document.querySelector('.dashboard-container').style.display = 'grid';
        insightsContainer.style.display = 'block';
    }


    function renderChartsAndDetails(kpis) {
        // --- GRÁFICO (Gráfico de Pizza para Problemas) ---
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);

        function drawChart() {
            const problemasData = [['Problema', 'Ocorrências']];
            Object.entries(kpis.contagemProblemas).forEach(([nome, contagem]) => {
                if (contagem > 0) {
                    problemasData.push([nome, contagem]);
                }
            });
            
            const dataTable = google.visualization.arrayToDataTable(problemasData);
            const options = {
                title: 'Distribuição dos Tipos de Problemas',
                pieHole: 0.4,
                colors: ['#f44336', '#ff9800', '#2196f3', '#4caf50', '#9c27b0']
            };

            const chart = new google.visualization.PieChart(document.getElementById('pie-chart-problemas'));
            chart.draw(dataTable, options);
        }

        // --- DETALHE DOS PROBLEMAS (MÉTRICAS DETALHADAS) ---
        const detalheProblemasDiv = document.getElementById('detalhe-problemas');
        let htmlDetalhe = '<h4>1. Recusas e Avarias (Ocorrências e Detalhes)</h4>';

        Object.keys(kpis.detalhesProblemas).forEach(problema => {
            const ocorrencias = kpis.detalhesProblemas[problema];
            if (ocorrencias.length > 0) {
                htmlDetalhe += `
                    <h5>${problema} (${ocorrencias.length} Ocorrência${ocorrencias.length > 1 ? 's' : ''}):</h5>
                    <ul style="list-style-type: none; padding-left: 0;">
                `;
                ocorrencias.forEach(detalhe => {
                    htmlDetalhe += `
                        <li style="margin-bottom: 5px; padding: 5px; border-left: 3px solid #f44336; background-color: #ffebee;">
                            Produto: ${detalhe.produto} | Fornecedor: ${detalhe.fornecedor} | Lote: ${detalhe.lote}<br>
                            Descrição: <strong>${detalhe.descricao}</strong>
                        </li>
                    `;
                });
                htmlDetalhe += `</ul>`;
            }
        });

        detalheProblemasDiv.innerHTML = htmlDetalhe;
    }


    // ====================================================================
    // ⚙️ LÓGICA DE FILTRAGEM ⚙️
    // ====================================================================

    // CORRIGIDO: Agora usa getCaseInsensitiveValue
    function populateFilters(data) {
        const fornecedores = new Set();
        const produtos = new Set();
        const fornecedorKey = 'fornecedor';
        const produtoKey = 'produto';

        data.forEach(item => {
            const forn = getCaseInsensitiveValue(item, fornecedorKey);
            const prod = getCaseInsensitiveValue(item, produtoKey);

            if (forn) fornecedores.add(forn);
            if (prod) produtos.add(prod);
        });

        // 1. Filtro de Loja (MANTIDO)
        Object.entries(LOJAS_MAP).forEach(([key, name]) => {
             if (!lojaFilter.querySelector(`option[value="${key}"]`)) {
                 const option = document.createElement('option');
                 option.value = key;
                 option.textContent = name;
                 lojaFilter.appendChild(option);
             }
        });

        // 2. Filtro de Fornecedor
        fornecedorFilter.innerHTML = '<option value="TODOS">TODOS OS FORNECEDORES</option>';
        Array.from(fornecedores).sort().forEach(forn => {
            fornecedorFilter.innerHTML += `<option value="${forn}">${forn}</option>`;
        });

        // 3. Filtro de Produto
        produtoFilter.innerHTML = '<option value="TODOS">TODOS OS PRODUTOS</option>';
        Array.from(produtos).sort().forEach(prod => {
            produtoFilter.innerHTML += `<option value="${prod}">${prod}</option>`;
        });
        
        filterControls.style.display = 'grid';
    }

    function applyFilters() {
        const lojaSelecionada = lojaFilter.value;
        const fornecedorSelecionado = fornecedorFilter.value;
        const produtoSelecionado = produtoFilter.value;

        let filteredData = allData;
        
        // 1. Filtrar por Loja
        if (lojaSelecionada !== 'TODAS') {
            filteredData = filteredData.filter(item => item.LOJA === lojaSelecionada);
        }

        // 2. Filtrar por Fornecedor
        if (fornecedorSelecionado !== 'TODOS') {
            filteredData = filteredData.filter(item => {
                const forn = getCaseInsensitiveValue(item, 'fornecedor');
                // Usamos toUpperCase para garantir que 'TODOS OS FORNECEDORES' não seja comparado com 'todos os fornecedores'
                return forn && String(forn).toUpperCase() === fornecedorSelecionado.toUpperCase();
            });
        }

        // 3. Filtrar por Produto
        if (produtoSelecionado !== 'TODOS') {
            filteredData = filteredData.filter(item => {
                const prod = getCaseInsensitiveValue(item, 'produto');
                return prod && String(prod).toUpperCase() === produtoSelecionado.toUpperCase();
            });
        }

        currentData = filteredData;
        
        // Recalcular e renderizar KPls e Gráficos
        const kpis = calcularKpis(currentData);
        renderKpis(kpis);
        renderChartsAndDetails(kpis);
    }
    
    // Adiciona Listeners aos filtros
    lojaFilter.addEventListener('change', applyFilters);
    fornecedorFilter.addEventListener('change', applyFilters);
    produtoFilter.addEventListener('change', applyFilters);


    // ====================================================================
    // 🌐 FUNÇÃO DE FETCH GLOBAL (BUSCA DADOS DE TODAS AS LOJAS) 🌐
    // ====================================================================

    async function fetchDataAllStores() {
        loadingMessage.textContent = 'Buscando dados das 7 lojas...';
        
        const fetchPromises = LOJAS_KEYS.map(lojaKey => {
            const fetchUrl = `${APPS_SCRIPT_URL}?loja=${lojaKey}`;
            return fetch(fetchUrl)
                .then(response => response.json())
                .catch(error => {
                    // Erro de rede ou JSON (mais comum)
                    console.error(`Erro ao buscar dados da loja ${lojaKey}:`, error);
                    return []; 
                });
        });

        const results = await Promise.all(fetchPromises);
        let combinedData = [];

        results.forEach(result => {
            // Adiciona apenas se o resultado for um array válido
            if (Array.isArray(result)) {
                combinedData.push(...result);
            } else if (result && result.resultado === "erro") {
                // Se o Apps Script retornou um erro JSON (ex: planilha não encontrada)
                console.error("Erro do Apps Script:", result.mensagem);
                loadingMessage.textContent = `Erro ao carregar dados: ${result.mensagem}. Verifique as URLs das planilhas.`;
                loadingMessage.style.display = 'block'; // Garante que a mensagem de erro seja visível
            }
        });

        return combinedData;
    }

    async function initializeDashboard() {
        
        // Garante que o loading message apareça antes do fetch
        loadingMessage.style.display = 'block'; 
        
        allData = await fetchDataAllStores();
        
        // Se não houve erro fatal (a mensagem de erro foi tratada no fetchDataAllStores)
        if (loadingMessage.textContent === 'Buscando dados das 7 lojas...') {
            loadingMessage.style.display = 'none'; 
        }

        if (allData.length === 0) {
            // Se a mensagem não foi definida como erro, assume que não há dados
            if (loadingMessage.textContent === 'Buscando dados das 7 lojas...') {
                loadingMessage.textContent = 'Nenhum dado encontrado em todas as lojas para análise.';
            }
            loadingMessage.style.display = 'block';
            return;
        }
        
        populateFilters(allData);
        applyFilters(); // Aplica os filtros iniciais ('TODAS' as lojas)
    }

    // --- INICIALIZAÇÃO ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            initializeDashboard();
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.style.display = 'inline-block';
            }
        } else {
            window.location.href = 'index.html'; 
        }
    });

    // --- FUNCIONALIDADE DE LOGOUT ---
    document.getElementById('logout-button').addEventListener('click', () => {
        signOut(auth).then(() => {
            window.location.href = 'index.html';
        }).catch(error => {
            console.error("Erro ao deslogar:", error);
            alert("Erro ao sair. Tente novamente.");
        });
    });

</script>
</body>
</html>