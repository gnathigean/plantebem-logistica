<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Recebimento - AGROEXPRESS</title>
  <link rel="stylesheet" href="/tema.css"> 
  
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
        /* Corrigido: CSS reestruturado para evitar quebra de sintaxe */

.dashboard-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
}
.kpi-card {
  background-color: #ffffff;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  text-align: center;
}
.kpi-title {
  font-size: 0.9em;
  color: #555;
  margin-bottom: 5px;
}
.kpi-value {
  font-size: 2em;
  font-weight: bold;
  color: #58c917; 
}
.insights-section {
  background-color: #ffffff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
  margin-bottom: 20px;
}
.chart-container {
  height: 300px;
  margin-top: 20px;
  margin-bottom: 20px;
}
.filter-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

/* Responsividade mÃ³vel */
@media (max-width: 600px) {
  .dashboard-container, .filter-controls {
grid-template-columns: 1fr;
  }
  .kpi-value {
font-size: 1.8em;
  }
}
  </style>
</head>
<body>

<div class="fixed-nav">
 <a id="menu-button" class="botao-menu" href="menu.html">â† Menu</a> 
 <button id="logout-button">Sair</button>
</div>

<div class="logo-container">
 <img src="https://contagem.plantebemtec.com.br/Logotipo%20com%20Simbolo%20padrao.png" alt="Logo da Empresa" class="logo-img">
</div>

<div class="container"> 
 <h2>DASHBOARD DE RECEBIMENTO - <span style="color: red;">GERAL</span></h2>

  <p id="loading-dashboard">Carregando dados das lojas...</p>
  
  <div class="filter-controls" id="filter-controls" style="display: none;">
<select id="loja-filter">
  <option value="TODAS">TODAS AS LOJAS</option>
</select>
<select id="fornecedor-filter">
  <option value="TODOS">TODOS OS FORNECEDORES</option>
</select>
<select id="produto-filter">
  <option value="TODOS">TODOS OS PRODUTOS</option>
</select>
  </div>

  <div class="dashboard-container" id="kpi-display" style="display: none;">
        <div class="kpi-card">
            <div class="kpi-title">TOTAL DE REGISTROS</div>
            <div class="kpi-value" id="kpi-registros">0</div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-title">TOTAL RECUSADO</div>
            <div class="kpi-value" id="kpi-recusado" style="color: #e74c3c;">0</div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-title">TAXA DE RECUSA</div>
            <div class="kpi-value" id="kpi-taxa">0.0%</div>
        </div>
        
        <div class="kpi-card">
            <div class="kpi-title">MÃ‰DIA DE DIAS P/ VENCIMENTO</div>
            <div class="kpi-value" id="kpi-validade">N/A</div>
        </div>
  </div>
  
  <div id="insights-container" style="display: none;">

<div class="insights-section">
  <h3>VisÃ£o Geral dos Problemas</h3>
  <div id="pie-chart-problemas" class="chart-container"></div>
</div>

<div class="insights-section">
  <h3>Detalhe dos Problemas e Causas</h3>
  <div id="detalhe-problemas">
<h4>1. Recusas e Avarias (OcorrÃªncias)</h4>
<ul id="problemas-detalhados">
  </ul>
  </div>
</div>
  </div>
  
</div>

<script type="module">
Â  Â  // --- FIREBASE IMPORTS ---
Â  Â  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
Â  Â  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
Â  Â  
    // ğŸ”‘ CREDENCIAIS FIREBASE (MANTIDAS) ğŸ”‘
    const firebaseConfig = { 
        apiKey: "AIzaSyD8GjaS3tuDpSvBl2-bpa-QXIKTqq80Mn4", 
        authDomain: "login-com-dados.firebaseapp.com",
        projectId: "login-com-dados",
        storageBucket: "login-com-dados.firebasestorage.app",
        messagingSenderId: "75556023458",
        appId: "1:75556023458:web:9f1362d0597603c0f37bfb",
        measurementId: "G-W9LRT99579"
    };
    
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const auth = getAuth(app);
Â  Â  
Â  Â  // --- VARIÃVEIS DO DOM E URLs ---
    // âš ï¸ SUBSTITUA ESTA URL PELA SUA URL DE IMPLANTAÃ‡ÃƒO MAIS RECENTE E CORRETA!
Â  Â  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz2Ty2Z_UM74Czl29ZSD_8_HFubBq8qYzBNRHAMpg7R1nJhWa-PeG81jD7BNi9_vCvk/exec'; 
Â  Â  
Â  Â  const loadingMessage = document.getElementById('loading-dashboard');
    const kpiDisplay = {
        registros: document.getElementById('kpi-registros'),
        recusado: document.getElementById('kpi-recusado'),
        taxa: document.getElementById('kpi-taxa'),
        validade: document.getElementById('kpi-validade'),
    };
Â  Â  const insightsContainer = document.getElementById('insights-container');
Â  Â  const filterControls = document.getElementById('filter-controls');
Â  Â  
Â  Â  const lojaFilter = document.getElementById('loja-filter');
Â  Â  const fornecedorFilter = document.getElementById('fornecedor-filter');
Â  Â  const produtoFilter = document.getElementById('produto-filter');
Â  Â  
Â  Â  let allData = []; // Armazena todos os dados de todas as lojas
Â  Â  let currentData = []; // Dados sendo exibidos (apÃ³s a filtragem)

    // ğŸ”‘ MAPA DE LOJAS (MANTIDO) ğŸ”‘
Â  Â  const LOJAS_MAP = {
Â  Â  Â  Â  'matriz': 'Matriz',
Â  Â  Â  Â  'juazeiro': 'Filial Juazeiro',
Â  Â  Â  Â  'loteamento': 'Filial Loteamento',
Â  Â  Â  Â  'irece': 'Filial IrecÃª',
Â  Â  Â  Â  'rioreal': 'Filial Rio Real',
Â  Â  Â  Â  'agroexpress': 'Agroexpress',
Â  Â  Â  Â  'grandesafra': 'Grande Safra'
Â  Â  };
Â  Â  const LOJAS_KEYS = Object.keys(LOJAS_MAP);


Â  Â  // ====================================================================
Â  Â  // ğŸ“Š FUNÃ‡Ã•ES DE CÃLCULO E RENDERIZAÃ‡ÃƒO ğŸ“Š
Â  Â  // ====================================================================

Â  Â  function formatNumber(num) {
Â  Â  Â  Â  return num.toLocaleString('pt-BR');
Â  Â  }

    /**
     * Tenta obter o valor do item usando a chave fornecida, ignorando maiÃºsculas/minÃºsculas.
     * @param {Object} item - O objeto de dados da linha.
     * @param {string} keyName - A chave esperada (ex: 'produto').
     */
    function getCaseInsensitiveValue(item, keyName) {
        if (!item || !keyName) return null;
        const lowerKey = keyName.toLowerCase(); 
        for (const key in item) {
            if (key.toLowerCase() === lowerKey) {
                return item[key];
            }
        }
        return null;
    }

Â  Â  // FunÃ§Ã£o auxiliar para calcular dias entre duas datas
Â  Â  function getDaysDifference(date1, date2) {
Â  Â  Â  Â  const MS_PER_DAY = 1000 * 60 * 60 * 24;
Â  Â  Â  Â  const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
Â  Â  Â  Â  const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
Â  Â  Â  Â  return Math.floor((utc2 - utc1) / MS_PER_DAY);
Â  Â  }

    // CORRIGIDO: Agora usa getCaseInsensitiveValue para todas as chaves de dados
Â  Â  function calcularKpis(data) {
Â  Â  Â  Â  const totalRegistros = data.length;
Â  Â  Â  Â  
Â  Â  Â  Â  if (totalRegistros === 0) {
            return {
                totalRegistros: 0, totalRecusado: 0, percentualRecusado: 0,
                mediaDiasValidade: 'N/A', contagemProblemas: {}, detalhesProblemas: {}
            };
        }

Â  Â  Â  Â  let totalRecusado = 0;
Â  Â  Â  Â  let totalDiasValidade = 0;
Â  Â  Â  Â  let contagemValidade = 0;
Â  Â  Â  Â  
        // Chaves do CheckList (baseadas no cabeÃ§alho do Apps Script)
Â  Â  Â  Â  const checklistKeys = ['FALTA', 'AVARIA', 'VENCIMENTO CURTO', 'NF DIVERGENCIA / CARGA', 'PRODUTO RECUSADO'];
Â  Â  Â  Â  let contagemProblemas = Object.fromEntries(checklistKeys.map(key => [key, 0]));
Â  Â  Â  Â  let detalhesProblemas = {};

Â  Â  Â  Â  data.forEach(item => {
            // Obter dados cruciais ignorando maiÃºsculas/minÃºsculas
            const dataRecebimentoStr = getCaseInsensitiveValue(item, 'dataderecebimento');
            const dataValidadeStr = getCaseInsensitiveValue(item, 'validade');
            const produtoNome = getCaseInsensitiveValue(item, 'produto') || 'N/A';
            const fornecedorNome = getCaseInsensitiveValue(item, 'fornecedor') || 'N/A';
            const lote = getCaseInsensitiveValue(item, 'lote') || 'N/A';
            
Â  Â  Â  Â  Â  Â  const dataRecebimento = new Date(dataRecebimentoStr);
Â  Â  Â  Â  Â  Â  const dataValidade = new Date(dataValidadeStr);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // CÃLCULO DE DIAS RESTANTES DE VALIDADE
Â  Â  Â  Â  Â  Â  if (dataRecebimentoStr && dataValidadeStr && !isNaN(dataRecebimento.getTime()) && !isNaN(dataValidade.getTime())) {
Â  Â  Â  Â  Â  Â  Â  Â  const diasRestantes = getDaysDifference(dataRecebimento, dataValidade);
Â  Â  Â  Â  Â  Â  Â  Â  totalDiasValidade += diasRestantes;
Â  Â  Â  Â  Â  Â  Â  Â  contagemValidade++;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
            // PRODUTO RECUSADO (usando a chave exata do checklist)
            const recusaValor = String(item['PRODUTO RECUSADO'] || 'NÃ£o');
Â  Â  Â  Â  Â  Â  const recusaStatus = recusaValor.startsWith('Sim');
Â  Â  Â  Â  Â  Â  if (recusaStatus) {
Â  Â  Â  Â  Â  Â  Â  Â  totalRecusado++;
Â  Â  Â  Â  Â  Â  }

            // Contagem dos problemas individuais
Â  Â  Â  Â  Â  Â  checklistKeys.forEach(coluna => {
                // ObtÃ©m o valor do item, ignorando a capitalizaÃ§Ã£o para a busca inicial
                // mas tratando o valor como string para checar 'Sim:'
                const valor = String(getCaseInsensitiveValue(item, coluna) || 'NÃ£o'); 

Â  Â  Â  Â  Â  Â  Â  Â  if (valor.startsWith('Sim')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contagemProblemas[coluna]++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Adiciona a descriÃ§Ã£o ao detalhe
            if (valor.includes(':')) {
                const descricao = valor.split(':')[1].trim();
                if (descricao) {
                    detalhesProblemas[coluna] = detalhesProblemas[coluna] || [];
                    detalhesProblemas[coluna].push({
                        produto: produtoNome,
                        fornecedor: fornecedorNome,
                        lote: lote,
                        descricao: descricao
                    });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  // KPls de Porcentagem
Â  Â  Â  Â  const percentualRecusado = totalRegistros > 0 
Â  Â  Â  Â  Â  Â  ? ((totalRecusado / totalRegistros) * 100).toFixed(1) 
Â  Â  Â  Â  Â  Â  : 0;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  // CÃLCULO FINAL DA MÃ‰DIA DE VALIDADE
Â  Â  Â  Â  const mediaDiasValidade = contagemValidade > 0
Â  Â  Â  Â  Â  Â  ? Math.round(totalDiasValidade / contagemValidade)
Â  Â  Â  Â  Â  Â  : 'N/A';

Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  totalRegistros, totalRecusado, percentualRecusado,
Â  Â  Â  Â  Â  Â  mediaDiasValidade, contagemProblemas, detalhesProblemas
Â  Â  Â  Â  };
Â  Â  }

    // RENDERIZA OS VALORES DENTRO DOS DIVs KPI existentes
Â  Â  function renderKpis(kpis) {
        kpiDisplay.registros.textContent = formatNumber(kpis.totalRegistros);
        kpiDisplay.recusado.textContent = formatNumber(kpis.totalRecusado);
        kpiDisplay.taxa.textContent = `${kpis.percentualRecusado}%`;
        kpiDisplay.validade.textContent = kpis.mediaDiasValidade;
        
        document.querySelector('.dashboard-container').style.display = 'grid';
Â  Â  Â  Â  insightsContainer.style.display = 'block';
Â  Â  }


Â  Â  function renderChartsAndDetails(kpis) {
Â  Â  Â  Â  // --- GRÃFICO (GrÃ¡fico de Pizza para Problemas) ---
Â  Â  Â  Â  google.charts.load('current', {'packages':['corechart']});
Â  Â  Â  Â  google.charts.setOnLoadCallback(drawChart);

Â  Â  Â  Â  function drawChart() {
Â  Â  Â  Â  Â  Â  const problemasData = [['Problema', 'OcorrÃªncias']];
Â  Â  Â  Â  Â  Â  Object.entries(kpis.contagemProblemas).forEach(([nome, contagem]) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (contagem > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  problemasData.push([nome, contagem]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const dataTable = google.visualization.arrayToDataTable(problemasData);
Â  Â  Â  Â  Â  Â  const options = {
Â  Â  Â  Â  Â  Â  Â  Â  title: 'DistribuiÃ§Ã£o dos Tipos de Problemas',
Â  Â  Â  Â  Â  Â  Â  Â  pieHole: 0.4,
Â  Â  Â  Â  Â  Â  Â  Â  colors: ['#f44336', '#ff9800', '#2196f3', '#4caf50', '#9c27b0']
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const chart = new google.visualization.PieChart(document.getElementById('pie-chart-problemas'));
Â  Â  Â  Â  Â  Â  chart.draw(dataTable, options);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- DETALHE DOS PROBLEMAS (MÃ‰TRICAS DETALHADAS) ---
Â  Â  Â  Â  const detalheProblemasDiv = document.getElementById('detalhe-problemas');
Â  Â  Â  Â  let htmlDetalhe = '<h4>1. Recusas e Avarias (OcorrÃªncias e Detalhes)</h4>';

Â  Â  Â  Â  Object.keys(kpis.detalhesProblemas).forEach(problema => {
Â  Â  Â  Â  Â  Â  const ocorrencias = kpis.detalhesProblemas[problema];
Â  Â  Â  Â  Â  Â  if (ocorrencias.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  htmlDetalhe += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5>${problema} (${ocorrencias.length} OcorrÃªncia${ocorrencias.length > 1 ? 's' : ''}):</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul style="list-style-type: none; padding-left: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  ocorrencias.forEach(detalhe => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  htmlDetalhe += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li style="margin-bottom: 5px; padding: 5px; border-left: 3px solid #f44336; background-color: #ffebee;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Produto: ${detalhe.produto} | Fornecedor: ${detalhe.fornecedor} | Lote: ${detalhe.lote}<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  DescriÃ§Ã£o: <strong>${detalhe.descricao}</strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  htmlDetalhe += `</ul>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  detalheProblemasDiv.innerHTML = htmlDetalhe;
Â  Â  }


Â  Â  // ====================================================================
Â  Â  // âš™ï¸ LÃ“GICA DE FILTRAGEM âš™ï¸
Â  Â  // ====================================================================

    // CORRIGIDO: Agora usa getCaseInsensitiveValue
Â  Â  function populateFilters(data) {
Â  Â  Â  Â  const fornecedores = new Set();
Â  Â  Â  Â  const produtos = new Set();
        const fornecedorKey = 'fornecedor';
        const produtoKey = 'produto';

Â  Â  Â  Â  data.forEach(item => {
            const forn = getCaseInsensitiveValue(item, fornecedorKey);
            const prod = getCaseInsensitiveValue(item, produtoKey);

Â  Â  Â  Â  Â  Â  if (forn) fornecedores.add(forn);
Â  Â  Â  Â  Â  Â  if (prod) produtos.add(prod);
Â  Â  Â  Â  });

Â  Â  Â  Â  // 1. Filtro de Loja (MANTIDO)
Â  Â  Â  Â  Object.entries(LOJAS_MAP).forEach(([key, name]) => {
Â  Â  Â  Â  Â  Â  Â if (!lojaFilter.querySelector(`option[value="${key}"]`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  Â option.value = key;
Â  Â  Â  Â  Â  Â  Â  Â  Â option.textContent = name;
Â  Â  Â  Â  Â  Â  Â  Â  Â lojaFilter.appendChild(option);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  });

Â  Â  Â  Â  // 2. Filtro de Fornecedor
Â  Â  Â  Â  fornecedorFilter.innerHTML = '<option value="TODOS">TODOS OS FORNECEDORES</option>';
Â  Â  Â  Â  Array.from(fornecedores).sort().forEach(forn => {
Â  Â  Â  Â  Â  Â  fornecedorFilter.innerHTML += `<option value="${forn}">${forn}</option>`;
Â  Â  Â  Â  });

Â  Â  Â  Â  // 3. Filtro de Produto
Â  Â  Â  Â  produtoFilter.innerHTML = '<option value="TODOS">TODOS OS PRODUTOS</option>';
Â  Â  Â  Â  Array.from(produtos).sort().forEach(prod => {
Â  Â  Â  Â  Â  Â  produtoFilter.innerHTML += `<option value="${prod}">${prod}</option>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  filterControls.style.display = 'grid';
Â  Â  }

Â  Â  function applyFilters() {
Â  Â  Â  Â  const lojaSelecionada = lojaFilter.value;
Â  Â  Â  Â  const fornecedorSelecionado = fornecedorFilter.value;
Â  Â  Â  Â  const produtoSelecionado = produtoFilter.value;

Â  Â  Â  Â  let filteredData = allData;
Â  Â  Â  Â  
Â  Â  Â  Â  // 1. Filtrar por Loja
Â  Â  Â  Â  if (lojaSelecionada !== 'TODAS') {
Â  Â  Â  Â  Â  Â  filteredData = filteredData.filter(item => item.LOJA === lojaSelecionada);
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Filtrar por Fornecedor
Â  Â  Â  Â  if (fornecedorSelecionado !== 'TODOS') {
Â  Â  Â  Â  Â  Â  filteredData = filteredData.filter(item => {
                const forn = getCaseInsensitiveValue(item, 'fornecedor');
                // Usamos toUpperCase para garantir que 'TODOS OS FORNECEDORES' nÃ£o seja comparado com 'todos os fornecedores'
                return forn && String(forn).toUpperCase() === fornecedorSelecionado.toUpperCase();
            });
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. Filtrar por Produto
Â  Â  Â  Â  if (produtoSelecionado !== 'TODOS') {
Â  Â  Â  Â  Â  Â  filteredData = filteredData.filter(item => {
                const prod = getCaseInsensitiveValue(item, 'produto');
                return prod && String(prod).toUpperCase() === produtoSelecionado.toUpperCase();
            });
Â  Â  Â  Â  }

Â  Â  Â  Â  currentData = filteredData;
Â  Â  Â  Â  
Â  Â  Â  Â  // Recalcular e renderizar KPls e GrÃ¡ficos
Â  Â  Â  Â  const kpis = calcularKpis(currentData);
Â  Â  Â  Â  renderKpis(kpis);
Â  Â  Â  Â  renderChartsAndDetails(kpis);
Â  Â  }
Â  Â  
Â  Â  // Adiciona Listeners aos filtros
Â  Â  lojaFilter.addEventListener('change', applyFilters);
Â  Â  fornecedorFilter.addEventListener('change', applyFilters);
Â  Â  produtoFilter.addEventListener('change', applyFilters);


Â  Â  // ====================================================================
Â  Â  // ğŸŒ FUNÃ‡ÃƒO DE FETCH GLOBAL (BUSCA DADOS DE TODAS AS LOJAS) ğŸŒ
Â  Â  // ====================================================================

Â  Â  async function fetchDataAllStores() {
Â  Â  Â  Â  loadingMessage.textContent = 'Buscando dados das 7 lojas...';
Â  Â  Â  Â  
Â  Â  Â  Â  const fetchPromises = LOJAS_KEYS.map(lojaKey => {
Â  Â  Â  Â  Â  Â  const fetchUrl = `${APPS_SCRIPT_URL}?loja=${lojaKey}`;
Â  Â  Â  Â  Â  Â  return fetch(fetchUrl)
Â  Â  Â  Â  Â  Â  Â  Â  .then(response => response.json())
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Erro de rede ou JSON (mais comum)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Erro ao buscar dados da loja ${lojaKey}:`, error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return []; 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  const results = await Promise.all(fetchPromises);
Â  Â  Â  Â  let combinedData = [];

Â  Â  Â  Â  results.forEach(result => {
Â  Â  Â  Â  Â  Â  // Adiciona apenas se o resultado for um array vÃ¡lido
Â  Â  Â  Â  Â  Â  if (Array.isArray(result)) {
Â  Â  Â  Â  Â  Â  Â  Â  combinedData.push(...result);
Â  Â  Â  Â  Â  Â  } else if (result && result.resultado === "erro") {
                // Se o Apps Script retornou um erro JSON (ex: planilha nÃ£o encontrada)
                console.error("Erro do Apps Script:", result.mensagem);
                loadingMessage.textContent = `Erro ao carregar dados: ${result.mensagem}. Verifique as URLs das planilhas.`;
                loadingMessage.style.display = 'block'; // Garante que a mensagem de erro seja visÃ­vel
            }
Â  Â  Â  Â  });

Â  Â  Â  Â  return combinedData;
Â  Â  }

Â  Â  async function initializeDashboard() {
Â  Â  Â  Â  
Â  Â  Â  Â  // Garante que o loading message apareÃ§a antes do fetch
Â  Â  Â  Â  loadingMessage.style.display = 'block'; 
        
Â  Â  Â  Â  allData = await fetchDataAllStores();
Â  Â  Â  Â  
Â  Â  Â  Â  // Se nÃ£o houve erro fatal (a mensagem de erro foi tratada no fetchDataAllStores)
        if (loadingMessage.textContent === 'Buscando dados das 7 lojas...') {
Â  Â  Â  Â  Â  Â  loadingMessage.style.display = 'none'; 
        }

Â  Â  Â  Â  if (allData.length === 0) {
            // Se a mensagem nÃ£o foi definida como erro, assume que nÃ£o hÃ¡ dados
            if (loadingMessage.textContent === 'Buscando dados das 7 lojas...') {
Â  Â  Â  Â  Â  Â      loadingMessage.textContent = 'Nenhum dado encontrado em todas as lojas para anÃ¡lise.';
            }
Â  Â  Â  Â  Â  Â  loadingMessage.style.display = 'block';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  populateFilters(allData);
Â  Â  Â  Â  applyFilters(); // Aplica os filtros iniciais ('TODAS' as lojas)
Â  Â  }

Â  Â  // --- INICIALIZAÃ‡ÃƒO ---
Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  initializeDashboard();
Â  Â  Â  Â  Â  Â  const logoutButton = document.getElementById('logout-button');
Â  Â  Â  Â  Â  Â  if (logoutButton) {
Â  Â  Â  Â  Â  Â  Â  Â  logoutButton.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  window.location.href = 'index.html'; 
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- FUNCIONALIDADE DE LOGOUT ---
Â  Â  document.getElementById('logout-button').addEventListener('click', () => {
Â  Â  Â  Â  signOut(auth).then(() => {
Â  Â  Â  Â  Â  Â  window.location.href = 'index.html';
Â  Â  Â  Â  }).catch(error => {
Â  Â  Â  Â  Â  Â  console.error("Erro ao deslogar:", error);
Â  Â  Â  Â  Â  Â  alert("Erro ao sair. Tente novamente.");
Â  Â  Â  Â  });
Â  Â  });

</script>
</body>
</html>