<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Executivo - Gest√£o de Validade</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        
        /* ‚ú® NOVO: Estilos para o Bot√£o de Menu Fixo */
        .fixed-nav {
            position: fixed;
            top: 35px;
            right: 35px;
            z-index: 1001; /* Garante que fique acima de outros elementos */
        }

        .btn-menu {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #ffffff, #ffffff);
            color: rgb(0, 0, 0);
            text-decoration: none;
        }

        .btn-menu:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        /* Fim dos novos estilos */
        
        .container { max-width: 1920px; margin: 0 auto; }
        .header { background: white; border-radius: 20px; padding: 24px 32px; margin-bottom: 24px; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header-title { font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
        .header-subtitle { color: #475569; font-size: 14px; }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .btn-secondary { background: white; color: #334155; border: 2px solid #e2e8f0; }
        .btn-secondary:hover { background: #f1f5f9; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); transition: all 0.3s; position: relative; overflow: hidden; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #6366f1, #8b5cf6); }
        .kpi-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; background: linear-gradient(135deg, #6366f1, #4f46e5); margin-bottom: 16px; }
        .kpi-label { font-size: 14px; font-weight: 600; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .kpi-value { font-size: 36px; font-weight: 800; color: #1e293b; margin: 12px 0; }
        .table-container { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .table-title { font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; color: #334155; padding: 16px; text-align: left; font-weight: 600; font-size: 14px; text-transform: uppercase; }
        td { padding: 16px; border-bottom: 1px solid #e2e8f0; color: #475569; }
        tr:hover { background: #f8fafc; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .status-badge.expired { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .status-badge.critical { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .status-badge.warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .status-badge.ok { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .year-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .year-badge.less { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .year-badge.equal { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .year-badge.more { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-content { background: white; padding: 40px; border-radius: 20px; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ‚ú® NOVO: Ajuste para telas menores */
        @media (max-width: 768px) {
            .fixed-nav {
                top: 15px;
                right: 15px;
            }
            .btn-menu {
                padding: 10px 18px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Carregando Dashboard...</h3>
            <p style="color: #475569; margin-top: 12px;">Conectando ao Google Sheets</p>
        </div>
    </div>
    
    <div class="fixed-nav">
        <a href="menu.html" class="btn-menu">
            <i class="fas fa-home"></i> Menu
        </a>
        <button class="btn btn-secondary" onclick="exportData()">
                    <i class="fas fa-file-export"></i> Exportar
                </button>
    </div>

    <div class="container">
        <div class="header">
            <div>
                <h1 class="header-title">Dashboard Executivo</h1>
                <p class="header-subtitle" id="lastUpdate">Sistema de Gest√£o de Validade de Produtos</p>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
        </div>

        <div class="kpi-grid" id="kpiGrid"></div>

        <div class="table-container">
            <div class="table-title">üìã Produtos por Validade</div>
            <table>
                <thead>
                    <tr>
                        <th>üè¢ Loja</th>
                        <th>üì¶ Produto</th>
                        <th>üè≠ Fornecedor</th>
                        <th>üî¢ Lote</th>
                        <th>üìÖ Fabrica√ß√£o</th>
                        <th>‚è∞ Validade</th>
                        <th>‚è≥ Dias Restantes</th>
                        <th>üìä Classifica√ß√£o</th>
                        <th>üö¶ Status</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwLStAEVzVTEQbBcy8_TCFscABUy5rM1n-CNM4fiABnQ3vGeB-4a_uss8P7rQm2iuUE/exec';
        let allData = [];
        let filteredData = [];

        window.addEventListener('load', initDashboard);

        async function initDashboard() {
            try {
                await loadData();
                hideLoading();
            } catch (error) {
                console.error('Erro:', error);
                alert('ERRO: ' + error.message);
                hideLoading();
            }
        }

        async function loadData() {
            try {
                showLoading();
                console.log('Fazendo requisi√ß√£o para:', API_URL);
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);

                const result = await response.json();
                console.log('Resposta recebida:', result);

                let rawData = [];

                if (result && result.success === true && Array.isArray(result.data)) {
                    console.log('‚úÖ Formato NOVO detectado');
                    rawData = result.data;
                } else if (result && typeof result === 'object') {
                    console.log('‚ö†Ô∏è Formato ANTIGO detectado - convertendo...');
                    Object.keys(result).forEach(sheetName => {
                        const sheetData = result[sheetName];
                        if (Array.isArray(sheetData)) {
                            sheetData.forEach(item => {
                                rawData.push({
                                    Loja: item['LOCAL DE DESCARGA'] || sheetName,
                                    Produto: item['PRODUTO'] || '',
                                    Fornecedor: item['FORNECEDOR'] || '',
                                    Lote: item['LOTE'] || '',
                                    Fabrica√ß√£o: item['FABRICA√á√ÉO'] || '',
                                    Validade: item['VALIDADE'] || '',
                                    _aba: sheetName
                                });
                            });
                        }
                    });
                    console.log('‚úÖ Convertido:', rawData.length, 'registros');
                }

                if (rawData.length === 0) throw new Error('Nenhum dado encontrado');

                allData = processData(rawData);
                filteredData = [...allData];

                console.log('üìä Dados processados:', allData.length, 'produtos');

                updateDashboard();
                updateLastUpdateTime();
                hideLoading();

            } catch (error) {
                console.error('‚ùå Erro:', error);
                throw error;
            }
        }

        function processData(data) {
            const hoje = new Date();
            const oneYear = 365;

            return data.map(item => {
                let fabricacao = parseDate(item.Fabrica√ß√£o || item['FABRICA√á√ÉO'] || '');
                let validade = parseDate(item.Validade || item['VALIDADE'] || '');

                const diasRestantes = Math.floor((validade - hoje) / (1000 * 60 * 60 * 24));

                let yearClass = 'more';
                if (diasRestantes < 0) {
                    yearClass = 'less';
                } else if (diasRestantes < oneYear) {
                    yearClass = 'less';
                } else if (diasRestantes >= oneYear && diasRestantes <= oneYear + 30) {
                    yearClass = 'equal';
                } else {
                    yearClass = 'more';
                }

                return {
                    loja: item.Loja || '',
                    produto: item.Produto || item['PRODUTO'] || '',
                    fornecedor: item.Fornecedor || item['FORNECEDOR'] || '',
                    lote: String(item.Lote || item['LOTE'] || ''),
                    fabricacao: fabricacao,
                    validade: validade,
                    diasRestantes: diasRestantes,
                    status: getStatus(diasRestantes),
                    yearClass: yearClass,
                    aba: item._aba || ''
                };
            }).filter(item => item.produto);
        }

        function parseDate(dateValue) {
            if (!dateValue) return new Date();
            if (dateValue instanceof Date) return dateValue;

            if (typeof dateValue === 'string') {
                if (dateValue.includes('/')) {
                    const [day, month, year] = dateValue.split('/');
                    return new Date(year, month - 1, day);
                }
                if (dateValue.includes('-')) {
                    return new Date(dateValue);
                }
            }

            if (typeof dateValue === 'number') {
                return new Date((dateValue - 25569) * 86400 * 1000);
            }

            return new Date(dateValue);
        }

        function getStatus(dias) {
            if (dias < 0) return 'expired';
            if (dias <= 30) return 'critical';
            if (dias <= 90) return 'warning';
            return 'ok';
        }

        function updateDashboard() {
            console.log('üìä Atualizando dashboard');

            const total = filteredData.length;
            const vencidos = filteredData.filter(p => p.status === 'expired').length;
            const critico = filteredData.filter(p => p.status === 'critical').length;
            const alerta = filteredData.filter(p => p.status === 'warning').length;
            const normal = filteredData.filter(p => p.status === 'ok').length;

            const yearLess = filteredData.filter(p => p.yearClass === 'less').length;
            const yearEqual = filteredData.filter(p => p.yearClass === 'equal').length;
            const yearMore = filteredData.filter(p => p.yearClass === 'more').length;

            updateKPIs({total, vencidos, critico, alerta, normal, yearLess, yearEqual, yearMore});
            updateTable();
        }

        function updateKPIs(stats) {
            const kpiGrid = document.getElementById('kpiGrid');
            kpiGrid.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-icon"><i class="fas fa-boxes"></i></div>
                    <div class="kpi-label">Total Produtos</div>
                    <div class="kpi-value">${stats.total}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #ef4444;"><i class="fas fa-times-circle"></i></div>
                    <div class="kpi-label">Vencidos</div>
                    <div class="kpi-value">${stats.vencidos}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #f59e0b;"><i class="fas fa-exclamation-triangle"></i></div>
                    <div class="kpi-label">Cr√≠tico (&lt;30d)</div>
                    <div class="kpi-value">${stats.critico}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #f59e0b;"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="kpi-label">Alerta (&lt;90d)</div>
                    <div class="kpi-value">${stats.alerta}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #10b981;"><i class="fas fa-check-circle"></i></div>
                    <div class="kpi-label">Normal (&gt;90d)</div>
                    <div class="kpi-value">${stats.normal}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #ef4444;"><i class="fas fa-arrow-down"></i></div>
                    <div class="kpi-label">&lt; 1 Ano</div>
                    <div class="kpi-value">${stats.yearLess}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #f59e0b;"><i class="fas fa-equals"></i></div>
                    <div class="kpi-label">= 1 Ano</div>
                    <div class="kpi-value">${stats.yearEqual}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #10b981;"><i class="fas fa-arrow-up"></i></div>
                    <div class="kpi-label">&gt; 1 Ano</div>
                    <div class="kpi-value">${stats.yearMore}</div>
                </div>
            `;
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const sortedData = [...filteredData].sort((a, b) => a.diasRestantes - b.diasRestantes);

            sortedData.forEach(produto => {
                const row = document.createElement('tr');

                let statusIcon = '', statusText = '', statusClass = '';
                switch(produto.status) {
                    case 'expired': statusIcon = '‚ùå'; statusText = 'Vencido'; statusClass = 'expired'; break;
                    case 'critical': statusIcon = 'üî¥'; statusText = 'Cr√≠tico'; statusClass = 'critical'; break;
                    case 'warning': statusIcon = '‚ö†Ô∏è'; statusText = 'Alerta'; statusClass = 'warning'; break;
                    case 'ok': statusIcon = '‚úÖ'; statusText = 'Normal'; statusClass = 'ok'; break;
                }

                let yearText = '', yearIcon = '';
                switch(produto.yearClass) {
                    case 'less': yearText = '< 1 Ano'; yearIcon = 'üîª'; break;
                    case 'equal': yearText = '= 1 Ano'; yearIcon = '‚ûñ'; break;
                    case 'more': yearText = '> 1 Ano'; yearIcon = 'üî∫'; break;
                }

                row.innerHTML = `
                    <td><strong>${produto.loja}</strong></td>
                    <td>${produto.produto}</td>
                    <td>${produto.fornecedor}</td>
                    <td>${produto.lote}</td>
                    <td>${produto.fabricacao.toLocaleDateString('pt-BR')}</td>
                    <td>${produto.validade.toLocaleDateString('pt-BR')}</td>
                    <td><strong>${produto.diasRestantes}</strong> dias</td>
                    <td><span class="year-badge ${produto.yearClass}">${yearIcon} ${yearText}</span></td>
                    <td><span class="status-badge ${statusClass}">${statusIcon} ${statusText}</span></td>
                `;

                tbody.appendChild(row);
            });

            console.log('‚úÖ Tabela atualizada:', sortedData.length, 'linhas');
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('pt-BR');
            document.getElementById('lastUpdate').textContent = `√öltima atualiza√ß√£o: ${timeString} | ${allData.length} produtos carregados`;
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function refreshData() {
            try {
                await loadData();
                alert('‚úÖ Dados atualizados com sucesso!');
            } catch (error) {
                alert('‚ùå Erro: ' + error.message);
            }
        }

        function exportData() {
            const csv = [
                ['Loja', 'Produto', 'Fornecedor', 'Lote', 'Fabrica√ß√£o', 'Validade', 'Dias Restantes', 'Classifica√ß√£o', 'Status'],
                ...filteredData.map(p => [
                    p.loja,
                    p.produto,
                    p.fornecedor,
                    p.lote,
                    p.fabricacao.toLocaleDateString('pt-BR'),
                    p.validade.toLocaleDateString('pt-BR'),
                    p.diasRestantes,
                    p.yearClass === 'less' ? '< 1 Ano' : p.yearClass === 'equal' ? '= 1 Ano' : '> 1 Ano',
                    p.status === 'expired' ? 'Vencido' : p.status === 'critical' ? 'Cr√≠tico' : p.status === 'warning' ? 'Alerta' : 'Normal'
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `dashboard_validade_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function retryConnection() {
            window.location.reload();
        }
    </script>
</body>
</html>