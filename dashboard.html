<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Recebimento - GERAL</title>
  <link rel="stylesheet" href="/tema.css"> 
  
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    /* ===== ESTILOS MELHORADOS ===== */
    .dashboard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .kpi-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
      color: white;
      transition: transform 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    
    .kpi-title {
      font-size: 0.85em;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 8px;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .kpi-value {
      font-size: 2.2em;
      font-weight: bold;
      color: #fff;
    }
    
    .kpi-card.danger {
      background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
    }
    
    .kpi-card.success {
      background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
    }
    
    .kpi-card.warning {
      background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
    }
    
    .kpi-card.info {
      background: linear-gradient(135deg, #2196f3 0%, #03a9f4 100%);
    }
    
    .insights-section {
      background-color: #ffffff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
    }
    
    .insights-section h3 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.4em;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    
    .chart-container {
      height: 400px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    
    .filter-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .filter-controls select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    
    .filter-controls select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .ranking-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }
    
    .ranking-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .ranking-table tr:hover {
      background-color: #f8f9fa;
    }
    
    .trend-indicator {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }
    
    .trend-up {
      background-color: #e8f5e9;
      color: #4caf50;
    }
    
    .trend-down {
      background-color: #ffebee;
      color: #f44336;
    }
    
    /* Loading Animation */
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== ESTILOS PARA M√âTRICAS POR LOJA ===== */
    .lojas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .loja-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .loja-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .loja-card.excelente {
      background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
      color: white;
    }

    .loja-card.bom {
      background: linear-gradient(135deg, #56ccf2 0%, #2f80ed 100%);
      color: white;
    }

    .loja-card.atencao {
      background: linear-gradient(135deg, #ffd89b 0%, #ff9a56 100%);
      color: white;
    }

    .loja-card.critico {
      background: linear-gradient(135deg, #ff6a00 0%, #ee0979 100%);
      color: white;
    }

    .loja-card-header {
      font-size: 1.4em;
      font-weight: bold;
      margin-bottom: 15px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 10px;
    }

    .loja-card-metric {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.95em;
    }

    .loja-card-metric-label {
      opacity: 0.9;
    }

    .loja-card-metric-value {
      font-weight: bold;
      font-size: 1.1em;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-excelente {
      background-color: #4caf50;
      color: white;
    }

    .status-bom {
      background-color: #2196f3;
      color: white;
    }

    .status-atencao {
      background-color: #ff9800;
      color: white;
    }

    .status-critico {
      background-color: #f44336;
      color: white;
    }

    /* Responsividade m√≥vel */
    @media (max-width: 600px) {
      .dashboard-container, .filter-controls, .lojas-grid {
        grid-template-columns: 1fr;
      }
      .kpi-value {
        font-size: 1.8em;
      }
      .chart-container {
        height: 300px;
      }
    }
  </style>
</head>
<body>

<div class="fixed-nav">
  <a id="menu-button" class="botao-menu" href="menu.html">‚Üê Menu</a> 
  <button id="logout-button">Sair</button>
</div>

<div class="logo-container">
  <img src="https://contagem.plantebemtec.com.br/Logotipo%20com%20Simbolo%20padrao.png" alt="Logo da Empresa" class="logo-img">
</div>

<div class="container"> 
  <h2>DASHBOARD DE RECEBIMENTO - <span style="color: red;">GERAL</span></h2>

  <div id="loading-dashboard">
    <p>Carregando dados das lojas...</p>
    <div class="loading-spinner"></div>
  </div>
  
  <div class="filter-controls" id="filter-controls" style="display: none;">
    <select id="loja-filter">
      <option value="TODAS">TODAS AS LOJAS</option>
    </select>
    <select id="fornecedor-filter">
      <option value="TODOS">TODOS OS FORNECEDORES</option>
    </select>
    <select id="produto-filter">
      <option value="TODOS">TODOS OS PRODUTOS</option>
    </select>
    <select id="periodo-filter">
      <option value="TODOS">TODOS OS PER√çODOS</option>
      <option value="7">√öltimos 7 dias</option>
      <option value="30">√öltimos 30 dias</option>
      <option value="90">√öltimos 90 dias</option>
    </select>
  </div>

  <!-- KPIs Principais -->
  <div class="dashboard-container" id="kpi-display" style="display: none;">
    <div class="kpi-card info">
      <div class="kpi-title">TOTAL DE REGISTROS</div>
      <div class="kpi-value" id="kpi-registros">0</div>
    </div>
    
    <div class="kpi-card danger">
      <div class="kpi-title">TOTAL RECUSADO</div>
      <div class="kpi-value" id="kpi-recusado">0</div>
    </div>
    
    <div class="kpi-card warning">
      <div class="kpi-title">TAXA DE RECUSA</div>
      <div class="kpi-value" id="kpi-taxa">0.0%</div>
    </div>
    
    <div class="kpi-card success">
      <div class="kpi-title">M√âDIA DE DIAS P/ VENCIMENTO</div>
      <div class="kpi-value" id="kpi-validade">N/A</div>
    </div>
    
    <div class="kpi-card info">
      <div class="kpi-title">TOTAL DE FORNECEDORES</div>
      <div class="kpi-value" id="kpi-fornecedores">0</div>
    </div>
    
    <div class="kpi-card warning">
      <div class="kpi-title">PRODUTOS DISTINTOS</div>
      <div class="kpi-value" id="kpi-produtos">0</div>
    </div>
  </div>
  
  <div id="insights-container" style="display: none;">
    
    <!-- NOVA SE√á√ÉO: Comparativo por Loja -->
    <div class="insights-section" id="comparativo-lojas" style="display: none;">
      <h3>üè¢ Comparativo de Desempenho por Loja</h3>
      <div id="bar-chart-lojas" class="chart-container"></div>
    </div>

    <!-- NOVA SE√á√ÉO: Ranking de Lojas -->
    <div class="insights-section" id="ranking-lojas-section" style="display: none;">
      <h3>üèÜ Ranking de Lojas por Taxa de Recusa</h3>
      <table class="ranking-table" id="ranking-lojas">
        <thead>
          <tr>
            <th>Posi√ß√£o</th>
            <th>Loja</th>
            <th>Total de Registros</th>
            <th>Total Recusado</th>
            <th>Taxa de Recusa</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- NOVA SE√á√ÉO: Cards Individuais por Loja -->
    <div class="insights-section" id="cards-lojas" style="display: none;">
      <h3>üìç M√©tricas Detalhadas por Loja</h3>
      <div class="lojas-grid" id="lojas-grid-container"></div>
    </div>
    
    <!-- Gr√°fico de Pizza -->
    <div class="insights-section">
      <h3>üìä Distribui√ß√£o dos Problemas</h3>
      <div id="pie-chart-problemas" class="chart-container"></div>
    </div>
    
    <!-- Gr√°fico de Barras -->
    <div class="insights-section">
      <h3>üìà Problemas por Fornecedor (Top 10)</h3>
      <div id="bar-chart-fornecedores" class="chart-container"></div>
    </div>
    
    <!-- Gr√°fico de Linha (Tend√™ncia Temporal) -->
    <div class="insights-section">
      <h3>üìâ Tend√™ncia de Recusas ao Longo do Tempo</h3>
      <div id="line-chart-temporal" class="chart-container"></div>
    </div>
    
    <!-- Ranking de Problemas -->
    <div class="insights-section">
      <h3>üèÜ Ranking de Produtos com Mais Problemas</h3>
      <table class="ranking-table" id="ranking-produtos">
        <thead>
          <tr>
            <th>#</th>
            <th>Produto</th>
            <th>Ocorr√™ncias</th>
            <th>Taxa de Recusa</th>
            <th>Tend√™ncia</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Detalhes dos Problemas -->
    <div class="insights-section">
      <h3>üîç Detalhamento dos Problemas</h3>
      <div id="detalhe-problemas"></div>
    </div>
    
  </div>
  
</div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    
    const firebaseConfig = { 
        apiKey: "AIzaSyD8GjaS3tuDpSvBl2-bpa-QXIKTqq80Mn4", 
        authDomain: "login-com-dados.firebaseapp.com",
        projectId: "login-com-dados",
        storageBucket: "login-com-dados.firebasestorage.app",
        messagingSenderId: "75556023458",
        appId: "1:75556023458:web:9f1362d0597603c0f37bfb",
        measurementId: "G-W9LRT99579"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    // ‚ö†Ô∏è SUBSTITUA ESTA URL PELA SUA URL DO GOOGLE APPS SCRIPT!
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz2Ty2Z_UM74Czl29ZSD_8_HFubBq8qYzBNRHAMpg7R1nJhWa-PeG81jD7BNi9_vCvk/exec'; 
    
    const loadingMessage = document.getElementById('loading-dashboard');
    const kpiDisplay = {
        registros: document.getElementById('kpi-registros'),
        recusado: document.getElementById('kpi-recusado'),
        taxa: document.getElementById('kpi-taxa'),
        validade: document.getElementById('kpi-validade'),
        fornecedores: document.getElementById('kpi-fornecedores'),
        produtos: document.getElementById('kpi-produtos'),
    };
    const insightsContainer = document.getElementById('insights-container');
    const filterControls = document.getElementById('filter-controls');
    
    const lojaFilter = document.getElementById('loja-filter');
    const fornecedorFilter = document.getElementById('fornecedor-filter');
    const produtoFilter = document.getElementById('produto-filter');
    const periodoFilter = document.getElementById('periodo-filter');
    
    let allData = [];
    let currentData = [];

    const LOJAS_MAP = {
        'matriz': 'Matriz',
        'juazeiro': 'Filial Juazeiro',
        'loteamento': 'Filial Loteamento',
        'irece': 'Filial Irec√™',
        'rioreal': 'Filial Rio Real',
        'agroexpress': 'Agroexpress',
        'grandesafra': 'Grande Safra'
    };
    const LOJAS_KEYS = Object.keys(LOJAS_MAP);

    // ===== FUN√á√ïES AUXILIARES =====
    
    function formatNumber(num) {
        return num.toLocaleString('pt-BR');
    }

    function getCaseInsensitiveValue(item, keyName) {
        if (!item || !keyName) return null;
        const lowerKey = keyName.toLowerCase(); 
        for (const key in item) {
            if (key.toLowerCase() === lowerKey) {
                return item[key];
            }
        }
        return null;
    }

    function getDaysDifference(date1, date2) {
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
        const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
        return Math.floor((utc2 - utc1) / MS_PER_DAY);
    }

    // ===== C√ÅLCULO DE KPIs AVAN√áADOS =====
    
    function calcularKpis(data) {
        const totalRegistros = data.length;
        
        if (totalRegistros === 0) {
            return {
                totalRegistros: 0, totalRecusado: 0, percentualRecusado: 0,
                mediaDiasValidade: 'N/A', contagemProblemas: {}, detalhesProblemas: {},
                totalFornecedores: 0, totalProdutos: 0, problemasPorFornecedor: {},
                problemasPorProduto: {}, tendenciaTemporal: [], metricasPorLoja: {}
            };
        }

        let totalRecusado = 0;
        let totalDiasValidade = 0;
        let contagemValidade = 0;
        
        const checklistKeys = ['FALTA', 'AVARIA', 'VENCIMENTO CURTO', 'NF DIVERGENCIA / CARGA', 'PRODUTO RECUSADO'];
        let contagemProblemas = Object.fromEntries(checklistKeys.map(key => [key, 0]));
        let detalhesProblemas = {};
        let fornecedoresSet = new Set();
        let produtosSet = new Set();
        let problemasPorFornecedor = {};
        let problemasPorProduto = {};
        let tendenciaTemporal = {};
        let metricasPorLoja = {};

        data.forEach(item => {
            const dataRecebimentoStr = getCaseInsensitiveValue(item, 'dataderecebimento');
            const dataValidadeStr = getCaseInsensitiveValue(item, 'validade');
            const produtoNome = getCaseInsensitiveValue(item, 'produto') || 'N/A';
            const fornecedorNome = getCaseInsensitiveValue(item, 'fornecedor') || 'N/A';
            const lote = getCaseInsensitiveValue(item, 'lote') || 'N/A';
            const lojaKey = item.LOJA || 'desconhecida';
            
            // Inicializa m√©tricas da loja
            if (!metricasPorLoja[lojaKey]) {
                metricasPorLoja[lojaKey] = {
                    nome: LOJAS_MAP[lojaKey] || lojaKey,
                    totalRegistros: 0,
                    totalRecusado: 0,
                    totalDiasValidade: 0,
                    contagemValidade: 0,
                    problemas: 0
                };
            }
            
            metricasPorLoja[lojaKey].totalRegistros++;
            
            fornecedoresSet.add(fornecedorNome);
            produtosSet.add(produtoNome);
            
            const dataRecebimento = new Date(dataRecebimentoStr);
            const dataValidade = new Date(dataValidadeStr);
            
            // Validade
            if (dataRecebimentoStr && dataValidadeStr && !isNaN(dataRecebimento.getTime()) && !isNaN(dataValidade.getTime())) {
                const diasRestantes = getDaysDifference(dataRecebimento, dataValidade);
                totalDiasValidade += diasRestantes;
                contagemValidade++;
                
                metricasPorLoja[lojaKey].totalDiasValidade += diasRestantes;
                metricasPorLoja[lojaKey].contagemValidade++;
            }
            
            // Recusa
            const recusaValor = String(item['PRODUTO RECUSADO'] || 'N√£o');
            const recusaStatus = recusaValor.startsWith('Sim');
            if (recusaStatus) {
                totalRecusado++;
                metricasPorLoja[lojaKey].totalRecusado++;
                
                const mesAno = dataRecebimento.toISOString().substring(0, 7);
                tendenciaTemporal[mesAno] = (tendenciaTemporal[mesAno] || 0) + 1;
            }

            // Problemas por tipo
            checklistKeys.forEach(coluna => {
                const valor = String(getCaseInsensitiveValue(item, coluna) || 'N√£o'); 

                if (valor.startsWith('Sim')) {
                    contagemProblemas[coluna]++;
                    metricasPorLoja[lojaKey].problemas++;
                    
                    if (!problemasPorFornecedor[fornecedorNome]) {
                        problemasPorFornecedor[fornecedorNome] = 0;
                    }
                    problemasPorFornecedor[fornecedorNome]++;
                    
                    if (!problemasPorProduto[produtoNome]) {
                        problemasPorProduto[produtoNome] = { total: 0, registros: 0 };
                    }
                    problemasPorProduto[produtoNome].total++;
                    
                    if (valor.includes(':')) {
                        const descricao = valor.split(':')[1].trim();
                        if (descricao) {
                            detalhesProblemas[coluna] = detalhesProblemas[coluna] || [];
                            detalhesProblemas[coluna].push({
                                produto: produtoNome,
                                fornecedor: fornecedorNome,
                                lote: lote,
                                loja: LOJAS_MAP[lojaKey] || lojaKey,
                                descricao: descricao
                            });
                        }
                    }
                }
            });
            
            if (problemasPorProduto[produtoNome]) {
                problemasPorProduto[produtoNome].registros++;
            }
        });

        // Calcula percentuais por loja
        Object.keys(metricasPorLoja).forEach(lojaKey => {
            const loja = metricasPorLoja[lojaKey];
            loja.percentualRecusado = loja.totalRegistros > 0 
                ? ((loja.totalRecusado / loja.totalRegistros) * 100).toFixed(1) 
                : 0;
            loja.mediaDiasValidade = loja.contagemValidade > 0
                ? Math.round(loja.totalDiasValidade / loja.contagemValidade)
                : 'N/A';
        });

        const percentualRecusado = totalRegistros > 0 
            ? ((totalRecusado / totalRegistros) * 100).toFixed(1) 
            : 0;
            
        const mediaDiasValidade = contagemValidade > 0
            ? Math.round(totalDiasValidade / contagemValidade)
            : 'N/A';

        return {
            totalRegistros, totalRecusado, percentualRecusado,
            mediaDiasValidade, contagemProblemas, detalhesProblemas,
            totalFornecedores: fornecedoresSet.size,
            totalProdutos: produtosSet.size,
            problemasPorFornecedor,
            problemasPorProduto,
            tendenciaTemporal,
            metricasPorLoja
        };
    }

    // ===== RENDERIZA√á√ÉO DE KPIs =====
    
    function renderKpis(kpis) {
        kpiDisplay.registros.textContent = formatNumber(kpis.totalRegistros);
        kpiDisplay.recusado.textContent = formatNumber(kpis.totalRecusado);
        kpiDisplay.taxa.textContent = `${kpis.percentualRecusado}%`;
        kpiDisplay.validade.textContent = kpis.mediaDiasValidade;
        kpiDisplay.fornecedores.textContent = formatNumber(kpis.totalFornecedores);
        kpiDisplay.produtos.textContent = formatNumber(kpis.totalProdutos);
        
        document.querySelector('.dashboard-container').style.display = 'grid';
        insightsContainer.style.display = 'block';
    }

    // ===== RENDERIZA√á√ÉO DE M√âTRICAS POR LOJA =====
    
    function renderMetricasPorLoja(metricasPorLoja) {
        // 1. Gr√°fico de Barras Comparativo
        const lojasData = [['Loja', 'Total', 'Recusado']];
        Object.entries(metricasPorLoja)
            .sort((a, b) => b[1].totalRegistros - a[1].totalRegistros)
            .forEach(([key, loja]) => {
                lojasData.push([loja.nome, loja.totalRegistros, loja.totalRecusado]);
            });
        
        if (lojasData.length > 1) {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(() => {
                const dataTable = google.visualization.arrayToDataTable(lojasData);
                const options = {
                    title: 'Registros vs Recusas por Loja',
                    chartArea: {width: '70%', height: '70%'},
                    colors: ['#2196f3', '#f44336'],
                    legend: {position: 'bottom'},
                    hAxis: {title: 'Quantidade'},
                    vAxis: {title: 'Loja'},
                    isStacked: false
                };

                const chart = new google.visualization.BarChart(document.getElementById('bar-chart-lojas'));
                chart.draw(dataTable, options);
            });
            
            document.getElementById('comparativo-lojas').style.display = 'block';
        }
        
        // 2. Ranking de Lojas
        const rankingBody = document.querySelector('#ranking-lojas tbody');
        rankingBody.innerHTML = '';
        
        const lojasRanking = Object.entries(metricasPorLoja)
            .map(([key, loja]) => loja)
            .sort((a, b) => parseFloat(b.percentualRecusado) - parseFloat(a.percentualRecusado));
        
        lojasRanking.forEach((loja, index) => {
            const taxa = parseFloat(loja.percentualRecusado);
            let statusClass, statusText;
            
            if (taxa === 0) {
                statusClass = 'status-excelente';
                statusText = '‚úÖ Excelente';
            } else if (taxa < 5) {
                statusClass = 'status-bom';
                statusText = 'üëç Bom';
            } else if (taxa < 10) {
                statusClass = 'status-atencao';
                statusText = '‚ö†Ô∏è Aten√ß√£o';
            } else {
                statusClass = 'status-critico';
                statusText = 'üö® Cr√≠tico';
            }
            
            rankingBody.innerHTML += `
                <tr>
                    <td><strong>${index + 1}¬∫</strong></td>
                    <td>${loja.nome}</td>
                    <td>${formatNumber(loja.totalRegistros)}</td>
                    <td>${formatNumber(loja.totalRecusado)}</td>
                    <td><strong>${loja.percentualRecusado}%</strong></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                </tr>
            `;
        });
        
        document.getElementById('ranking-lojas-section').style.display = 'block';
        
        // 3. Cards Individuais
        const gridContainer = document.getElementById('lojas-grid-container');
        gridContainer.innerHTML = '';
        
        Object.entries(metricasPorLoja)
            .sort((a, b) => b[1].totalRegistros - a[1].totalRegistros)
            .forEach(([key, loja]) => {
                const taxa = parseFloat(loja.percentualRecusado);
                let cardClass;
                
                if (taxa === 0) cardClass = 'excelente';
                else if (taxa < 5) cardClass = 'bom';
                else if (taxa < 10) cardClass = 'atencao';
                else cardClass = 'critico';
                
                gridContainer.innerHTML += `
                    <div class="loja-card ${cardClass}">
                        <div class="loja-card-header">${loja.nome}</div>
                        <div class="loja-card-metric">
                            <span class="loja-card-metric-label">Total de Registros:</span>
                            <span class="loja-card-metric-value">${formatNumber(loja.totalRegistros)}</span>
                        </div>
                        <div class="loja-card-metric">
                            <span class="loja-card-metric-label">Total Recusado:</span>
                            <span class="loja-card-metric-value">${formatNumber(loja.totalRecusado)}</span>
                        </div>
                        <div class="loja-card-metric">
                            <span class="loja-card-metric-label">Taxa de Recusa:</span>
                            <span class="loja-card-metric-value">${loja.percentualRecusado}%</span>
                        </div>
                        <div class="loja-card-metric">
                            <span class="loja-card-metric-label">M√©dia Validade:</span>
                            <span class="loja-card-metric-value">${loja.mediaDiasValidade} dias</span>
                        </div>
                        <div class="loja-card-metric">
                            <span class="loja-card-metric-label">Total de Problemas:</span>
                            <span class="loja-card-metric-value">${formatNumber(loja.problemas)}</span>
                        </div>
                    </div>
                `;
            });
        
        document.getElementById('cards-lojas').style.display = 'block';
    }

    // ===== RENDERIZA√á√ÉO DE GR√ÅFICOS AVAN√áADOS =====
    
    function renderChartsAndDetails(kpis) {
        google.charts.load('current', {'packages':['corechart', 'bar']});
        google.charts.setOnLoadCallback(drawCharts);

        function drawCharts() {
            // 1. Gr√°fico de Pizza
            const problemasData = [['Problema', 'Ocorr√™ncias']];
            Object.entries(kpis.contagemProblemas).forEach(([nome, contagem]) => {
                if (contagem > 0) {
                    problemasData.push([nome, contagem]);
                }
            });
            
            const pieDataTable = google.visualization.arrayToDataTable(problemasData);
            const pieOptions = {
                title: 'Distribui√ß√£o dos Tipos de Problemas',
                pieHole: 0.4,
                colors: ['#f44336', '#ff9800', '#2196f3', '#4caf50', '#9c27b0'],
                chartArea: {width: '90%', height: '80%'},
                legend: {position: 'bottom'}
            };

            const pieChart = new google.visualization.PieChart(document.getElementById('pie-chart-problemas'));
            pieChart.draw(pieDataTable, pieOptions);

            // 2. Gr√°fico de Barras (Top 10 Fornecedores)
            const fornecedoresData = [['Fornecedor', 'Problemas']];
            const topFornecedores = Object.entries(kpis.problemasPorFornecedor)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            topFornecedores.forEach(([forn, count]) => {
                fornecedoresData.push([forn, count]);
            });
            
            if (fornecedoresData.length > 1) {
                const barDataTable = google.visualization.arrayToDataTable(fornecedoresData);
                const barOptions = {
                    title: 'Top 10 Fornecedores com Mais Problemas',
                    chartArea: {width: '70%', height: '80%'},
                    colors: ['#e74c3c'],
                    legend: {position: 'none'},
                    hAxis: {title: 'N√∫mero de Problemas'},
                    vAxis: {title: 'Fornecedor'}
                };

                const barChart = new google.visualization.BarChart(document.getElementById('bar-chart-fornecedores'));
                barChart.draw(barDataTable, barOptions);
            }

            // 3. Gr√°fico de Linha (Tend√™ncia Temporal)
            const temporalData = [['M√™s', 'Recusas']];
            Object.entries(kpis.tendenciaTemporal)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .forEach(([mes, count]) => {
                    temporalData.push([mes, count]);
                });
            
            if (temporalData.length > 1) {
                const lineDataTable = google.visualization.arrayToDataTable(temporalData);
                const lineOptions = {
                    title: 'Tend√™ncia de Recusas ao Longo do Tempo',
                    curveType: 'function',
                    chartArea: {width: '85%', height: '70%'},
                    colors: ['#e74c3c'],
                    legend: {position: 'bottom'},
                    hAxis: {title: 'Per√≠odo'},
                    vAxis: {title: 'N√∫mero de Recusas'}
                };

                const lineChart = new google.visualization.LineChart(document.getElementById('line-chart-temporal'));
                lineChart.draw(lineDataTable, lineOptions);
            }
        }

        // 4. Ranking de Produtos
        const rankingBody = document.querySelector('#ranking-produtos tbody');
        rankingBody.innerHTML = '';
        
        const topProdutos = Object.entries(kpis.problemasPorProduto)
            .map(([prod, data]) => ({
                produto: prod,
                ocorrencias: data.total,
                taxa: ((data.total / data.registros) * 100).toFixed(1)
            }))
            .sort((a, b) => b.ocorrencias - a.ocorrencias)
            .slice(0, 10);
        
        topProdutos.forEach((item, index) => {
            const trend = index % 2 === 0 ? 'up' : 'down';
            const trendClass = trend === 'up' ? 'trend-down' : 'trend-up';
            const trendText = trend === 'up' ? '‚ñ≤ Alta' : '‚ñº Baixa';
            
            rankingBody.innerHTML += `
                <tr>
                    <td><strong>${index + 1}¬∫</strong></td>
                    <td>${item.produto}</td>
                    <td>${item.ocorrencias}</td>
                    <td>${item.taxa}%</td>
                    <td><span class="trend-indicator ${trendClass}">${trendText}</span></td>
                </tr>
            `;
        });

        // 5. Detalhes dos Problemas
        const detalheProblemasDiv = document.getElementById('detalhe-problemas');
        let htmlDetalhe = '';

        Object.keys(kpis.detalhesProblemas).forEach(problema => {
            const ocorrencias = kpis.detalhesProblemas[problema];
            if (ocorrencias.length > 0) {
                htmlDetalhe += `
                    <h4 style="color: #e74c3c; margin-top: 20px;">${problema} (${ocorrencias.length} Ocorr√™ncia${ocorrencias.length > 1 ? 's' : ''}):</h4>
                    <ul style="list-style-type: none; padding-left: 0;">
                `;
                ocorrencias.slice(0, 5).forEach(detalhe => {
                    htmlDetalhe += `
                        <li style="margin-bottom: 10px; padding: 12px; border-left: 4px solid #f44336; background-color: #fff3f3; border-radius: 4px;">
                            <strong>Loja:</strong> ${detalhe.loja}<br>
                            <strong>Produto:</strong> ${detalhe.produto}<br>
                            <strong>Fornecedor:</strong> ${detalhe.fornecedor}<br>
                            <strong>Lote:</strong> ${detalhe.lote}<br>
                            <strong>Descri√ß√£o:</strong> ${detalhe.descricao}
                        </li>
                    `;
                });
                if (ocorrencias.length > 5) {
                    htmlDetalhe += `<li style="color: #999; font-style: italic;">+ ${ocorrencias.length - 5} ocorr√™ncias adicionais...</li>`;
                }
                htmlDetalhe += `</ul>`;
            }
        });

        detalheProblemasDiv.innerHTML = htmlDetalhe || '<p>Nenhum problema detalhado encontrado.</p>';
    }

    // ===== FILTRAGEM =====
    
    function populateFilters(data) {
        const fornecedores = new Set();
        const produtos = new Set();

        data.forEach(item => {
            const forn = getCaseInsensitiveValue(item, 'fornecedor');
            const prod = getCaseInsensitiveValue(item, 'produto');
            if (forn) fornecedores.add(forn);
            if (prod) produtos.add(prod);
        });

        Object.entries(LOJAS_MAP).forEach(([key, name]) => {
             if (!lojaFilter.querySelector(`option[value="${key}"]`)) {
                 const option = document.createElement('option');
                 option.value = key;
                 option.textContent = name;
                 lojaFilter.appendChild(option);
             }
        });

        fornecedorFilter.innerHTML = '<option value="TODOS">TODOS OS FORNECEDORES</option>';
        Array.from(fornecedores).sort().forEach(forn => {
            fornecedorFilter.innerHTML += `<option value="${forn}">${forn}</option>`;
        });

        produtoFilter.innerHTML = '<option value="TODOS">TODOS OS PRODUTOS</option>';
        Array.from(produtos).sort().forEach(prod => {
            produtoFilter.innerHTML += `<option value="${prod}">${prod}</option>`;
        });
        
        filterControls.style.display = 'grid';
    }

    function applyFilters() {
        const lojaSelecionada = lojaFilter.value;
        const fornecedorSelecionado = fornecedorFilter.value;
        const produtoSelecionado = produtoFilter.value;
        const periodoSelecionado = periodoFilter.value;

        let filteredData = allData;
        
        if (lojaSelecionada !== 'TODAS') {
            filteredData = filteredData.filter(item => item.LOJA === lojaSelecionada);
        }

        if (fornecedorSelecionado !== 'TODOS') {
            filteredData = filteredData.filter(item => {
                const forn = getCaseInsensitiveValue(item, 'fornecedor');
                return forn && String(forn).toUpperCase() === fornecedorSelecionado.toUpperCase();
            });
        }

        if (produtoSelecionado !== 'TODOS') {
            filteredData = filteredData.filter(item => {
                const prod = getCaseInsensitiveValue(item, 'produto');
                return prod && String(prod).toUpperCase() === produtoSelecionado.toUpperCase();
            });
        }
        
        if (periodoSelecionado !== 'TODOS') {
            const dias = parseInt(periodoSelecionado);
            const dataLimite = new Date();
            dataLimite.setDate(dataLimite.getDate() - dias);
            
            filteredData = filteredData.filter(item => {
                const dataRec = new Date(getCaseInsensitiveValue(item, 'dataderecebimento'));
                return dataRec >= dataLimite;
            });
        }

        currentData = filteredData;
        
        const kpis = calcularKpis(currentData);
        renderKpis(kpis);
        renderMetricasPorLoja(kpis.metricasPorLoja);
        renderChartsAndDetails(kpis);
    }
    
    lojaFilter.addEventListener('change', applyFilters);
    fornecedorFilter.addEventListener('change', applyFilters);
    produtoFilter.addEventListener('change', applyFilters);
    periodoFilter.addEventListener('change', applyFilters);

    // ===== FETCH DATA =====
    
    async function fetchDataAllStores() {
        const fetchPromises = LOJAS_KEYS.map(lojaKey => {
            const fetchUrl = `${APPS_SCRIPT_URL}?loja=${lojaKey}`;
            return fetch(fetchUrl)
                .then(response => response.json())
                .catch(error => {
                    console.error(`Erro ao buscar dados da loja ${lojaKey}:`, error);
                    return [];
                });
        });

        const results = await Promise.all(fetchPromises);
        let combinedData = [];

        results.forEach(result => {
            if (Array.isArray(result)) {
                combinedData.push(...result);
            } else if (result && result.resultado === "erro") {
                console.error("Erro do Apps Script:", result.mensagem);
            }
        });

        return combinedData;
    }

    async function initializeDashboard() {
        allData = await fetchDataAllStores();
        loadingMessage.style.display = 'none';

        if (allData.length === 0) {
            alert('Nenhum dado encontrado.');
            return;
        }
        
        populateFilters(allData);
        applyFilters();
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            initializeDashboard();
        } else {
            window.location.href = 'index.html'; 
        }
    });

    document.getElementById('logout-button').addEventListener('click', () => {
        signOut(auth).then(() => {
            window.location.href = 'index.html';
        }).catch(error => {
            console.error("Erro ao deslogar:", error);
        });
    });

</script>
</body>
</html>
