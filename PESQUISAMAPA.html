<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PESQUISA E DETALHES DE REGISTRO</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f7f6;
        padding: 20px;
        text-align: center;
        margin: 0;
        position: relative;
    }

    /* ==================================== */
    /* ESTILOS PARA OS BOTÕES DE NAVEGAÇÃO FIXOS */
    /* ==================================== */
    .nav-button {
        display: inline-block; 
        position: fixed;
        top: 20px;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        text-decoration: none;
        z-index: 1000;
        transition: background-color 0.3s;
    }

    #add-button {
        right: 20px;
        background-color: #28a745; /* Verde para Novo */
    }

    #add-button:hover {
        background-color: #218838;
    }
    
    #logout-button {
        right: 180px; 
        background-color: #e74c3c; /* Vermelho para Sair */
    }

    #logout-button:hover {
        background-color: #c0392b;
    }
    
    /* Botão de Edição na Tabela */
    .edit-button {
        background-color: #007bff;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s;
    }

    .edit-button:hover {
        background-color: #0056b3;
    }

    /* ==================================== */

    .container {
        width: 95%;
        max-width: 1200px; /* Largura ajustada para melhor visualização */
        margin-left: auto;
        margin-right: auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 80px; 
    }

    .logo-pesquisa {
        max-width: 250px;
        height: auto;
        margin-bottom: 20px;
    }

    h1 {
        color: #333;
    }

    #loading {
        margin: 20px;
        font-style: italic;
        color: #666;
    }

    .search-container {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
    }

    #searchInput {
        flex-grow: 1;
        padding: 12px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 16px;
    }
    
    /* Estilos de Tabela */
    #dataTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    #dataTable th, #dataTable td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        vertical-align: middle;
    }

    #dataTable th {
        background-color: #007bff;
        color: white;
        font-weight: bold;
    }

    #dataTable tr:nth-child(even) {
        background-color: #f0f0f0;
    }
    
    /* Estilos de responsividade da tabela (Mobile First) */
    @media (max-width: 768px) {
        .container {
            margin-top: 100px;
            padding: 10px;
        }

        .nav-button {
             position: absolute;
             top: 10px;
        }
        
        #add-button { right: 10px; }
        #logout-button { right: 130px; }

        /* Tabela: Esconde cabeçalho e empilha células */
        #dataTable thead {
            display: none;
        }

        #dataTable, #dataTable tbody, #dataTable tr, #dataTable td {
            display: block;
            width: 100%;
        }

        #dataTable tr {
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        #dataTable td {
            text-align: right;
            border-bottom: 1px solid #eee;
            border-left: none;
            border-right: none;
            padding: 10px;
        }

        #dataTable td::before {
            content: attr(data-label) ": ";
            font-weight: bold;
            float: left;
        }
    }
</style>
</head>
<body>

<a id="add-button" class="nav-button" href="mapaprod.html">✚ Novo Registro</a>
<a id="logout-button" class="nav-button" href="index.html">Sair</a>

<div class="container">
<img src="https://contagem.plantebemtec.com.br/Logotipo%20com%20Simbolo%20padrao.png" alt="Logo da Empresa" class="logo-pesquisa">

<h1>Detalhes de Localização de Produtos</h1>

<div class="search-container">
<input type="text" id="searchInput" placeholder="DIGITE O PRODUTO, ID, LOTE, RUA, VÃO ou NÍVEL...">
</div>

<p id="loading">Carregando dados...</p>

<table id="dataTable">
<thead>
<tr></tr>
</thead>
<tbody>
</tbody>
</table>
</div>

<script>
// *** IMPORTANTE: AJUSTE ESTES URLs ***
const APPS_SCRIPT_DATA_URL = 'https://script.google.com/macros/s/AKfycby1_w2kGi8R3dLSJZDD84N1SuFbcuYmPDGtIo1XrECJNCSew7ztSByELhcidqwD4s5eGQ/exec'; // Seu URL GET para buscar TUDO
const EDIT_PAGE_URL = 'mapaprod.html'; // O nome EXATO do seu arquivo HTML de formulário (Formulário de Edição/Inclusão)

const loadingMessage = document.getElementById('loading');
const searchInput = document.getElementById('searchInput');
const tableHead = document.querySelector('#dataTable thead tr');
const tableBody = document.querySelector('#dataTable tbody');

let fullData = [];
let headersGlobal = [];

/**
 * Formata strings de data.
 */
function formatarDataBrasileira(dataString) {
    if (!dataString) return '';
    try {
        const data = new Date(dataString);
        if (isNaN(data.getTime())) return dataString;
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
    } catch (e) {
        return dataString;
    }
}

/**
 * FUNÇÃO CHAVE: Redireciona para a página de edição passando o ID via URL.
 * O Apps Script do formulário usará este ID para buscar os dados.
 */
function redirectToEdit(id) {
    window.location.href = `${EDIT_PAGE_URL}?id=${id}`;
}

/**
 * Renderiza a tabela com os dados fornecidos.
 */
function renderTable(dataToRender) {
    tableBody.innerHTML = '';
    
    // Configura o cabeçalho
    if (headersGlobal.length === 0 && dataToRender.length > 0) {
        headersGlobal = Object.keys(dataToRender[0]);
        tableHead.innerHTML = ''; 

        headersGlobal.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            tableHead.appendChild(th);
        });
        
        const thAcoes = document.createElement('th');
        thAcoes.textContent = 'Ações';
        tableHead.appendChild(thAcoes);
    }
    
    if (dataToRender.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${headersGlobal.length + 1}">Nenhum registro encontrado.</td></tr>`;
        return;
    }

    dataToRender.forEach(rowData => {
        const tr = document.createElement('tr');
        // O valor do ID é crucial aqui para a edição
        const recordID = rowData.ID || rowData['ID']; 
        
        headersGlobal.forEach(header => {
            const td = document.createElement('td');
            let valor = rowData[header];

            // Lógica para tratar links de imagem... (mantida)
            if (typeof valor === 'string' && (valor.includes(',') || valor.includes('http'))) {
                 // Lógica para tratar links de imagem... (mantida)
                 if (valor.includes(',')) {
                    const links = valor.split(',').map(link => link.trim()).filter(Boolean);
                    links.forEach(link => {
                        const a = document.createElement('a');
                        a.href = link;
                        a.textContent = 'Ver Imagem';
                        a.target = '_blank';
                        a.style.marginRight = '5px';
                        td.appendChild(a);
                    });
                } else if (valor.startsWith('http')) {
                    const a = document.createElement('a');
                    a.href = valor;
                    a.textContent = 'Ver Imagem';
                    a.target = '_blank';
                    td.appendChild(a);
                } else {
                    td.textContent = valor;
                }
            } else {
                // Trata Datas ou Texto Comum
                if (header.toLowerCase().includes('data') || header.toLowerCase().includes('validade') || header.toLowerCase().includes('timestamp')) {
                    valor = formatarDataBrasileira(valor);
                }
                td.textContent = valor;
            }

            td.setAttribute('data-label', header);
            tr.appendChild(td);
        });

        // Coluna de Ações
        const tdAcoes = document.createElement('td');
        const editButton = document.createElement('button');
        editButton.textContent = 'Editar';
        editButton.className = 'edit-button';
        // Ação: Chama a função redirectToEdit passando o ID do registro
        editButton.onclick = () => redirectToEdit(recordID); 
        tdAcoes.appendChild(editButton);
        tdAcoes.setAttribute('data-label', 'Ações');
        tr.appendChild(tdAcoes);
        
        tableBody.appendChild(tr);
    });
}


// --- LÓGICA PRINCIPAL ---
fetch(APPS_SCRIPT_DATA_URL)
.then(response => {
    if (!response.ok) throw new Error('Erro de rede.');
    return response.json();
})
.then(data => {
    loadingMessage.style.display = 'none';
    fullData = data;
    renderTable(fullData);
})
.catch(error => {
    loadingMessage.textContent = 'Erro ao carregar os dados. Verifique a URL do script.';
    console.error('Erro:', error);
});

searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const filteredData = fullData.filter(row => {
        return Object.values(row).some(value => String(value).toLowerCase().includes(searchTerm));
    });
    renderTable(filteredData);
});
</script>

</body>
</html>