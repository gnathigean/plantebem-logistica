<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Profissional - Gest√£o de Qualidade</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #7c3aed;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --dark: #1e293b;
            --light: #f8fafc;
            --border: #e2e8f0;
            --maincolor: #e4e4e4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title h1 {
            color: var(--dark);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header-title p {
            color: #64748b;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .debug-info {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 12px;
            font-family: monospace;
        }

        .debug-info h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .debug-list {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
        }

        .kpi-card.danger::before { background: var(--danger-color); }
        .kpi-card.warning::before { background: var(--warning-color); }
        .kpi-card.success::before { background: var(--success-color); }
        .kpi-card.info::before { background: var(--info-color); }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .kpi-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .kpi-card.danger .kpi-icon { background: #fee2e2; }
        .kpi-card.warning .kpi-icon { background: #fef3c7; }
        .kpi-card.success .kpi-icon { background: #d1fae5; }
        .kpi-card.info .kpi-icon { background: #cffafe; }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
        }

        .kpi-trend.up {
            background: #fee2e2;
            color: var(--danger-color);
        }

        .kpi-trend.down {
            background: #d1fae5;
            color: var(--success-color);
        }

        .kpi-content h3 {
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
            margin-bottom: 8px;
        }

        .kpi-subtitle {
            font-size: 12px;
            color: #94a3b8;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-header {
            margin-bottom: 20px;
        }

        .chart-header h2 {
            color: var(--dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chart-header p {
            color: #94a3b8;
            font-size: 13px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .performance-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .performance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .performance-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
        }

        .performance-percentage {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.5s ease;
        }

        .progress-fill.danger { background: var(--danger-color); }
        .progress-fill.warning { background: var(--warning-color); }
        .progress-fill.success { background: var(--success-color); }

        .filters-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
        }

        .filter-group input,
        .filter-group select {
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-debug {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #f59e0b;
        }

        .table-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, var(--maincolor), var(--maincolor));
            color: rgb(0, 0, 0);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            color: #334155;
        }

        tr:hover {
            background: #f8fafc;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-falta { background: #fee2e2; color: #991b1b; }
        .badge-avaria { background: #fef3c7; color: #92400e; }
        .badge-vencimento { background: #fed7aa; color: #9a3412; }
        .badge-divergencia { background: #dbeafe; color: #1e40af; }
        .badge-recusado { background: #fecaca; color: #7f1d1d; }
        .badge-ok { background: #d1fae5; color: #065f46; }
        .badge-sem-categoria { background: #e5e7eb; color: #374151; }

        .loading {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
            font-size: 16px;
        }

        .error {
            background: var(--danger-color);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .charts-grid,
            .performance-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        /* Efeito de hover nos cards clic√°veis */
.kpi-card[onclick] {
    transition: all 0.3s ease;
}

.kpi-card[onclick]:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 12px 35px rgba(0,0,0,0.2);
}

.kpi-card[onclick]:active {
    transform: translateY(-4px) scale(0.98);
}

/* Card ativo (filtrado) */
.kpi-card.active {
    border: 3px solid #2563eb;
    background: linear-gradient(135deg, #e0e7ff 0%, #f5f3ff 100%);
}

.kpi-card.active::before {
    width: 6px;
}

/* Badge de filtro ativo */
.filter-badge {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #2563eb;
    color: white;
    padding: 15px 25px;
    border-radius: 50px;
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    animation: slideIn 0.3s ease;
}

.filter-badge button {
    background: white;
    color: #2563eb;
    border: none;
    padding: 5px 15px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    font-size: 12px;
}

.filter-badge button:hover {
    background: #f1f5f9;
}

@keyframes slideIn {
    from {
        bottom: -100px;
        opacity: 0;
    }
    to {
        bottom: 30px;
        opacity: 1;
    }
}

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <h1>üìä Dashboard de Gest√£o de Qualidade</h1>
                    <p id="lastUpdate">Carregando dados...</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-debug" onclick="toggleDebug()">üêõ Debug</button>
                    <button class="btn btn-secondary" onclick="exportData()">üì• Exportar</button>
                    <button class="btn btn-primary" onclick="loadData()">üîÑ Atualizar</button>
                    <a href="menu.html" class="btn btn-debug">
            <i class="fas fa-home"></i> Menu
        </a>
                </div>
            </div>
        </header>

        <div id="errorMessage"></div>
        
        <div id="debugInfo" class="debug-info" style="display: none;">
            <h3>üêõ Informa√ß√µes de Debug Detalhado</h3>
            <div id="debugContent" class="debug-list"></div>
        </div>

       <!-- KPI Cards -->
<div class="kpi-grid">
    <div class="kpi-card" onclick="filterByCategory('TOTAL')" style="cursor: pointer;" title="Clique para ver todos os registros">
        <div class="kpi-header">
            <div class="kpi-icon">üì¶</div>
            <div class="kpi-trend up" id="trendTotal">‚Üë 0%</div>
        </div>
        <div class="kpi-content">
            <h3>Total de Registros</h3>
            <div class="kpi-value" id="totalRegistros">0</div>
            <p class="kpi-subtitle">Todas as categorias</p>
        </div>
    </div>

    <div class="kpi-card danger" onclick="filterByCategory('FALTA')" style="cursor: pointer;" title="Clique para filtrar por FALTA">
        <div class="kpi-header">
            <div class="kpi-icon">‚ùå</div>
            <div class="kpi-trend" id="trendFalta">0%</div>
        </div>
        <div class="kpi-content">
            <h3>Falta</h3>
            <div class="kpi-value" id="totalFalta">0</div>
            <p class="kpi-subtitle">Produtos em falta</p>
        </div>
    </div>

    <div class="kpi-card warning" onclick="filterByCategory('AVARIA')" style="cursor: pointer;" title="Clique para filtrar por AVARIA">
        <div class="kpi-header">
            <div class="kpi-icon">‚ö†Ô∏è</div>
            <div class="kpi-trend" id="trendAvaria">0%</div>
        </div>
        <div class="kpi-content">
            <h3>Avaria</h3>
            <div class="kpi-value" id="totalAvaria">0</div>
            <p class="kpi-subtitle">Produtos avariados</p>
        </div>
    </div>

    <div class="kpi-card warning" onclick="filterByCategory('VENCIMENTO CURTO')" style="cursor: pointer;" title="Clique para filtrar por VENCIMENTO CURTO">
        <div class="kpi-header">
            <div class="kpi-icon">‚è∞</div>
            <div class="kpi-trend" id="trendVencimento">0%</div>
        </div>
        <div class="kpi-content">
            <h3>Vencimento Curto</h3>
            <div class="kpi-value" id="totalVencimento">0</div>
            <p class="kpi-subtitle">Vencimento pr√≥ximo</p>
        </div>
    </div>

    <div class="kpi-card info" onclick="filterByCategory('NF DIVERGENCIA')" style="cursor: pointer;" title="Clique para filtrar por NF DIVERG√äNCIA">
        <div class="kpi-header">
            <div class="kpi-icon">üìÑ</div>
            <div class="kpi-trend" id="trendDivergencia">0%</div>
        </div>
        <div class="kpi-content">
            <h3>NF Diverg√™ncia</h3>
            <div class="kpi-value" id="totalDivergencia">0</div>
            <p class="kpi-subtitle">Diverg√™ncias de carga</p>
        </div>
    </div>

    <div class="kpi-card danger" onclick="filterByCategory('PRODUTO RECUSADO')" style="cursor: pointer;" title="Clique para filtrar por PRODUTO RECUSADO">
        <div class="kpi-header">
            <div class="kpi-icon">üö´</div>
            <div class="kpi-trend" id="trendRecusado">0%</div>
        </div>
        <div class="kpi-content">
            <h3>Produto Recusado</h3>
            <div class="kpi-value" id="totalRecusado">0</div>
            <p class="kpi-subtitle">Produtos recusados</p>
        </div>
    </div>
</div>


        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <h2>Distribui√ß√£o por Categoria</h2>
                    <p>An√°lise geral de ocorr√™ncias</p>
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2>Tend√™ncia Mensal</h2>
                    <p>Evolu√ß√£o de problemas por m√™s</p>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2>Ocorr√™ncias por Loja</h2>
                    <p>Comparativo entre unidades</p>
                </div>
                <div class="chart-container">
                    <canvas id="lojaChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h2>An√°lise de Fornecedores</h2>
                    <p>Top fornecedores com problemas</p>
                </div>
                <div class="chart-container">
                    <canvas id="fornecedorChart"></canvas>
                </div>
            </div>
        </div>

        <div class="performance-grid">
            <div class="performance-card">
                <div class="performance-header">
                    <span class="performance-title">Taxa de Conformidade</span>
                    <span class="performance-percentage" id="taxaConformidade">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill success" id="progressConformidade" style="width: 0%"></div>
                </div>
            </div>

            <div class="performance-card">
                <div class="performance-header">
                    <span class="performance-title">√çndice de Qualidade</span>
                    <span class="performance-percentage" id="indiceQualidade">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressQualidade" style="width: 0%"></div>
                </div>
            </div>

            <div class="performance-card">
                <div class="performance-header">
                    <span class="performance-title">Taxa de Rejei√ß√£o</span>
                    <span class="performance-percentage" id="taxaRejeicao">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill danger" id="progressRejeicao" style="width: 0%"></div>
                </div>
            </div>

            <div class="performance-card">
                <div class="performance-header">
                    <span class="performance-title">Efici√™ncia Operacional</span>
                    <span class="performance-percentage" id="eficienciaOperacional">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressEficiencia" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="filters-section">
            <div class="filters-header">
                <h2>üîç Filtros Avan√ßados</h2>
                <button class="btn btn-secondary" onclick="resetFilters()">Limpar Filtros</button>
            </div>
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Buscar Produto</label>
                    <input type="text" id="searchProduto" placeholder="Digite o nome do produto...">
                </div>
                <div class="filter-group">
                    <label>Loja</label>
                    <select id="filterLoja">
                        <option value="">Todas as Lojas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Fornecedor</label>
                    <select id="filterFornecedor">
                        <option value="">Todos os Fornecedores</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Categoria</label>
                    <select id="filterCategoria">
                        <option value="">Todas as Categorias</option>
                        <option value="FALTA">Falta</option>
                        <option value="AVARIA">Avaria</option>
                        <option value="VENCIMENTO">Vencimento Curto</option>
                        <option value="DIVERGENCIA">NF Diverg√™ncia</option>
                        <option value="RECUSADO">Produto Recusado</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-header">
                <h2>üìã Detalhamento Completo</h2>
                <span id="tableCount">0 registros</span>
            </div>
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Categoria</th>
                        <th>Loja</th>
                        <th>Produto</th>
                        <th>Fornecedor</th>
                        <th>Lote</th>
                        <th>Fabrica√ß√£o</th>
                        <th>Validade</th>
                        <th>Quantidade</th>
                        <th>Observa√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="9" class="loading">‚è≥ Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycby9vWsXsLnnBZquH80dznX7QigbjCqyglVkkeY2BeUKtxm0tujJdfRlL2I3iWGbLxTN/exec';
        let allData = [];
        let charts = {};
        let debugMode = false;

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugInfo').style.display = debugMode ? 'block' : 'none';
            if (debugMode && allData.length > 0) updateDebugInfo();
        }

        function updateDebugInfo() {
            const categorias = {};
            const categoriasCompletas = {};
            
            allData.forEach(item => {
                const cat = item.Categoria || 'UNDEFINED';
                categorias[cat] = (categorias[cat] || 0) + 1;
                
                if (!categoriasCompletas[cat]) {
                    categoriasCompletas[cat] = [];
                }
                categoriasCompletas[cat].push({
                    Produto: item.Produto,
                    Observacao: item.Observacao
                });
            });

            let debugHTML = `
                <p><strong>Total de registros:</strong> ${allData.length}</p>
                <p><strong>URL da API:</strong> ${API_URL}</p>
                <p><strong>Timestamp:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                <hr style="margin: 10px 0;">
                <p><strong>Contagem por Categoria:</strong></p>
                <ul style="margin-left: 20px;">
            `;
            
            Object.entries(categorias).sort((a, b) => b[1] - a[1]).forEach(([cat, count]) => {
                debugHTML += `<li><strong>${cat}:</strong> ${count} registros</li>`;
            });
            
            debugHTML += `</ul><hr style="margin: 10px 0;"><p><strong>Exemplos por Categoria:</strong></p>`;
            
            Object.entries(categoriasCompletas).forEach(([cat, items]) => {
                debugHTML += `
                    <p style="margin-top: 10px;"><strong>${cat}:</strong></p>
                    <ul style="margin-left: 20px; font-size: 11px;">
                `;
                items.slice(0, 3).forEach(item => {
                    debugHTML += `<li>${item.Produto} - Obs: "${item.Observacao}"</li>`;
                });
                if (items.length > 3) {
                    debugHTML += `<li><em>... e mais ${items.length - 3} itens</em></li>`;
                }
                debugHTML += `</ul>`;
            });
            
            debugHTML += `<hr style="margin: 10px 0;"><p><strong>Primeiros 3 registros (RAW):</strong></p>`;
            debugHTML += `<pre style="font-size: 10px; overflow-x: auto;">${JSON.stringify(allData.slice(0, 3), null, 2)}</pre>`;
            
            document.getElementById('debugContent').innerHTML = debugHTML;
        }

        async function loadData() {
            try {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" class="loading">‚è≥ Carregando dados...</td></tr>';
                document.getElementById('errorMessage').innerHTML = '';

                console.log('üîÑ Carregando dados da API:', API_URL);
                
                const response = await fetch(API_URL, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                console.log('üì° Status da resposta:', response.status);
                
                const result = await response.json();
                console.log('üì¶ Dados recebidos:', result);

                if (!result.success) {
                    throw new Error(result.error || 'Erro ao carregar dados');
                }

                allData = result.data || [];
                
                console.log('‚úÖ Total de registros carregados:', allData.length);
                console.log('üîç Amostra dos primeiros 3 registros:', allData.slice(0, 3));
                
                // Verificar estrutura dos dados
                if (allData.length > 0) {
                    console.log('üìã Campos dispon√≠veis:', Object.keys(allData[0]));
                    console.log('üè∑Ô∏è Categoria do primeiro registro:', allData[0].Categoria);
                }

                updateKPIs();
                updateCharts();
                updatePerformanceIndicators();
                populateFilters();
                renderTable(allData);

                const now = new Date().toLocaleString('pt-BR');
                document.getElementById('lastUpdate').textContent = `√öltima atualiza√ß√£o: ${now} | Total: ${result.totalRecords} registros`;

                if (debugMode) updateDebugInfo();

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                document.getElementById('errorMessage').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Erro ao carregar dados</strong><br>
                        ${error.message}<br>
                        <small>Abra o Console (F12) para mais detalhes</small>
                    </div>
                `;
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" class="loading">‚ùå Erro ao carregar dados</td></tr>';
            }
        }

        function updateKPIs() {
            const total = allData.length;
            console.log('üìä Atualizando KPIs. Total de registros:', total);
            
            const falta = allData.filter(item => item.Categoria === 'FALTA').length;
            const avaria = allData.filter(item => item.Categoria === 'AVARIA').length;
            const vencimento = allData.filter(item => item.Categoria === 'VENCIMENTO CURTO').length;
            const divergencia = allData.filter(item => item.Categoria === 'NF DIVERGENCIA').length;
            const recusado = allData.filter(item => item.Categoria === 'PRODUTO RECUSADO').length;
            
            console.log('üìà KPIs Calculados:', {
                total,
                falta,
                avaria,
                vencimento,
                divergencia,
                recusado
            });

            document.getElementById('totalRegistros').textContent = total;
            document.getElementById('totalFalta').textContent = falta;
            document.getElementById('totalAvaria').textContent = avaria;
            document.getElementById('totalVencimento').textContent = vencimento;
            document.getElementById('totalDivergencia').textContent = divergencia;
            document.getElementById('totalRecusado').textContent = recusado;

            updateTrend('trendFalta', falta, total);
            updateTrend('trendAvaria', avaria, total);
            updateTrend('trendVencimento', vencimento, total);
            updateTrend('trendDivergencia', divergencia, total);
            updateTrend('trendRecusado', recusado, total);
        }

        function updateTrend(id, value, total) {
            const element = document.getElementById(id);
            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
            element.textContent = `${percentage}%`;
            element.className = 'kpi-trend ' + (percentage > 15 ? 'up' : 'down');
        }

        function updatePerformanceIndicators() {
            const total = allData.length;
            const problemas = allData.filter(item => 
                item.Categoria === 'FALTA' || 
                item.Categoria === 'AVARIA' || 
                item.Categoria === 'PRODUTO RECUSADO'
            ).length;

            const conformidade = total > 0 ? ((total - problemas) / total * 100).toFixed(1) : 100;
            document.getElementById('taxaConformidade').textContent = `${conformidade}%`;
            document.getElementById('progressConformidade').style.width = `${conformidade}%`;

            const vencimentos = allData.filter(item => item.Categoria === 'VENCIMENTO CURTO').length;
            const qualidade = total > 0 ? ((total - vencimentos - problemas) / total * 100).toFixed(1) : 100;
            document.getElementById('indiceQualidade').textContent = `${qualidade}%`;
            document.getElementById('progressQualidade').style.width = `${qualidade}%`;

            const recusados = allData.filter(item => item.Categoria === 'PRODUTO RECUSADO').length;
            const rejeicao = total > 0 ? (recusados / total * 100).toFixed(1) : 0;
            document.getElementById('taxaRejeicao').textContent = `${rejeicao}%`;
            document.getElementById('progressRejeicao').style.width = `${rejeicao}%`;

            const divergencias = allData.filter(item => item.Categoria === 'NF DIVERGENCIA').length;
            const eficiencia = total > 0 ? ((total - divergencias) / total * 100).toFixed(1) : 100;
            document.getElementById('eficienciaOperacional').textContent = `${eficiencia}%`;
            document.getElementById('progressEficiencia').style.width = `${eficiencia}%`;
        }

        function updateCharts() {
            createCategoryChart();
            createTrendChart();
            createLojaChart();
            createFornecedorChart();
        }

        function createCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if (charts.category) charts.category.destroy();

            const categorias = {
                'FALTA': allData.filter(item => item.Categoria === 'FALTA').length,
                'AVARIA': allData.filter(item => item.Categoria === 'AVARIA').length,
                'VENCIMENTO': allData.filter(item => item.Categoria === 'VENCIMENTO CURTO').length,
                'DIVERG√äNCIA': allData.filter(item => item.Categoria === 'NF DIVERGENCIA').length,
                'RECUSADO': allData.filter(item => item.Categoria === 'PRODUTO RECUSADO').length
            };

            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        data: Object.values(categorias),
                        backgroundColor: [
                            '#ef4444',
                            '#f59e0b',
                            '#f97316',
                            '#06b6d4',
                            '#dc2626'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function createTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (charts.trend) charts.trend.destroy();

            const meses = ['Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out'];
            const problemasTotal = allData.filter(item => item.Categoria !== 'OK').length;
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Total de Problemas',
                        data: [45, 52, 38, 42, 55, problemasTotal],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createLojaChart() {
            const ctx = document.getElementById('lojaChart');
            if (charts.loja) charts.loja.destroy();

            const lojaCount = {};
            allData.forEach(item => {
                if (item.Loja) {
                    lojaCount[item.Loja] = (lojaCount[item.Loja] || 0) + 1;
                }
            });

            const topLojas = Object.entries(lojaCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            charts.loja = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topLojas.map(l => l[0]),
                    datasets: [{
                        label: 'Ocorr√™ncias',
                        data: topLojas.map(l => l[1]),
                        backgroundColor: '#7c3aed'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createFornecedorChart() {
            const ctx = document.getElementById('fornecedorChart');
            if (charts.fornecedor) charts.fornecedor.destroy();

            const fornecedorCount = {};
            allData.forEach(item => {
                if (item.Fornecedor && item.Fornecedor.trim() !== '') {
                    fornecedorCount[item.Fornecedor] = (fornecedorCount[item.Fornecedor] || 0) + 1;
                }
            });

            const topFornecedores = Object.entries(fornecedorCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            charts.fornecedor = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topFornecedores.map(f => f[0]),
                    datasets: [{
                        label: 'Problemas',
                        data: topFornecedores.map(f => f[1]),
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function populateFilters() {
            const lojas = [...new Set(allData.map(item => item.Loja))].filter(Boolean).sort();
            const fornecedores = [...new Set(allData.map(item => item.Fornecedor))].filter(Boolean).sort();

            const lojaSelect = document.getElementById('filterLoja');
            lojaSelect.innerHTML = '<option value="">Todas as Lojas</option>';
            lojas.forEach(loja => {
                lojaSelect.innerHTML += `<option value="${loja}">${loja}</option>`;
            });

            const fornecedorSelect = document.getElementById('filterFornecedor');
            fornecedorSelect.innerHTML = '<option value="">Todos os Fornecedores</option>';
            fornecedores.forEach(fornecedor => {
                fornecedorSelect.innerHTML += `<option value="${fornecedor}">${fornecedor}</option>`;
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            document.getElementById('tableCount').textContent = `${data.length} registros`;
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="loading">Nenhum dado encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const badgeClass = getBadgeClass(item.Categoria);
                return `
                    <tr>
                        <td><span class="badge ${badgeClass}">${item.Categoria || 'SEM CATEGORIA'}</span></td>
                        <td>${item.Loja || '-'}</td>
                        <td><strong>${item.Produto || '-'}</strong></td>
                        <td>${item.Fornecedor || '-'}</td>
                        <td>${item.Lote || '-'}</td>
                        <td>${item.Fabricacao || '-'}</td>
                        <td>${item.Validade || '-'}</td>
                        <td>${item.Quantidade || '-'}</td>
                        <td>${item.Observacao || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function getBadgeClass(categoria) {
            if (!categoria) return 'badge-sem-categoria';
            if (categoria === 'FALTA') return 'badge-falta';
            if (categoria === 'AVARIA') return 'badge-avaria';
            if (categoria === 'VENCIMENTO CURTO') return 'badge-vencimento';
            if (categoria === 'NF DIVERGENCIA') return 'badge-divergencia';
            if (categoria === 'PRODUTO RECUSADO') return 'badge-recusado';
            if (categoria === 'OK') return 'badge-ok';
            return 'badge-sem-categoria';
        }

        function applyFilters() {
            const searchText = document.getElementById('searchProduto').value.toLowerCase();
            const lojaFilter = document.getElementById('filterLoja').value;
            const fornecedorFilter = document.getElementById('filterFornecedor').value;
            const categoriaFilter = document.getElementById('filterCategoria').value;

            const filtered = allData.filter(item => {
                const matchSearch = !searchText || (item.Produto && item.Produto.toLowerCase().includes(searchText));
                const matchLoja = !lojaFilter || item.Loja === lojaFilter;
                const matchFornecedor = !fornecedorFilter || item.Fornecedor === fornecedorFilter;
                const matchCategoria = !categoriaFilter || (item.Categoria && item.Categoria.includes(categoriaFilter));

                return matchSearch && matchLoja && matchFornecedor && matchCategoria;
            });

            renderTable(filtered);
        }

        function resetFilters() {
            document.getElementById('searchProduto').value = '';
            document.getElementById('filterLoja').value = '';
            document.getElementById('filterFornecedor').value = '';
            document.getElementById('filterCategoria').value = '';
            renderTable(allData);
        }

        function exportData() {
            const csv = convertToCSV(allData);
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard_export_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function convertToCSV(data) {
            const headers = ['Categoria', 'Loja', 'Produto', 'Fornecedor', 'Lote', 'Fabrica√ß√£o', 'Validade', 'Quantidade', 'Observa√ß√£o'];
            const rows = data.map(item => [
                item.Categoria,
                item.Loja,
                item.Produto,
                item.Fornecedor,
                item.Lote,
                item.Fabricacao,
                item.Validade,
                item.Quantidade,
                item.Observacao
            ].map(field => `"${(field || '').toString().replace(/"/g, '""')}"`).join(','));

            return [headers.join(','), ...rows].join('\n');
        }

        document.getElementById('searchProduto').addEventListener('input', applyFilters);
        document.getElementById('filterLoja').addEventListener('change', applyFilters);
        document.getElementById('filterFornecedor').addEventListener('change', applyFilters);
        document.getElementById('filterCategoria').addEventListener('change', applyFilters);

// Vari√°vel para armazenar filtro ativo
let activeFilter = null;

// Fun√ß√£o para filtrar por categoria ao clicar no card
function filterByCategory(categoria) {
    // Se clicar no mesmo filtro, desativar
    if (activeFilter === categoria) {
        activeFilter = null;
        removeFilterBadge();
        removeActiveCards();
        renderTable(allData);
        updateChartsWithFilter(allData);
        return;
    }
    
    // Ativar novo filtro
    activeFilter = categoria;
    
    // Remover classe active de todos os cards
    removeActiveCards();
    
    // Adicionar classe active ao card clicado
    const cards = document.querySelectorAll('.kpi-card');
    cards.forEach(card => {
        const onclick = card.getAttribute('onclick');
        if (onclick && onclick.includes(`'${categoria}'`)) {
            card.classList.add('active');
        }
    });
    
    // Filtrar dados
    let filteredData;
    if (categoria === 'TOTAL') {
        filteredData = allData;
    } else {
        filteredData = allData.filter(item => item.Categoria === categoria);
    }
    
    // Atualizar tabela
    renderTable(filteredData);
    
    // Atualizar gr√°ficos
    updateChartsWithFilter(filteredData);
    
    // Mostrar badge de filtro ativo
    showFilterBadge(categoria);
    
    // Scroll suave at√© a tabela
    document.querySelector('.table-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// Remover classe active de todos os cards
function removeActiveCards() {
    document.querySelectorAll('.kpi-card').forEach(card => {
        card.classList.remove('active');
    });
}

// Mostrar badge de filtro ativo
function showFilterBadge(categoria) {
    removeFilterBadge();
    
    const badge = document.createElement('div');
    badge.className = 'filter-badge';
    badge.id = 'filterBadge';
    badge.innerHTML = `
        <span>üîç Filtrado por: <strong>${categoria}</strong></span>
        <button onclick="clearCategoryFilter()">‚úï Limpar</button>
    `;
    document.body.appendChild(badge);
}

// Remover badge de filtro
function removeFilterBadge() {
    const badge = document.getElementById('filterBadge');
    if (badge) badge.remove();
}

// Limpar filtro de categoria
function clearCategoryFilter() {
    activeFilter = null;
    removeFilterBadge();
    removeActiveCards();
    renderTable(allData);
    updateChartsWithFilter(allData);
}

// Atualizar gr√°ficos com dados filtrados
function updateChartsWithFilter(data) {
    // Atualizar gr√°fico de categorias
    const ctx = document.getElementById('categoryChart');
    if (charts.category) charts.category.destroy();
    
    const categorias = {
        'FALTA': data.filter(item => item.Categoria === 'FALTA').length,
        'AVARIA': data.filter(item => item.Categoria === 'AVARIA').length,
        'VENCIMENTO': data.filter(item => item.Categoria === 'VENCIMENTO CURTO').length,
        'DIVERG√äNCIA': data.filter(item => item.Categoria === 'NF DIVERGENCIA').length,
        'RECUSADO': data.filter(item => item.Categoria === 'PRODUTO RECUSADO').length
    };

    charts.category = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categorias),
            datasets: [{
                data: Object.values(categorias),
                backgroundColor: ['#ef4444', '#f59e0b', '#f97316', '#06b6d4', '#dc2626']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
    
    // Atualizar gr√°fico por loja
    const ctxLoja = document.getElementById('lojaChart');
    if (charts.loja) charts.loja.destroy();

    const lojaCount = {};
    data.forEach(item => {
        if (item.Loja) {
            lojaCount[item.Loja] = (lojaCount[item.Loja] || 0) + 1;
        }
    });

    const topLojas = Object.entries(lojaCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    charts.loja = new Chart(ctxLoja, {
        type: 'bar',
        data: {
            labels: topLojas.map(l => l[0]),
            datasets: [{
                label: 'Ocorr√™ncias',
                data: topLojas.map(l => l[1]),
                backgroundColor: '#7c3aed'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
    
    // Atualizar gr√°fico por fornecedor
    const ctxFornecedor = document.getElementById('fornecedorChart');
    if (charts.fornecedor) charts.fornecedor.destroy();

    const fornecedorCount = {};
    data.forEach(item => {
        if (item.Fornecedor && item.Fornecedor.trim() !== '') {
            fornecedorCount[item.Fornecedor] = (fornecedorCount[item.Fornecedor] || 0) + 1;
        }
    });

    const topFornecedores = Object.entries(fornecedorCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

    charts.fornecedor = new Chart(ctxFornecedor, {
        type: 'bar',
        data: {
            labels: topFornecedores.map(f => f[0]),
            datasets: [{
                label: 'Problemas',
                data: topFornecedores.map(f => f[1]),
                backgroundColor: '#f59e0b'
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
        }
    });
}

// Modificar fun√ß√£o applyFilters para respeitar filtro ativo
const originalApplyFilters = applyFilters;
function applyFilters() {
    const searchText = document.getElementById('searchProduto').value.toLowerCase();
    const lojaFilter = document.getElementById('filterLoja').value;
    const fornecedorFilter = document.getElementById('filterFornecedor').value;
    const categoriaFilter = document.getElementById('filterCategoria').value;

    let dataToFilter = activeFilter && activeFilter !== 'TOTAL' 
        ? allData.filter(item => item.Categoria === activeFilter)
        : allData;

    const filtered = dataToFilter.filter(item => {
        const matchSearch = !searchText || (item.Produto && item.Produto.toLowerCase().includes(searchText));
        const matchLoja = !lojaFilter || item.Loja === lojaFilter;
        const matchFornecedor = !fornecedorFilter || item.Fornecedor === fornecedorFilter;
        const matchCategoria = !categoriaFilter || (item.Categoria && item.Categoria.includes(categoriaFilter));

        return matchSearch && matchLoja && matchFornecedor && matchCategoria;
    });

    renderTable(filtered);
}

// Modificar resetFilters para limpar filtro de categoria tamb√©m
const originalResetFilters = resetFilters;
function resetFilters() {
    document.getElementById('searchProduto').value = '';
    document.getElementById('filterLoja').value = '';
    document.getElementById('filterFornecedor').value = '';
    document.getElementById('filterCategoria').value = '';
    clearCategoryFilter();
}


        loadData();
        setInterval(loadData, 300000);
    </script>
</body>
</html>
