<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscar Produtos - Plantebem</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { background: white; padding: 25px 30px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .header h1 { font-size: 2em; color: #333; }
    .header-buttons { display: flex; gap: 10px; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; }
    .btn-back { background: #667eea; color: white; }
    .btn-back:hover { background: #5568d3; }
    .btn-logout { background: #f44336; color: white; }
    .btn-logout:hover { background: #d32f2f; }
    .search-container { background: white; padding: 40px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
    .search-title { font-size: 1.5em; color: #333; margin-bottom: 10px; text-align: center; }
    .search-subtitle { color: #666; text-align: center; margin-bottom: 30px; }
    .search-mode-toggle { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    .mode-btn { padding: 12px 30px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .mode-btn:hover, .mode-btn.active { background: #667eea; color: white; }
    .search-box { position: relative; max-width: 600px; margin: 0 auto; }
    .search-input { width: 100%; padding: 20px 60px 20px 20px; border: 3px solid #e0e0e0; border-radius: 50px; font-size: 1.2em; transition: all 0.3s ease; }
    .search-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 5px rgba(102, 126, 234, 0.1); }
    .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 1.5em; color: #667eea; }
    .search-multi { max-width: 800px; margin: 0 auto; display: none; }
    .search-multi.active { display: block; }
    .search-textarea { width: 100%; min-height: 200px; padding: 20px; border: 3px solid #e0e0e0; border-radius: 15px; font-size: 1.1em; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; resize: vertical; transition: all 0.3s ease; }
    .search-textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 5px rgba(102, 126, 234, 0.1); }
    .textarea-hint { text-align: center; color: #999; font-size: 0.9em; margin-top: 10px; }
    .btn-search-multi { width: 100%; padding: 18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 1.2em; font-weight: 700; cursor: pointer; transition: all 0.3s ease; margin-top: 15px; }
    .btn-search-multi:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    .results-info { text-align: center; margin-top: 20px; color: #666; font-size: 1.1em; }
    .quick-filters { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
    .filter-btn { padding: 10px 20px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .filter-btn:hover, .filter-btn.active { background: #667eea; color: white; }
    .results-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); min-height: 400px; }
    .results-title { font-size: 1.3em; color: #333; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0; }
    .result-item { background: #f8f9fa; padding: 25px; margin-bottom: 20px; border-radius: 10px; border-left: 5px solid #667eea; transition: all 0.3s ease; }
    .result-item:hover { transform: translateX(5px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
    .result-item.warning { border-left-color: #ff9800; background: #fff3e0; }
    .result-item.danger { border-left-color: #f44336; background: #ffebee; }
    .product-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; gap: 15px; flex-wrap: wrap; }
    .product-name { font-size: 1.3em; font-weight: 700; color: #333; }
    .location-badge { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em; white-space: nowrap; }
    .product-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
    .detail-item { display: flex; flex-direction: column; }
    .detail-label { font-size: 0.85em; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
    .detail-value { font-size: 1.05em; color: #333; font-weight: 600; }
    .validade-status { display: inline-block; padding: 6px 15px; border-radius: 15px; font-weight: 600; font-size: 0.9em; }
    .validade-status.vencido { background: #ffcdd2; color: #c62828; }
    .validade-status.proximo { background: #ffe0b2; color: #e65100; }
    .validade-status.ok { background: #c8e6c9; color: #2e7d32; }
    .no-results { text-align: center; padding: 60px 20px; color: #999; }
    .no-results-icon { font-size: 5em; margin-bottom: 20px; }
    .no-results-text { font-size: 1.3em; color: #666; }
    .search-summary { background: #e3f2fd; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #2196f3; }
    .search-summary-title { font-weight: 700; color: #1976d2; margin-bottom: 8px; }
    .search-summary-info { color: #555; font-size: 0.95em; }
    .loading { text-align: center; padding: 40px; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media (max-width: 768px) { .product-header { flex-direction: column; } .product-details { grid-template-columns: 1fr; } .search-mode-toggle { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîç Buscar Produtos - Deposito Fertilizantes</h1>
      <div class="header-buttons">
        <a href="mapa-deposito.html" class="btn btn-back">‚Üê Voltar ao Mapa</a>
        <button id="logout-button" class="btn btn-logout">Sair</button>
      </div>
    </div>

    <div class="search-container">
      <h2 class="search-title">Busca R√°pida de Produtos</h2>
      <p class="search-subtitle">Pesquise um ou v√°rios produtos ao mesmo tempo</p>
      
      <div class="search-mode-toggle">
        <button class="mode-btn active" id="mode-single">üîç Busca Individual</button>
        <button class="mode-btn" id="mode-multi">üìã Busca M√∫ltipla</button>
      </div>

      <div class="search-box" id="search-box-single">
        <input type="text" id="search-input" class="search-input" placeholder="Ex: Adubo NPK ou L2024-001..." autocomplete="off">
        <span class="search-icon">üîç</span>
      </div>

      <div class="search-multi" id="search-box-multi">
        <textarea id="search-textarea" class="search-textarea" placeholder="Cole aqui v√°rios produtos ou lotes (um por linha)

Exemplo:
Adubo NPK
L2024-001
Ureia 45%
Sal Mineral"></textarea>
        <div class="textarea-hint">üí° Dica: Cole cada produto ou lote em uma linha separada</div>
        <button class="btn-search-multi" id="btn-search-multi">üîç Buscar Todos</button>
      </div>

      <div class="quick-filters">
        <button class="filter-btn active" data-filter="todos">Todos</button>
        <button class="filter-btn" data-filter="vencido">Vencidos</button>
        <button class="filter-btn" data-filter="proximo">Vencimento Pr√≥ximo</button>
        <button class="filter-btn" data-filter="ok">Validade OK</button>
      </div>

      <div class="results-info" id="results-info">Digite algo para come√ßar a busca</div>
    </div>

    <div class="results-container" id="results-container">
      <h3 class="results-title" id="results-title" style="display: none;">Resultados da Busca</h3>
      <div id="results-list">
        <div class="loading"><div class="loading-spinner"></div><p>Carregando produtos...</p></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyD8GjaS3tuDpSvBl2-bpa-QXIKTqq80Mn4",
      authDomain: "login-com-dados.firebaseapp.com",
      projectId: "login-com-dados",
      storageBucket: "login-com-dados.firebasestorage.app",
      messagingSenderId: "75556023458",
      appId: "1:75556023458:web:9f1362d0597603c0f37bfb",
      measurementId: "G-W9LRT99579"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let todosOsProdutos = [];
    let filtroValidade = 'todos';
    let modoAtual = 'single';

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = 'index.html';
      else carregarProdutos();
    });

    document.getElementById('logout-button').addEventListener('click', () => {
      signOut(auth).then(() => window.location.href = 'index.html');
    });

    async function carregarProdutos() {
      try {
        const q = query(collection(db, 'deposito'), orderBy('criadoEm', 'desc'));
        const snapshot = await getDocs(q);
        todosOsProdutos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        mostrarMensagemInicial();
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        document.getElementById('results-list').innerHTML = `
          <div class="no-results">
            <div class="no-results-icon">‚ùå</div>
            <div class="no-results-text">Erro ao carregar produtos</div>
          </div>`;
      }
    }

    function calcularStatusValidade(validade) {
      const hoje = new Date();
      const dataValidade = new Date(validade);
      const diasRestantes = Math.floor((dataValidade - hoje) / (1000 * 60 * 60 * 24));
      if (diasRestantes < 0) return 'vencido';
      if (diasRestantes <= 30) return 'proximo';
      return 'ok';
    }

    function formatarData(data) {
      const [ano, mes, dia] = data.split('-');
      return `${dia}/${mes}/${ano}`;
    }

    function buscarProdutos(termos) {
      if (!Array.isArray(termos)) termos = [termos];
      termos = termos.filter(t => t && t.trim() !== '');

      if (termos.length === 0) {
        mostrarMensagemInicial();
        return;
      }

      let resultados = [];
      termos.forEach(termo => {
        const termoLower = termo.toLowerCase().trim();
        const encontrados = todosOsProdutos.filter(produto => {
          const matchNome = produto.nome.toLowerCase().includes(termoLower);
          const matchLote = produto.lote.toLowerCase().includes(termoLower);
          return matchNome || matchLote;
        });
        resultados = resultados.concat(encontrados);
      });

      const resultadosUnicos = Array.from(new Set(resultados.map(p => JSON.stringify(p)))).map(p => JSON.parse(p));
      let resultadosFiltrados = resultadosUnicos;
      
      if (filtroValidade !== 'todos') {
        resultadosFiltrados = resultadosUnicos.filter(produto => {
          return calcularStatusValidade(produto.validade) === filtroValidade;
        });
      }

      exibirResultados(resultadosFiltrados, termos);
    }

    function exibirResultados(produtos, termos) {
      const container = document.getElementById('results-list');
      const title = document.getElementById('results-title');
      const info = document.getElementById('results-info');

      title.style.display = 'block';
      
      if (produtos.length === 0) {
        info.textContent = `Nenhum produto encontrado`;
        container.innerHTML = `
          <div class="no-results">
            <div class="no-results-icon">üòï</div>
            <div class="no-results-text">Nenhum produto encontrado</div>
          </div>`;
        return;
      }

      const termosTexto = Array.isArray(termos) ? termos.join(', ') : termos;
      info.textContent = `${produtos.length} produto${produtos.length !== 1 ? 's' : ''} encontrado${produtos.length !== 1 ? 's' : ''}`;

      let html = '';

      if (Array.isArray(termos) && termos.length > 1) {
        html += `
          <div class="search-summary">
            <div class="search-summary-title">üìã Busca M√∫ltipla</div>
            <div class="search-summary-info">Buscando por ${termos.length} termo(s): ${termosTexto}</div>
          </div>`;
      }

      html += produtos.map(produto => {
        const status = calcularStatusValidade(produto.validade);
        const statusClass = status === 'vencido' ? 'danger' : status === 'proximo' ? 'warning' : '';
        const statusText = status === 'vencido' ? '‚ùå VENCIDO' : status === 'proximo' ? '‚ö†Ô∏è VENCIMENTO PR√ìXIMO' : '‚úÖ VALIDADE OK';
        const statusBadgeClass = status === 'vencido' ? 'vencido' : status === 'proximo' ? 'proximo' : 'ok';

        return `
          <div class="result-item ${statusClass}">
            <div class="product-header">
              <div class="product-name">${produto.nome}</div>
              <div class="location-badge">üìç ${produto.rua} - V${produto.vao} - N${produto.nivel} - P${produto.pallet}</div>
            </div>
            <div class="product-details">
              <div class="detail-item"><div class="detail-label">Lote</div><div class="detail-value">${produto.lote}</div></div>
              <div class="detail-item"><div class="detail-label">Validade</div><div class="detail-value">${formatarData(produto.validade)}</div></div>
              <div class="detail-item"><div class="detail-label">Status</div><div class="detail-value"><span class="validade-status ${statusBadgeClass}">${statusText}</span></div></div>
              <div class="detail-item"><div class="detail-label">Cadastrado por</div><div class="detail-value">${produto.criadoPor || 'Sistema'}</div></div>
              <div class="detail-item"><div class="detail-label">Data cadastro</div><div class="detail-value">${produto.criadoEm || 'N/A'}</div></div>
            </div>
          </div>`;
      }).join('');

      container.innerHTML = html;
    }

    function mostrarMensagemInicial() {
      const container = document.getElementById('results-list');
      const title = document.getElementById('results-title');
      const info = document.getElementById('results-info');

      title.style.display = 'none';
      info.textContent = 'Digite algo para come√ßar a busca';
      container.innerHTML = `
        <div class="no-results">
          <div class="no-results-icon">üì¶</div>
          <div class="no-results-text">Use a busca acima para encontrar produtos</div>
        </div>`;
    }

    document.getElementById('mode-single').addEventListener('click', () => {
      modoAtual = 'single';
      document.getElementById('mode-single').classList.add('active');
      document.getElementById('mode-multi').classList.remove('active');
      document.getElementById('search-box-single').style.display = 'block';
      document.getElementById('search-box-multi').classList.remove('active');
      mostrarMensagemInicial();
    });

    document.getElementById('mode-multi').addEventListener('click', () => {
      modoAtual = 'multi';
      document.getElementById('mode-multi').classList.add('active');
      document.getElementById('mode-single').classList.remove('active');
      document.getElementById('search-box-single').style.display = 'none';
      document.getElementById('search-box-multi').classList.add('active');
      mostrarMensagemInicial();
    });

    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', (e) => {
      buscarProdutos(e.target.value);
    });

    document.getElementById('btn-search-multi').addEventListener('click', () => {
      const textarea = document.getElementById('search-textarea');
      const termos = textarea.value.split('\n').map(t => t.trim()).filter(t => t !== '');
      if (termos.length === 0) {
        alert('‚ö†Ô∏è Digite pelo menos um produto para buscar!');
        return;
      }
      buscarProdutos(termos);
    });

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filtroValidade = btn.getAttribute('data-filter');
        
        if (modoAtual === 'single') {
          buscarProdutos(searchInput.value);
        } else {
          const textarea = document.getElementById('search-textarea');
          const termos = textarea.value.split('\n').map(t => t.trim()).filter(t => t !== '');
          if (termos.length > 0) buscarProdutos(termos);
        }
      });
    });

    searchInput.focus();
  </script>
</body>
</html>
