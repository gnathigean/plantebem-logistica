<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/tema.css" /> 
  <title>Gerenciar Usu√°rios - Sistema de Recebimento</title>

  <style>
    .container {
      max-width: 1200px;
      margin: 50px auto;
      padding: 30px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    #main-content {
      display: none; 
    }

    #acesso-negado {
      color: red;
      text-align: center;
      padding: 20px;
      border: 1px solid #ffdddd;
      background-color: #ffeeee;
      margin-top: 50px;
      border-radius: 8px;
    }

    .usuarios-grid {
      display: grid;
      gap: 20px;
      margin-top: 30px;
    }

    .usuario-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      position: relative;
    }

    .usuario-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .usuario-card.admin {
      background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
      color: white;
    }

    .usuario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    }

    .usuario-nome {
      font-size: 1.4em;
      font-weight: bold;
    }

    .usuario-tipo {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .usuario-tipo.admin {
      background-color: #ff9800;
      color: white;
    }

    .usuario-tipo.usuario {
      background-color: #2196f3;
      color: white;
    }

    .usuario-info {
      margin: 10px 0;
      font-size: 0.95em;
    }

    .usuario-info strong {
      display: inline-block;
      min-width: 100px;
    }

    .lojas-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .loja-tag {
      padding: 6px 12px;
      background: white;
      color: #667eea;
      border-radius: 15px;
      font-size: 0.85em;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .usuario-card.admin .loja-tag {
      background: rgba(255, 255, 255, 0.3);
      color: white;
    }

    .btn-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-editar, .btn-excluir {
      flex: 1;
      padding: 12px 25px;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95em;
    }

    .btn-editar {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    }

    .btn-editar:hover {
      background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    .btn-excluir {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }

    .btn-excluir:hover {
      background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
    }

    .btn-editar:disabled, .btn-excluir:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      text-align: center;
      padding: 50px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .mensagem-status {
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
    }

    .mensagem-status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .mensagem-status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .total-usuarios {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }

    .total-usuarios h3 {
      margin: 0;
      font-size: 2em;
    }

    .protecao-admin {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      color: #856404;
      font-size: 0.9em;
      font-weight: 600;
    }

    /* MODAL DE EDI√á√ÉO */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      max-width: 600px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideDown 0.3s;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5em;
    }

    .close {
      color: white;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .close:hover {
      transform: scale(1.2);
    }

    .modal-body {
      padding: 30px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #333;
      font-size: 1.05em;
    }

    .lojas-checkboxes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .checkbox-item:hover {
      background: #e3f2fd;
      transform: translateX(3px);
    }

    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
    }

    .modal-actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn-salvar, .btn-cancelar {
      flex: 1;
      padding: 14px 25px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.05em;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-salvar {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      color: white;
    }

    .btn-salvar:hover {
      background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    .btn-cancelar {
      background: #6c757d;
      color: white;
    }

    .btn-cancelar:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    .usuario-info-modal {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }

    .usuario-info-modal p {
      margin: 5px 0;
      color: #495057;
    }

    .usuario-info-modal strong {
      color: #667eea;
    }

    .select-all-container {
      margin-bottom: 15px;
      padding: 12px;
      background: #e3f2fd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .select-all-container input[type="checkbox"] {
      width: 22px;
      height: 22px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .select-all-container label {
      font-weight: 600;
      color: #1976d2;
      cursor: pointer;
      margin: 0;
    }

    /* SE√á√ÉO ADMIN */
    .admin-section {
      background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      color: white;
    }

    .admin-section h3 {
      margin: 0 0 15px 0;
      font-size: 1.2em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .admin-toggle {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .admin-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 30px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch.active {
      background: #4caf50;
    }

    .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(30px);
    }

    .toggle-label {
      flex: 1;
      font-weight: 600;
      font-size: 1.05em;
    }

    .admin-warning {
      background: rgba(255, 255, 255, 0.2);
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      font-size: 0.9em;
      border-left: 4px solid rgba(255, 255, 255, 0.5);
    }

    .admin-warning strong {
      display: block;
      margin-bottom: 5px;
    }

    input[type="checkbox"].admin-checkbox {
      display: none;
    }
  </style>
</head>

<body>
  
  <div class="fixed-nav">
    <a href="menu.html" class="botao-menu">‚Üê Menu</a> 
    <button id="logout-button" style="display: none;">Sair</button>
  </div>
    
  <div id="loading" class="container loading">
    <p>Verificando acesso e carregando usu√°rios...</p>
    <div class="loading-spinner"></div>
  </div>
    
  <div id="acesso-negado" style="display: none;">
    <h2>Acesso Negado üõë</h2>
    <p>Esta p√°gina √© exclusiva para administradores. Por favor, fa√ßa login com a conta correta.</p>
  </div>

  <div id="main-content" class="container">
    <h1>üóëÔ∏è Gerenciamento de Usu√°rios</h1>
    
    <div class="total-usuarios" id="total-usuarios">
      <h3>Carregando...</h3>
    </div>

    <div class="protecao-admin">
      ‚ö†Ô∏è <strong>ATEN√á√ÉO:</strong> Voc√™ n√£o pode excluir sua pr√≥pria conta de administrador enquanto estiver logado.
    </div>
    
    <div id="status" class="mensagem-status" style="display: none;"></div>
    
    <div class="usuarios-grid" id="usuarios-grid"></div>
  </div>

  <!-- MODAL DE EDI√á√ÉO -->
  <div id="editarLojasModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚úèÔ∏è Editar Usu√°rio</h2>
        <span class="close" id="closeModal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="usuario-info-modal" id="usuarioInfoModal">
          <!-- Info do usu√°rio ser√° inserida aqui -->
        </div>

        <form id="editarLojasForm">
          <!-- SE√á√ÉO ADMIN -->
          <div class="admin-section">
            <h3>üîë Permiss√µes de Administrador</h3>
            <div class="admin-toggle" id="adminToggle">
              <input type="checkbox" id="isAdminCheckbox" class="admin-checkbox">
              <div class="toggle-switch" id="toggleSwitch">
                <div class="toggle-slider"></div>
              </div>
              <div class="toggle-label">
                <span id="adminStatusText">Usu√°rio Comum</span>
              </div>
            </div>
            <div class="admin-warning">
              <strong>‚ö†Ô∏è Aten√ß√£o:</strong>
              Administradores t√™m acesso total ao sistema, incluindo gerenciar outros usu√°rios e configura√ß√µes sens√≠veis. Use esta op√ß√£o com cautela.
            </div>
          </div>

          <!-- LOJAS -->
          <div class="form-group">
            <label>üè¢ Selecione as lojas que o usu√°rio ter√° acesso:</label>
            
            <div class="select-all-container">
              <input type="checkbox" id="selectAll">
              <label for="selectAll">‚úÖ Selecionar / Desmarcar Todas</label>
            </div>

            <div class="lojas-checkboxes" id="lojasCheckboxes">
              <!-- Checkboxes ser√£o gerados dinamicamente -->
            </div>
          </div>

          <div class="modal-actions">
            <button type="submit" class="btn-salvar">üíæ Salvar Altera√ß√µes</button>
            <button type="button" class="btn-cancelar" id="cancelarModal">‚ùå Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, doc, deleteDoc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyD8GjaS3tuDpSvBl2-bpa-QXIKTqq80Mn4",
      authDomain: "login-com-dados.firebaseapp.com",
      projectId: "login-com-dados",
      storageBucket: "login-com-dados.firebasestorage.app",
      messagingSenderId: "7.5556023458e+10",
      appId: "1:7.5556023458e+10:web:9f1362d0597603c0f37bfb",
      measurementId: "G-W9LRT99579"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    const ADMIN_UID = "O02XwNu2KSNCCk0xCvdBE2YxW9G2";
    
    const LOJAS_MAP = {
      'matriz': 'Matriz',
      'juazeiro': 'Filial Juazeiro',
      'loteamento': 'Filial Loteamento',
      'irece': 'Filial Irec√™',
      'rioreal': 'Filial Rio Real',
      'agroexpress': 'Agroexpress',
      'grandesafra': 'Grande Safra'
    };
    
    const mainContent = document.getElementById("main-content");
    const loadingDiv = document.getElementById("loading");
    const acessoNegadoDiv = document.getElementById("acesso-negado");
    const logoutButton = document.getElementById("logout-button");
    const statusDiv = document.getElementById("status");
    const usuariosGrid = document.getElementById("usuarios-grid");
    const totalUsuariosDiv = document.getElementById("total-usuarios");
    
    // Elementos do Modal
    const editarLojasModal = document.getElementById("editarLojasModal");
    const closeModal = document.getElementById("closeModal");
    const cancelarModal = document.getElementById("cancelarModal");
    const editarLojasForm = document.getElementById("editarLojasForm");
    const usuarioInfoModal = document.getElementById("usuarioInfoModal");
    const lojasCheckboxes = document.getElementById("lojasCheckboxes");
    const selectAllCheckbox = document.getElementById("selectAll");
    
    // Elementos Admin Toggle
    const adminToggle = document.getElementById("adminToggle");
    const toggleSwitch = document.getElementById("toggleSwitch");
    const isAdminCheckbox = document.getElementById("isAdminCheckbox");
    const adminStatusText = document.getElementById("adminStatusText");
    
    let usuarioAtualEditando = null;

    function showStatus(text, type) {
      statusDiv.textContent = text;
      statusDiv.className = `mensagem-status ${type}`;
      statusDiv.style.display = 'block';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    async function carregarUsuarios() {
      try {
        const usuariosSnapshot = await getDocs(collection(db, "usuarios"));
        const usuarios = [];
        
        usuariosSnapshot.forEach((doc) => {
          usuarios.push({
            uid: doc.id,
            ...doc.data()
          });
        });
        
        totalUsuariosDiv.innerHTML = `<h3>üìä Total: ${usuarios.length} usu√°rio${usuarios.length !== 1 ? 's' : ''} cadastrado${usuarios.length !== 1 ? 's' : ''}</h3>`;
        
        renderizarUsuarios(usuarios);
        
      } catch (error) {
        console.error('Erro ao carregar usu√°rios:', error);
        showStatus('‚ùå Erro ao carregar lista de usu√°rios.', 'error');
      }
    }

    function renderizarUsuarios(usuarios) {
      usuariosGrid.innerHTML = '';
      
      if (usuarios.length === 0) {
        usuariosGrid.innerHTML = '<p style="text-align: center; color: #999;">Nenhum usu√°rio cadastrado ainda.</p>';
        return;
      }
      
      usuarios.sort((a, b) => {
        if (a.isAdmin && !b.isAdmin) return -1;
        if (!a.isAdmin && b.isAdmin) return 1;
        return (a.nome || '').localeCompare(b.nome || '');
      });
      
      usuarios.forEach(usuario => {
        const isCurrentUser = auth.currentUser && usuario.uid === auth.currentUser.uid;
        const isAdmin = usuario.isAdmin || usuario.tipo === 'admin';
        
        const lojasHtml = usuario.lojasPermitidas && usuario.lojasPermitidas.length > 0
          ? usuario.lojasPermitidas.map(lojaKey => 
              `<span class="loja-tag">${LOJAS_MAP[lojaKey] || lojaKey}</span>`
            ).join('')
          : '<span class="loja-tag">Nenhuma loja</span>';
        
        const card = document.createElement('div');
        card.className = `usuario-card ${isAdmin ? 'admin' : ''}`;
        card.innerHTML = `
          <div class="usuario-header">
            <div class="usuario-nome">${usuario.nome || 'Sem nome'}</div>
            <span class="usuario-tipo ${isAdmin ? 'admin' : 'usuario'}">
              ${isAdmin ? 'üîë Admin' : 'üë§ Usu√°rio'}
            </span>
          </div>
          
          <div class="usuario-info">
            <strong>üìß E-mail:</strong> ${usuario.email || 'N/A'}
          </div>
          
          <div class="usuario-info">
            <strong>üìÖ Criado em:</strong> ${usuario.criadoEm ? new Date(usuario.criadoEm).toLocaleDateString('pt-BR') : 'N/A'}
          </div>
          
          <div class="usuario-info">
            <strong>‚úÖ Status:</strong> ${usuario.ativo ? 'üü¢ Ativo' : 'üî¥ Inativo'}
          </div>
          
          <div class="usuario-info">
            <strong>üè¢ Lojas permitidas:</strong>
            <div class="lojas-tags">${lojasHtml}</div>
          </div>
          
          <div class="btn-actions">
            <button 
              class="btn-editar" 
              data-uid="${usuario.uid}"
            >
              ‚úèÔ∏è Editar Usu√°rio
            </button>
            <button 
              class="btn-excluir" 
              data-uid="${usuario.uid}"
              data-nome="${usuario.nome}"
              data-email="${usuario.email}"
              ${isCurrentUser ? 'disabled' : ''}
            >
              ${isCurrentUser ? 'üõ°Ô∏è Sua Conta' : 'üóëÔ∏è Excluir'}
            </button>
          </div>
        `;
        
        usuariosGrid.appendChild(card);
      });
      
      document.querySelectorAll('.btn-excluir:not([disabled])').forEach(btn => {
        btn.addEventListener('click', handleExcluirUsuario);
      });
      
      document.querySelectorAll('.btn-editar').forEach(btn => {
        btn.addEventListener('click', handleEditarLojas);
      });
    }

    // ========================================
    // FUN√á√ïES DO MODAL DE EDI√á√ÉO
    // ========================================

    async function handleEditarLojas(event) {
      const uid = event.target.getAttribute('data-uid');
      
      try {
        const userDoc = await getDoc(doc(db, "usuarios", uid));
        
        if (!userDoc.exists()) {
          showStatus('‚ùå Usu√°rio n√£o encontrado.', 'error');
          return;
        }
        
        usuarioAtualEditando = {
          uid: uid,
          ...userDoc.data()
        };
        
        abrirModalEdicao();
        
      } catch (error) {
        console.error('Erro ao carregar dados do usu√°rio:', error);
        showStatus('‚ùå Erro ao carregar dados do usu√°rio.', 'error');
      }
    }

    function abrirModalEdicao() {
      const usuario = usuarioAtualEditando;
      
      // Preencher informa√ß√µes do usu√°rio
      usuarioInfoModal.innerHTML = `
        <p><strong>üë§ Nome:</strong> ${usuario.nome || 'N/A'}</p>
        <p><strong>üìß E-mail:</strong> ${usuario.email || 'N/A'}</p>
      `;
      
      // Configurar toggle de Admin
      const isAdmin = usuario.isAdmin || usuario.tipo === 'admin';
      isAdminCheckbox.checked = isAdmin;
      
      if (isAdmin) {
        toggleSwitch.classList.add('active');
        adminStatusText.textContent = 'üîë Administrador';
      } else {
        toggleSwitch.classList.remove('active');
        adminStatusText.textContent = 'Usu√°rio Comum';
      }
      
      // Criar checkboxes das lojas
      lojasCheckboxes.innerHTML = '';
      const lojasPermitidas = usuario.lojasPermitidas || [];
      
      Object.entries(LOJAS_MAP).forEach(([key, nome]) => {
        const isChecked = lojasPermitidas.includes(key);
        
        const checkboxItem = document.createElement('div');
        checkboxItem.className = 'checkbox-item';
        checkboxItem.innerHTML = `
          <input 
            type="checkbox" 
            id="loja-${key}" 
            name="lojas" 
            value="${key}"
            ${isChecked ? 'checked' : ''}
          >
          <label for="loja-${key}">${nome}</label>
        `;
        
        lojasCheckboxes.appendChild(checkboxItem);
      });
      
      atualizarSelectAll();
      editarLojasModal.style.display = 'block';
    }

    function fecharModal() {
      editarLojasModal.style.display = 'none';
      usuarioAtualEditando = null;
      editarLojasForm.reset();
    }

    function atualizarSelectAll() {
      const checkboxes = lojasCheckboxes.querySelectorAll('input[type="checkbox"]');
      const totalChecked = Array.from(checkboxes).filter(cb => cb.checked).length;
      selectAllCheckbox.checked = totalChecked === checkboxes.length;
    }

    // Toggle de Admin
    adminToggle.addEventListener('click', function() {
      isAdminCheckbox.checked = !isAdminCheckbox.checked;
      
      if (isAdminCheckbox.checked) {
        toggleSwitch.classList.add('active');
        adminStatusText.textContent = 'üîë Administrador';
      } else {
        toggleSwitch.classList.remove('active');
        adminStatusText.textContent = 'Usu√°rio Comum';
      }
    });

    // Selecionar/Desmarcar Todas
    selectAllCheckbox.addEventListener('change', function() {
      const checkboxes = lojasCheckboxes.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = this.checked;
      });
    });

    lojasCheckboxes.addEventListener('change', function(e) {
      if (e.target.type === 'checkbox') {
        atualizarSelectAll();
      }
    });

    // Fechar modal
    closeModal.addEventListener('click', fecharModal);
    cancelarModal.addEventListener('click', fecharModal);

    window.addEventListener('click', function(event) {
      if (event.target === editarLojasModal) {
        fecharModal();
      }
    });

    // Salvar altera√ß√µes
    editarLojasForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const checkboxes = lojasCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
      const lojasSelecionadas = Array.from(checkboxes).map(cb => cb.value);
      const isAdmin = isAdminCheckbox.checked;
      
      if (lojasSelecionadas.length === 0 && !isAdmin) {
        alert('‚ö†Ô∏è Selecione pelo menos uma loja ou defina como administrador!');
        return;
      }
      
      const btnSalvar = editarLojasForm.querySelector('.btn-salvar');
      btnSalvar.disabled = true;
      btnSalvar.textContent = '‚è≥ Salvando...';
      
      try {
        await updateDoc(doc(db, "usuarios", usuarioAtualEditando.uid), {
          lojasPermitidas: lojasSelecionadas,
          isAdmin: isAdmin,
          tipo: isAdmin ? 'admin' : 'usuario',
          atualizadoEm: new Date().toISOString()
        });
        
        const tipoMsg = isAdmin ? 'Administrador' : 'Usu√°rio comum';
        showStatus(`‚úÖ ${usuarioAtualEditando.nome} atualizado como ${tipoMsg} com sucesso!`, 'success');
        fecharModal();
        await carregarUsuarios();
        
      } catch (error) {
        console.error('Erro ao atualizar usu√°rio:', error);
        showStatus(`‚ùå Erro ao atualizar: ${error.message}`, 'error');
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Altera√ß√µes';
      }
    });

    // ========================================
    // FUN√á√ÉO: EXCLUIR USU√ÅRIO
    // ========================================

    async function handleExcluirUsuario(event) {
      const btn = event.target;
      const uid = btn.getAttribute('data-uid');
      const nome = btn.getAttribute('data-nome');
      const email = btn.getAttribute('data-email');
      
      const confirmacao = confirm(
        `‚ö†Ô∏è ATEN√á√ÉO: Tem certeza que deseja excluir o usu√°rio?\n\n` +
        `Nome: ${nome}\n` +
        `E-mail: ${email}\n\n` +
        `Esta a√ß√£o N√ÉO pode ser desfeita!`
      );
      
      if (!confirmacao) return;
      
      const confirmacaoTexto = prompt('Digite "EXCLUIR" para confirmar:');
      
      if (confirmacaoTexto !== 'EXCLUIR') {
        showStatus('‚ùå Exclus√£o cancelada.', 'error');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Excluindo...';
      
      try {
        await deleteDoc(doc(db, "usuarios", uid));
        
        showStatus(`‚úÖ Usu√°rio ${nome} exclu√≠do com sucesso!`, 'success');
        await carregarUsuarios();
        
      } catch (error) {
        console.error('Erro ao excluir usu√°rio:', error);
        showStatus(`‚ùå Erro ao excluir usu√°rio: ${error.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'üóëÔ∏è Excluir';
      }
    }

    // ========================================
    // AUTENTICA√á√ÉO E INICIALIZA√á√ÉO
    // ========================================

    onAuthStateChanged(auth, async (user) => {
      loadingDiv.style.display = 'none';

      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      logoutButton.style.display = 'inline-block';

      let isAdmin = (user.uid === ADMIN_UID);
      
      try {
        const userDoc = await getDoc(doc(db, "usuarios", user.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.isAdmin === true || userData.tipo === 'admin') {
            isAdmin = true;
          }
        }
      } catch (error) {
        console.error('Erro ao verificar permiss√µes:', error);
      }

      if (isAdmin) {
        mainContent.style.display = 'block'; 
        acessoNegadoDiv.style.display = 'none';
        await carregarUsuarios();
      } else {
        mainContent.style.display = 'none';
        acessoNegadoDiv.style.display = 'block';
      }
    });

    logoutButton.addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = 'index.html';
      }).catch((error) => {
        console.error("Erro ao deslogar:", error);
      });
    });

  </script>
</body>
</html>
