<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gest√£o de Estoque com Contagem - Plantebem</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; height: 100vh; overflow: hidden; }

    /* LAYOUT PRINCIPAL */
    .layout-container { display: flex; height: 100vh; }

    /* SIDEBAR LATERAL */
    .sidebar { width: 260px; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1); overflow-y: auto; }
    .sidebar-header { padding: 25px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .sidebar-logo { display: flex; align-items: center; gap: 12px; }
    .sidebar-logo-icon { font-size: 2em; }
    .sidebar-logo-text h2 { font-size: 1.2em; font-weight: 700; }
    .sidebar-logo-text p { font-size: 0.8em; opacity: 0.9; margin-top: 2px; }

    .sidebar-menu { flex: 1; padding: 20px 0; }
    .menu-section { margin-bottom: 30px; }
    .menu-section-title { padding: 0 20px 10px 20px; font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; font-weight: 600; }
    .menu-item { padding: 12px 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s ease; color: white; text-decoration: none; border-left: 3px solid transparent; }
    .menu-item:hover { background: rgba(255, 255, 255, 0.1); border-left-color: white; }
    .menu-item.active { background: rgba(255, 255, 255, 0.15); border-left-color: white; font-weight: 600; }
    .menu-item-icon { font-size: 1.2em; min-width: 24px; text-align: center; }
    .menu-item-text { flex: 1; font-size: 0.95em; }

    /* CONTE√öDO PRINCIPAL */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* HEADER SUPERIOR */
    .top-header { background: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
    .top-header-left { display: flex; align-items: center; gap: 20px; }
    .page-title { font-size: 1.8em; font-weight: 700; color: #333; }
    .top-header-actions { display: flex; gap: 10px; }
    .btn-header { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
    .btn-export { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; }
    .btn-export:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4); }
    .btn-primary { background: #2196f3; color: white; }
    .btn-primary:hover { background: #1976d2; }
    .btn-success { background: #2ecc71; color: white; }
    .btn-success:hover { background: #27ae60; }

    /* CONTE√öDO DAS P√ÅGINAS */
    .content-area { flex: 1; overflow-y: auto; padding: 30px; }
    .page-section { display: none; }
    .page-section.active { display: block; }

    /* CARDS DE ESTAT√çSTICAS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
    .stat-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .stat-card-title { font-size: 0.9em; color: #666; font-weight: 600; }
    .stat-card-icon { font-size: 1.5em; }
    .stat-card-value { font-size: 2em; font-weight: 700; color: #333; }
    .stat-card-footer { margin-top: 10px; font-size: 0.85em; color: #999; }

    /* SE√á√ÉO DE CONTAGEM */
    .contagem-container { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
    .contagem-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
    .contagem-header h2 { font-size: 1.5em; color: #333; }

    .produto-contagem { background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea; }
    .produto-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .info-item { display: flex; flex-direction: column; }
    .info-label { font-size: 0.85em; color: #666; font-weight: 600; margin-bottom: 5px; }
    .info-value { font-size: 1.1em; color: #333; font-weight: 500; }

    .contagem-input-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px; align-items: end; }
    .input-group { display: flex; flex-direction: column; }
    .input-group label { font-size: 0.9em; color: #666; font-weight: 600; margin-bottom: 8px; }
    .input-group input, .input-group textarea { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border-color 0.3s; }
    .input-group input:focus, .input-group textarea:focus { outline: none; border-color: #667eea; }
    .input-group textarea { resize: vertical; min-height: 80px; grid-column: 1 / -1; }

    .divergencia-display { padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; font-size: 1.2em; font-weight: 700; }
    .divergencia-ok { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
    .divergencia-atencao { background: #fff3cd; color: #856404; border: 2px solid #ffeeba; }
    .divergencia-critica { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }

    .btn-contagem { padding: 12px 30px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em; transition: all 0.3s; }
    .btn-confirmar { background: #2ecc71; color: white; }
    .btn-confirmar:hover { background: #27ae60; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4); }
    .btn-pular { background: #95a5a6; color: white; }
    .btn-pular:hover { background: #7f8c8d; }

    /* TABELA DE LOG */
    .log-container { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
    .log-filters { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
    .filter-group { display: flex; flex-direction: column; min-width: 200px; }
    .filter-group label { font-size: 0.9em; color: #666; font-weight: 600; margin-bottom: 5px; }
    .filter-group select, .filter-group input { padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; }

    .log-table { width: 100%; border-collapse: collapse; }
    .log-table th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #333; border-bottom: 2px solid #e0e0e0; position: sticky; top: 0; }
    .log-table td { padding: 15px; border-bottom: 1px solid #f0f0f0; }
    .log-table tr:hover { background: #f8f9fa; }

    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; display: inline-block; }
    .status-ok { background: #d4edda; color: #155724; }
    .status-divergencia { background: #fff3cd; color: #856404; }
    .status-critica { background: #f8d7da; color: #721c24; }
    .status-ajustado { background: #d1ecf1; color: #0c5460; }

    /* DASHBOARD */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .dashboard-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); }
    .dashboard-card h3 { font-size: 1.2em; color: #333; margin-bottom: 20px; }

    .lista-produtos { max-height: 400px; overflow-y: auto; }
    .produto-item { padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s; }
    .produto-item:hover { background: #e9ecef; transform: translateX(5px); }
    .produto-item.contado { opacity: 0.6; background: #d4edda; }

    /* RESPONSIVO */
    @media (max-width: 768px) {
      .sidebar { width: 80px; }
      .sidebar-logo-text, .menu-item-text, .menu-section-title { display: none; }
      .contagem-input-section { grid-template-columns: 1fr; }
    }

    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 1000; justify-content: center; align-items: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { cursor: pointer; font-size: 1.5em; color: #999; }
    .modal-close:hover { color: #333; }
  </style>
</head>
<body>
  <div class="layout-container">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">üì¶</div>
          <div class="sidebar-logo-text">
            <h2>Plantebem</h2>
            <p>Gest√£o de Estoque</p>
          </div>
        </div>
      </div>

      <div class="sidebar-menu">
        <div class="menu-section">
          <div class="menu-section-title">Principal</div>
          <div class="menu-item active" onclick="mudarPagina('dashboard')">
            <div class="menu-item-icon">üìä</div>
            <div class="menu-item-text">Dashboard</div>
          </div>
          <div class="menu-item" onclick="mudarPagina('mapa')">
            <div class="menu-item-icon">üó∫Ô∏è</div>
            <div class="menu-item-text">Mapa de Estoque</div>
          </div>
        </div>

        <div class="menu-section">
          <div class="menu-section-title">Contagem</div>
          <div class="menu-item" onclick="mudarPagina('contagem')">
            <div class="menu-item-icon">‚úÖ</div>
            <div class="menu-item-text">Realizar Contagem</div>
          </div>
          <div class="menu-item" onclick="mudarPagina('log')">
            <div class="menu-item-icon">üìã</div>
            <div class="menu-item-text">Log de Contagens</div>
          </div>
          <div class="menu-item" onclick="mudarPagina('divergencias')">
            <div class="menu-item-icon">‚ö†Ô∏è</div>
            <div class="menu-item-text">Diverg√™ncias</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTE√öDO PRINCIPAL -->
    <div class="main-content">
      <!-- HEADER -->
      <div class="top-header">
        <div class="top-header-left">
          <div class="page-title" id="pageTitle">Dashboard</div>
        </div>
        <div class="top-header-actions">
          <button class="btn-header btn-export" onclick="exportarLog()">
            <span>üì•</span> Exportar
          </button>
          <button class="btn-header btn-primary" onclick="iniciarContagem()">
            <span>‚úÖ</span> Nova Contagem
          </button>
        </div>
      </div>

      <!-- √ÅREA DE CONTE√öDO -->
      <div class="content-area">

        <!-- DASHBOARD -->
        <div id="page-dashboard" class="page-section active">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Total de Produtos</div>
                <div class="stat-card-icon">üì¶</div>
              </div>
              <div class="stat-card-value" id="stat-total">0</div>
              <div class="stat-card-footer">No sistema</div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Produtos Contados</div>
                <div class="stat-card-icon">‚úÖ</div>
              </div>
              <div class="stat-card-value" id="stat-contados">0</div>
              <div class="stat-card-footer">√öltima contagem</div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Diverg√™ncias</div>
                <div class="stat-card-icon">‚ö†Ô∏è</div>
              </div>
              <div class="stat-card-value" id="stat-divergencias">0</div>
              <div class="stat-card-footer">Requerem aten√ß√£o</div>
            </div>

            <div class="stat-card">
              <div class="stat-card-header">
                <div class="stat-card-title">Acuracidade</div>
                <div class="stat-card-icon">üéØ</div>
              </div>
              <div class="stat-card-value" id="stat-acuracia">100%</div>
              <div class="stat-card-footer">Precis√£o do estoque</div>
            </div>
          </div>

          <div class="dashboard-grid">
            <div class="dashboard-card">
              <h3>Produtos Pendentes de Contagem</h3>
              <div class="lista-produtos" id="lista-pendentes"></div>
            </div>

            <div class="dashboard-card">
              <h3>√öltimas Diverg√™ncias</h3>
              <div class="lista-produtos" id="lista-divergencias-recentes"></div>
            </div>
          </div>
        </div>

        <!-- CONTAGEM -->
        <div id="page-contagem" class="page-section">
          <div class="contagem-container" id="contagem-container">
            <div class="contagem-header">
              <h2>Selecione um produto para contar</h2>
              <div>
                <span id="progresso-contagem">0 de 0</span>
              </div>
            </div>
            <div id="area-contagem"></div>
          </div>
        </div>

        <!-- LOG DE CONTAGENS -->
        <div id="page-log" class="page-section">
          <div class="log-container">
            <h2 style="margin-bottom: 20px;">Hist√≥rico de Contagens</h2>

            <div class="log-filters">
              <div class="filter-group">
                <label>Filtrar por Status</label>
                <select id="filtro-status" onchange="filtrarLog()">
                  <option value="">Todos</option>
                  <option value="ok">OK</option>
                  <option value="divergencia">Diverg√™ncia</option>
                  <option value="critica">Cr√≠tica</option>
                  <option value="ajustado">Ajustado</option>
                </select>
              </div>

              <div class="filter-group">
                <label>Buscar Produto</label>
                <input type="text" id="filtro-produto" placeholder="Digite o nome do produto" oninput="filtrarLog()">
              </div>

              <div class="filter-group">
                <label>Data Inicial</label>
                <input type="date" id="filtro-data-inicio" onchange="filtrarLog()">
              </div>

              <div class="filter-group">
                <label>Data Final</label>
                <input type="date" id="filtro-data-fim" onchange="filtrarLog()">
              </div>
            </div>

            <div style="overflow-x: auto;">
              <table class="log-table">
                <thead>
                  <tr>
                    <th>Data/Hora</th>
                    <th>Produto</th>
                    <th>Lote</th>
                    <th>Localiza√ß√£o</th>
                    <th>Qtd Sistema</th>
                    <th>Qtd Contada</th>
                    <th>Diverg√™ncia</th>
                    <th>Status</th>
                    <th>A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="log-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- DIVERG√äNCIAS -->
        <div id="page-divergencias" class="page-section">
          <div class="log-container">
            <h2 style="margin-bottom: 20px;">Produtos com Diverg√™ncias</h2>
            <div id="lista-divergencias"></div>
          </div>
        </div>

        <!-- MAPA (Placeholder) -->
        <div id="page-mapa" class="page-section">
          <div class="contagem-container">
            <h2>Mapa de Estoque</h2>
            <p style="color: #666; margin-top: 15px;">Cole aqui a visualiza√ß√£o do mapa do seu sistema original</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MODAL DE DETALHES -->
  <div id="modal-detalhes" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Detalhes da Contagem</h2>
        <span class="modal-close" onclick="fecharModal()">‚úñ</span>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    // ========== DADOS DE EXEMPLO ==========
    let estoque = [
      { id: 1, produto: "Herbicida GLIFOSATO 480", lote: "L2024001", validade: "2025-12-31", quantidade: 100, rua: "R1", posicao: "P1", nivel: "N1" },
      { id: 2, produto: "Inseticida LAMBDA 50", lote: "L2024002", validade: "2026-03-15", quantidade: 75, rua: "R1", posicao: "P2", nivel: "N1" },
      { id: 3, produto: "Fungicida AZOXISTROBINA", lote: "L2024003", validade: "2025-08-20", quantidade: 50, rua: "R1", posicao: "P3", nivel: "N2" },
      { id: 4, produto: "Adubo NPK 20-05-20", lote: "L2024004", validade: "2026-01-10", quantidade: 200, rua: "R2", posicao: "P1", nivel: "N1" },
      { id: 5, produto: "Herbicida 2,4-D", lote: "L2024005", validade: "2025-11-30", quantidade: 120, rua: "R2", posicao: "P2", nivel: "N1" },
    ];

    let logContagens = JSON.parse(localStorage.getItem('logContagens') || '[]');
    let contagemAtual = { index: 0, itens: [] };

    // ========== FUN√á√ïES DE NAVEGA√á√ÉO ==========
    function mudarPagina(pagina) {
      // Remover active de todas as p√°ginas e menu items
      document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));

      // Ativar p√°gina e menu item
      document.getElementById('page-' + pagina).classList.add('active');
      event.target.closest('.menu-item').classList.add('active');

      // Atualizar t√≠tulo
      const titulos = {
        'dashboard': 'Dashboard',
        'contagem': 'Realizar Contagem',
        'log': 'Log de Contagens',
        'divergencias': 'Diverg√™ncias',
        'mapa': 'Mapa de Estoque'
      };
      document.getElementById('pageTitle').textContent = titulos[pagina];

      // Carregar conte√∫do espec√≠fico
      if (pagina === 'dashboard') carregarDashboard();
      if (pagina === 'log') carregarLog();
      if (pagina === 'divergencias') carregarDivergencias();
    }

    // ========== DASHBOARD ==========
    function carregarDashboard() {
      const totalProdutos = estoque.length;
      const produtosContados = logContagens.filter(l => {
        const hoje = new Date().toDateString();
        return new Date(l.data).toDateString() === hoje;
      }).length;

      const divergencias = logContagens.filter(l => l.status !== 'ok').length;
      const acuracia = totalProdutos > 0 ? (((totalProdutos - divergencias) / totalProdutos) * 100).toFixed(1) : 100;

      document.getElementById('stat-total').textContent = totalProdutos;
      document.getElementById('stat-contados').textContent = produtosContados;
      document.getElementById('stat-divergencias').textContent = divergencias;
      document.getElementById('stat-acuracia').textContent = acuracia + '%';

      // Produtos pendentes
      const listaPendentes = document.getElementById('lista-pendentes');
      const produtosContadosIds = logContagens.map(l => l.produtoId);
      const pendentes = estoque.filter(p => !produtosContadosIds.includes(p.id));

      if (pendentes.length === 0) {
        listaPendentes.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Todos os produtos foram contados!</p>';
      } else {
        listaPendentes.innerHTML = pendentes.slice(0, 5).map(p => `
          <div class="produto-item" onclick="iniciarContagemProduto(${p.id})">
            <div>
              <div style="font-weight: 600;">${p.produto}</div>
              <div style="font-size: 0.9em; color: #666;">Lote: ${p.lote} | ${p.rua}-${p.posicao}-${p.nivel}</div>
            </div>
            <div style="color: #667eea;">‚Üí</div>
          </div>
        `).join('');
      }

      // Diverg√™ncias recentes
      const listaDivergencias = document.getElementById('lista-divergencias-recentes');
      const divergenciasRecentes = logContagens.filter(l => l.status !== 'ok').slice(-5);

      if (divergenciasRecentes.length === 0) {
        listaDivergencias.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhuma diverg√™ncia encontrada</p>';
      } else {
        listaDivergencias.innerHTML = divergenciasRecentes.map(l => `
          <div class="produto-item">
            <div>
              <div style="font-weight: 600;">${l.produto}</div>
              <div style="font-size: 0.9em; color: #666;">Diverg√™ncia: ${l.divergenciaPercentual > 0 ? '+' : ''}${l.divergenciaPercentual.toFixed(1)}%</div>
            </div>
            <span class="status-badge status-${l.status}">${l.status.toUpperCase()}</span>
          </div>
        `).join('');
      }
    }

    // ========== CONTAGEM ==========
    function iniciarContagem() {
      contagemAtual.itens = [...estoque];
      contagemAtual.index = 0;
      mudarPagina('contagem');
      mostrarProdutoParaContar();
    }

    function iniciarContagemProduto(id) {
      const produto = estoque.find(p => p.id === id);
      if (!produto) return;

      contagemAtual.itens = [produto];
      contagemAtual.index = 0;
      mudarPagina('contagem');
      mostrarProdutoParaContar();
    }

    function mostrarProdutoParaContar() {
      const area = document.getElementById('area-contagem');
      const progresso = document.getElementById('progresso-contagem');

      if (contagemAtual.index >= contagemAtual.itens.length) {
        area.innerHTML = '<div style="text-align: center; padding: 50px;"><h2>‚úÖ Contagem finalizada!</h2><p style="margin-top: 15px; color: #666;">Todos os produtos foram contados.</p></div>';
        progresso.textContent = `${contagemAtual.index} de ${contagemAtual.itens.length}`;
        return;
      }

      const produto = contagemAtual.itens[contagemAtual.index];
      progresso.textContent = `${contagemAtual.index + 1} de ${contagemAtual.itens.length}`;

      area.innerHTML = `
        <div class="produto-contagem">
          <div class="produto-info">
            <div class="info-item">
              <div class="info-label">Produto</div>
              <div class="info-value">${produto.produto}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Lote</div>
              <div class="info-value">${produto.lote}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Localiza√ß√£o</div>
              <div class="info-value">${produto.rua}-${produto.posicao}-${produto.nivel}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Quantidade no Sistema</div>
              <div class="info-value">${produto.quantidade} unidades</div>
            </div>
            <div class="info-item">
              <div class="info-label">Validade</div>
              <div class="info-value">${formatarData(produto.validade)}</div>
            </div>
          </div>

          <div class="contagem-input-section">
            <div class="input-group">
              <label>Quantidade Contada *</label>
              <input type="number" id="qtd-contada" min="0" placeholder="Digite a quantidade" oninput="calcularDivergencia()">
            </div>

            <div class="input-group">
              <label>Respons√°vel</label>
              <input type="text" id="responsavel" placeholder="Nome do respons√°vel">
            </div>

            <div class="input-group">
              <label>Observa√ß√µes</label>
              <textarea id="observacoes" placeholder="Adicione observa√ß√µes se necess√°rio"></textarea>
            </div>
          </div>

          <div id="divergencia-resultado"></div>

          <div style="display: flex; gap: 15px; margin-top: 25px; justify-content: center;">
            <button class="btn-contagem btn-confirmar" onclick="confirmarContagem()">‚úÖ Confirmar Contagem</button>
            <button class="btn-contagem btn-pular" onclick="pularProduto()">‚è≠Ô∏è Pular Produto</button>
          </div>
        </div>
      `;
    }

    function calcularDivergencia() {
      const qtdContada = parseFloat(document.getElementById('qtd-contada').value) || 0;
      const produto = contagemAtual.itens[contagemAtual.index];
      const qtdSistema = produto.quantidade;

      const divergencia = qtdContada - qtdSistema;
      const divergenciaPercentual = qtdSistema > 0 ? (divergencia / qtdSistema) * 100 : 0;

      const resultado = document.getElementById('divergencia-resultado');

      if (qtdContada === 0) {
        resultado.innerHTML = '';
        return;
      }

      let classe = 'divergencia-ok';
      let status = 'OK';
      let icone = '‚úÖ';

      if (Math.abs(divergenciaPercentual) > 5) {
        classe = 'divergencia-critica';
        status = 'DIVERG√äNCIA CR√çTICA';
        icone = 'üö®';
      } else if (Math.abs(divergenciaPercentual) > 0) {
        classe = 'divergencia-atencao';
        status = 'ATEN√á√ÉO';
        icone = '‚ö†Ô∏è';
      }

      resultado.innerHTML = `
        <div class="divergencia-display ${classe}">
          <div>${icone} ${status}</div>
          <div style="margin-top: 10px; font-size: 0.9em;">
            Diverg√™ncia: ${divergencia > 0 ? '+' : ''}${divergencia} unidades 
            (${divergenciaPercentual > 0 ? '+' : ''}${divergenciaPercentual.toFixed(2)}%)
          </div>
        </div>
      `;
    }

    function confirmarContagem() {
      const qtdContada = parseFloat(document.getElementById('qtd-contada').value);
      const responsavel = document.getElementById('responsavel').value || 'N√£o informado';
      const observacoes = document.getElementById('observacoes').value;
      const produto = contagemAtual.itens[contagemAtual.index];

      if (isNaN(qtdContada)) {
        alert('Por favor, informe a quantidade contada.');
        return;
      }

      const divergencia = qtdContada - produto.quantidade;
      const divergenciaPercentual = produto.quantidade > 0 ? (divergencia / produto.quantidade) * 100 : 0;

      let status = 'ok';
      if (Math.abs(divergenciaPercentual) > 5) status = 'critica';
      else if (Math.abs(divergenciaPercentual) > 0) status = 'divergencia';

      const registro = {
        id: Date.now(),
        data: new Date().toISOString(),
        produtoId: produto.id,
        produto: produto.produto,
        lote: produto.lote,
        localizacao: `${produto.rua}-${produto.posicao}-${produto.nivel}`,
        qtdSistema: produto.quantidade,
        qtdContada: qtdContada,
        divergencia: divergencia,
        divergenciaPercentual: divergenciaPercentual,
        status: status,
        responsavel: responsavel,
        observacoes: observacoes
      };

      logContagens.push(registro);
      localStorage.setItem('logContagens', JSON.stringify(logContagens));

      contagemAtual.index++;
      mostrarProdutoParaContar();
    }

    function pularProduto() {
      contagemAtual.index++;
      mostrarProdutoParaContar();
    }

    // ========== LOG ==========
    function carregarLog() {
      const tbody = document.getElementById('log-tbody');
      const registros = [...logContagens].reverse();

      if (registros.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; color: #999;">Nenhuma contagem registrada ainda</td></tr>';
        return;
      }

      tbody.innerHTML = registros.map(r => `
        <tr>
          <td>${formatarDataHora(r.data)}</td>
          <td>${r.produto}</td>
          <td>${r.lote}</td>
          <td>${r.localizacao}</td>
          <td>${r.qtdSistema}</td>
          <td>${r.qtdContada}</td>
          <td style="color: ${r.divergencia > 0 ? '#e74c3c' : r.divergencia < 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">
            ${r.divergencia > 0 ? '+' : ''}${r.divergencia} (${r.divergenciaPercentual > 0 ? '+' : ''}${r.divergenciaPercentual.toFixed(1)}%)
          </td>
          <td><span class="status-badge status-${r.status}">${r.status.toUpperCase()}</span></td>
          <td>
            <button class="btn-header btn-primary" style="padding: 5px 10px; font-size: 0.85em;" onclick="verDetalhes(${r.id})">Ver</button>
            ${r.status !== 'ajustado' && r.status !== 'ok' ? 
              `<button class="btn-header btn-success" style="padding: 5px 10px; font-size: 0.85em; margin-left: 5px;" onclick="ajustarEstoque(${r.id})">Ajustar</button>` 
              : ''}
          </td>
        </tr>
      `).join('');
    }

    function filtrarLog() {
      const status = document.getElementById('filtro-status').value;
      const produto = document.getElementById('filtro-produto').value.toLowerCase();
      const dataInicio = document.getElementById('filtro-data-inicio').value;
      const dataFim = document.getElementById('filtro-data-fim').value;

      let registrosFiltrados = [...logContagens];

      if (status) registrosFiltrados = registrosFiltrados.filter(r => r.status === status);
      if (produto) registrosFiltrados = registrosFiltrados.filter(r => r.produto.toLowerCase().includes(produto));
      if (dataInicio) registrosFiltrados = registrosFiltrados.filter(r => new Date(r.data) >= new Date(dataInicio));
      if (dataFim) registrosFiltrados = registrosFiltrados.filter(r => new Date(r.data) <= new Date(dataFim));

      const tbody = document.getElementById('log-tbody');
      tbody.innerHTML = registrosFiltrados.reverse().map(r => `
        <tr>
          <td>${formatarDataHora(r.data)}</td>
          <td>${r.produto}</td>
          <td>${r.lote}</td>
          <td>${r.localizacao}</td>
          <td>${r.qtdSistema}</td>
          <td>${r.qtdContada}</td>
          <td style="color: ${r.divergencia > 0 ? '#e74c3c' : r.divergencia < 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">
            ${r.divergencia > 0 ? '+' : ''}${r.divergencia} (${r.divergenciaPercentual > 0 ? '+' : ''}${r.divergenciaPercentual.toFixed(1)}%)
          </td>
          <td><span class="status-badge status-${r.status}">${r.status.toUpperCase()}</span></td>
          <td>
            <button class="btn-header btn-primary" style="padding: 5px 10px; font-size: 0.85em;" onclick="verDetalhes(${r.id})">Ver</button>
            ${r.status !== 'ajustado' && r.status !== 'ok' ? 
              `<button class="btn-header btn-success" style="padding: 5px 10px; font-size: 0.85em; margin-left: 5px;" onclick="ajustarEstoque(${r.id})">Ajustar</button>` 
              : ''}
          </td>
        </tr>
      `).join('');
    }

    // ========== DIVERG√äNCIAS ==========
    function carregarDivergencias() {
      const container = document.getElementById('lista-divergencias');
      const divergencias = logContagens.filter(l => l.status !== 'ok' && l.status !== 'ajustado');

      if (divergencias.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 50px; color: #999;">Nenhuma diverg√™ncia pendente!</p>';
        return;
      }

      container.innerHTML = divergencias.map(d => `
        <div class="produto-contagem" style="margin-bottom: 20px;">
          <div class="produto-info">
            <div class="info-item">
              <div class="info-label">Produto</div>
              <div class="info-value">${d.produto}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Lote</div>
              <div class="info-value">${d.lote}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Localiza√ß√£o</div>
              <div class="info-value">${d.localizacao}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Qtd Sistema</div>
              <div class="info-value">${d.qtdSistema}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Qtd Contada</div>
              <div class="info-value">${d.qtdContada}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Diverg√™ncia</div>
              <div class="info-value" style="color: ${d.divergencia > 0 ? '#e74c3c' : '#f39c12'};">
                ${d.divergencia > 0 ? '+' : ''}${d.divergencia} (${d.divergenciaPercentual > 0 ? '+' : ''}${d.divergenciaPercentual.toFixed(1)}%)
              </div>
            </div>
          </div>
          <div style="margin-top: 15px;">
            <strong>Observa√ß√µes:</strong> ${d.observacoes || 'Nenhuma observa√ß√£o'}
          </div>
          <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-contagem btn-confirmar" onclick="ajustarEstoque(${d.id})">Ajustar Estoque</button>
            <button class="btn-contagem btn-primary" onclick="verDetalhes(${d.id})">Ver Detalhes</button>
          </div>
        </div>
      `).join('');
    }

    // ========== A√á√ïES ==========
    function ajustarEstoque(registroId) {
      const registro = logContagens.find(r => r.id === registroId);
      if (!registro) return;

      if (confirm(`Deseja ajustar o estoque de "${registro.produto}" de ${registro.qtdSistema} para ${registro.qtdContada} unidades?`)) {
        const produto = estoque.find(p => p.id === registro.produtoId);
        if (produto) {
          produto.quantidade = registro.qtdContada;
        }

        registro.status = 'ajustado';
        localStorage.setItem('logContagens', JSON.stringify(logContagens));

        alert('Estoque ajustado com sucesso!');
        carregarLog();
        carregarDivergencias();
        carregarDashboard();
      }
    }

    function verDetalhes(registroId) {
      const registro = logContagens.find(r => r.id === registroId);
      if (!registro) return;

      const modal = document.getElementById('modal-detalhes');
      const body = document.getElementById('modal-body');

      body.innerHTML = `
        <div style="line-height: 1.8;">
          <p><strong>Produto:</strong> ${registro.produto}</p>
          <p><strong>Lote:</strong> ${registro.lote}</p>
          <p><strong>Localiza√ß√£o:</strong> ${registro.localizacao}</p>
          <p><strong>Data/Hora:</strong> ${formatarDataHora(registro.data)}</p>
          <p><strong>Respons√°vel:</strong> ${registro.responsavel}</p>
          <hr style="margin: 15px 0; border: none; border-top: 1px solid #e0e0e0;">
          <p><strong>Quantidade no Sistema:</strong> ${registro.qtdSistema} unidades</p>
          <p><strong>Quantidade Contada:</strong> ${registro.qtdContada} unidades</p>
          <p><strong>Diverg√™ncia:</strong> <span style="color: ${registro.divergencia > 0 ? '#e74c3c' : registro.divergencia < 0 ? '#f39c12' : '#27ae60'}; font-weight: 600;">
            ${registro.divergencia > 0 ? '+' : ''}${registro.divergencia} unidades (${registro.divergenciaPercentual > 0 ? '+' : ''}${registro.divergenciaPercentual.toFixed(2)}%)
          </span></p>
          <p><strong>Status:</strong> <span class="status-badge status-${registro.status}">${registro.status.toUpperCase()}</span></p>
          ${registro.observacoes ? `<p><strong>Observa√ß√µes:</strong> ${registro.observacoes}</p>` : ''}
        </div>
      `;

      modal.classList.add('active');
    }

    function fecharModal() {
      document.getElementById('modal-detalhes').classList.remove('active');
    }

    function exportarLog() {
      if (logContagens.length === 0) {
        alert('N√£o h√° dados para exportar');
        return;
      }

      const csv = [
        ['Data/Hora', 'Produto', 'Lote', 'Localiza√ß√£o', 'Qtd Sistema', 'Qtd Contada', 'Diverg√™ncia', 'Diverg√™ncia %', 'Status', 'Respons√°vel', 'Observa√ß√µes'],
        ...logContagens.map(r => [
          formatarDataHora(r.data),
          r.produto,
          r.lote,
          r.localizacao,
          r.qtdSistema,
          r.qtdContada,
          r.divergencia,
          r.divergenciaPercentual.toFixed(2),
          r.status,
          r.responsavel,
          r.observacoes || ''
        ])
      ].map(row => row.join(';')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `log-contagem-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    // ========== UTILIT√ÅRIOS ==========
    function formatarData(dataStr) {
      const data = new Date(dataStr);
      return data.toLocaleDateString('pt-BR');
    }

    function formatarDataHora(dataStr) {
      const data = new Date(dataStr);
      return data.toLocaleString('pt-BR');
    }

    // ========== INICIALIZA√á√ÉO ==========
    document.addEventListener('DOMContentLoaded', () => {
      carregarDashboard();
    });

    // Fechar modal ao clicar fora
    document.getElementById('modal-detalhes').addEventListener('click', (e) => {
      if (e.target.id === 'modal-detalhes') fecharModal();
    });
  </script>
</body>
</html>